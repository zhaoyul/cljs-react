shadow$provide.module$node_modules$$firebase$database$dist$index_cjs=function(global,require,module,exports){function each(obj,fn){for(var key in obj)obj.hasOwnProperty(key)&&fn(key,obj[key])}function NAME_ONLY_COMPARATOR(left,right){return nameCompare(left.name,right.name)}function NAME_COMPARATOR(left,right){return nameCompare(left,right)}function nodeFromJSON$1(json,priority){void 0===priority&&(priority=null);if(null===json)return ChildrenNode.EMPTY_NODE;"object"===typeof json&&".priority"in json&&
(priority=json[".priority"]);util.assert(null===priority||"string"===typeof priority||"number"===typeof priority||"object"===typeof priority&&".sv"in priority,"Invalid priority type found: "+typeof priority);"object"===typeof json&&".value"in json&&null!==json[".value"]&&(json=json[".value"]);if("object"!==typeof json||".sv"in json)return new LeafNode(json,nodeFromJSON$1(priority));if(json instanceof Array){var node_1=ChildrenNode.EMPTY_NODE;each(json,function(key,childData){util.contains(json,key)&&
"."!==key.substring(0,1)&&(childData=nodeFromJSON$1(childData),childData.isLeafNode()||!childData.isEmpty())&&(node_1=node_1.updateImmediateChild(key,childData))});return node_1.updatePriority(nodeFromJSON$1(priority))}var children_1=[],childrenHavePriority_1=!1;each(json,function(key,child){"."!==key.substring(0,1)&&(child=nodeFromJSON$1(child),child.isEmpty()||(childrenHavePriority_1=childrenHavePriority_1||!child.getPriority().isEmpty(),children_1.push(new NamedNode(key,child))))});if(0===children_1.length)return ChildrenNode.EMPTY_NODE;
var childSet=buildChildSet(children_1,NAME_ONLY_COMPARATOR,function(namedNode){return namedNode.name},NAME_COMPARATOR);if(childrenHavePriority_1){var sortedChildSet=buildChildSet(children_1,PRIORITY_INDEX.getCompare());return new ChildrenNode(childSet,nodeFromJSON$1(priority),new IndexMap({".priority":sortedChildSet},{".priority":PRIORITY_INDEX}))}return new ChildrenNode(childSet,nodeFromJSON$1(priority),IndexMap.Default)}function resolveDeferredValue(node,existingVal,serverValues){var rawPri=node.getPriority().val();
rawPri=resolveDeferredLeafValue(rawPri,existingVal.getImmediateChild(".priority"),serverValues);if(node.isLeafNode()){var value=resolveDeferredLeafValue(node.getValue(),existingVal,serverValues);return value!==node.getValue()||rawPri!==node.getPriority().val()?new LeafNode(value,nodeFromJSON$1(rawPri)):node}var newNode=node;rawPri!==node.getPriority().val()&&(newNode=newNode.updatePriority(new LeafNode(rawPri)));node.forEachChild(PRIORITY_INDEX,function(childName,childNode){var newChildNode=resolveDeferredValue(childNode,
existingVal.getImmediateChild(childName),serverValues);newChildNode!==childNode&&(newNode=newNode.updateImmediateChild(childName,newChildNode))});return newNode}function applySubtreeWrite(relativePath,writeTree,node){if(null!=writeTree.value)return node.updateChild(relativePath,writeTree.value);var priorityWrite_1=null;writeTree.children.inorderTraversal(function(childKey,childTree){".priority"===childKey?(util.assert(null!==childTree.value,"Priority writes must always be leaf nodes"),priorityWrite_1=
childTree.value):node=applySubtreeWrite(relativePath.child(childKey),childTree,node)});node.getChild(relativePath).isEmpty()||null===priorityWrite_1||(node=node.updateChild(relativePath.child(".priority"),priorityWrite_1));return node}function registerDatabase(instance){SDK_VERSION=instance.SDK_VERSION;var namespace=instance.INTERNAL.registerComponent((new component.Component("database",function(container,url){var app=container.getProvider("app").getImmediate();container=container.getProvider("auth-internal");
return RepoManager.getInstance().databaseFromApp(app,container,url)},"PUBLIC")).setServiceProps({Reference:Reference,Query:Query,Database:Database$jscomp$0,DataSnapshot:DataSnapshot,enableLogging:enableLogging,INTERNAL:INTERNAL,ServerValue:ServerValue,TEST_ACCESS:TEST_ACCESS}).setMultipleInstances(!0));instance.registerVersion("@firebase/database","0.6.11");util.isNodeSdk()&&(module.exports=namespace)}var process=require("module$node_modules$process$browser");"use strict";Object.defineProperty(exports,
"__esModule",{value:!0});var firebase=function(ex){return ex&&"object"===typeof ex&&"default"in ex?ex["default"]:ex}(require("module$node_modules$$firebase$app$dist$index_cjs")),tslib=require("module$node_modules$tslib$tslib"),util=require("module$node_modules$$firebase$util$dist$index_cjs"),logger$1=require("module$node_modules$$firebase$logger$dist$index_cjs"),component=require("module$node_modules$$firebase$component$dist$index_cjs"),DOMStorageWrapper=function(){function DOMStorageWrapper(domStorage_){this.domStorage_=
domStorage_;this.prefix_="firebase:"}DOMStorageWrapper.prototype.set=function(key,value){null==value?this.domStorage_.removeItem(this.prefixedName_(key)):this.domStorage_.setItem(this.prefixedName_(key),util.stringify(value))};DOMStorageWrapper.prototype.get=function(key){key=this.domStorage_.getItem(this.prefixedName_(key));return null==key?null:util.jsonEval(key)};DOMStorageWrapper.prototype.remove=function(key){this.domStorage_.removeItem(this.prefixedName_(key))};DOMStorageWrapper.prototype.prefixedName_=
function(name){return this.prefix_+name};DOMStorageWrapper.prototype.toString=function(){return this.domStorage_.toString()};return DOMStorageWrapper}(),MemoryStorage=function(){function MemoryStorage(){this.cache_={};this.isInMemoryStorage=!0}MemoryStorage.prototype.set=function(key,value){null==value?delete this.cache_[key]:this.cache_[key]=value};MemoryStorage.prototype.get=function(key){return util.contains(this.cache_,key)?this.cache_[key]:null};MemoryStorage.prototype.remove=function(key){delete this.cache_[key]};
return MemoryStorage}(),createStoragefor=function(domStorageName){try{if("undefined"!==typeof window&&"undefined"!==typeof window[domStorageName]){var domStorage=window[domStorageName];domStorage.setItem("firebase:sentinel","cache");domStorage.removeItem("firebase:sentinel");return new DOMStorageWrapper(domStorage)}}catch(e){}return new MemoryStorage},PersistentStorage=createStoragefor("localStorage"),SessionStorage=createStoragefor("sessionStorage"),logClient=new logger$1.Logger("@firebase/database"),
LUIDGenerator=function(){var id=1;return function(){return id++}}(),sha1=function(str){str=util.stringToByteArray(str);var sha1=new util.Sha1;sha1.update(str);str=sha1.digest();return util.base64.encodeByteArray(str)},buildLogMessage_=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];_i="";for(var i=0;i<varArgs.length;i++){var arg=varArgs[i];_i=Array.isArray(arg)||arg&&"object"===typeof arg&&"number"===typeof arg.length?_i+buildLogMessage_.apply(null,arg):"object"===
typeof arg?_i+util.stringify(arg):_i+arg;_i+=" "}return _i},logger=null,firstLog_=!0,enableLogging=function(logger_,persistent){util.assert(!persistent||!0===logger_||!1===logger_,"Can't turn on custom loggers persistently.");!0===logger_?(logClient.logLevel=logger$1.LogLevel.VERBOSE,logger=logClient.log.bind(logClient),persistent&&SessionStorage.set("logging_enabled",!0)):"function"===typeof logger_?logger=logger_:(logger=null,SessionStorage.remove("logging_enabled"))},log=function(){for(var varArgs=
[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];!0===firstLog_&&(firstLog_=!1,null===logger&&!0===SessionStorage.get("logging_enabled")&&enableLogging(!0));logger&&(varArgs=buildLogMessage_.apply(null,varArgs),logger(varArgs))},logWrapper=function(prefix){return function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];log.apply(void 0,tslib.__spread([prefix],varArgs))}},error$jscomp$0=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];
varArgs="FIREBASE INTERNAL ERROR: "+buildLogMessage_.apply(void 0,tslib.__spread(varArgs));logClient.error(varArgs)},fatal=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];varArgs="FIREBASE FATAL ERROR: "+buildLogMessage_.apply(void 0,tslib.__spread(varArgs));logClient.error(varArgs);throw Error(varArgs);},warn=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];varArgs="FIREBASE WARNING: "+buildLogMessage_.apply(void 0,tslib.__spread(varArgs));
logClient.warn(varArgs)},isInvalidJSONNumber=function(data){return"number"===typeof data&&(data!==data||data===Number.POSITIVE_INFINITY||data===Number.NEGATIVE_INFINITY)},executeWhenDOMReady=function(fn){if(util.isNodeSdk()||"complete"===document.readyState)fn();else{var called_1=!1,wrappedFn_1=function(){document.body?called_1||(called_1=!0,fn()):setTimeout(wrappedFn_1,10)};document.addEventListener?(document.addEventListener("DOMContentLoaded",wrappedFn_1,!1),window.addEventListener("load",wrappedFn_1,
!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&wrappedFn_1()}),window.attachEvent("onload",wrappedFn_1))}},nameCompare=function(a,b){if(a===b)return 0;if("[MIN_NAME]"===a||"[MAX_NAME]"===b)return-1;if("[MIN_NAME]"===b||"[MAX_NAME]"===a)return 1;var aAsInt=tryParseInt(a),bAsInt=tryParseInt(b);return null!==aAsInt?null!==bAsInt?0===aAsInt-bAsInt?a.length-b.length:aAsInt-bAsInt:-1:null!==bAsInt?1:a<b?-1:1},stringCompare=function(a,b){return a===
b?0:a<b?-1:1},requireKey=function(key,obj){if(obj&&key in obj)return obj[key];throw Error("Missing required key ("+key+") in object: "+util.stringify(obj));},ObjectToUniqueKey=function(obj){if("object"!==typeof obj||null===obj)return util.stringify(obj);var keys=[];for(k in obj)keys.push(k);keys.sort();var k="{";for(var i=0;i<keys.length;i++)0!==i&&(k+=","),k+=util.stringify(keys[i]),k+=":",k+=ObjectToUniqueKey(obj[keys[i]]);return k+"}"},splitStringBySize=function(str,segsize){var len=str.length;
if(len<=segsize)return[str];for(var dataSegs=[],c=0;c<len;c+=segsize)c+segsize>len?dataSegs.push(str.substring(c,len)):dataSegs.push(str.substring(c,c+segsize));return dataSegs},doubleToIEEE754String=function(v){util.assert(!isInvalidJSONNumber(v),"Invalid JSON number");var e;if(0===v){var f=e=0;var s=-Infinity===1/v?1:0}else s=0>v,v=Math.abs(v),v>=Math.pow(2,-1022)?(f=Math.min(Math.floor(Math.log(v)/Math.LN2),1023),e=f+1023,f=Math.round(v*Math.pow(2,52-f)-Math.pow(2,52))):(e=0,f=Math.round(v/Math.pow(2,
-1074)));var bits=[];for(v=52;v;--v)bits.push(f%2?1:0),f=Math.floor(f/2);for(v=11;v;--v)bits.push(e%2?1:0),e=Math.floor(e/2);bits.push(s?1:0);bits.reverse();s=bits.join("");e="";for(v=0;64>v;v+=8)f=parseInt(s.substr(v,8),2).toString(16),1===f.length&&(f="0"+f),e+=f;return e.toLowerCase()},INTEGER_REGEXP_=/^-?(0*)\d{1,10}$/,tryParseInt=function(str){return INTEGER_REGEXP_.test(str)&&(str=Number(str),-2147483648<=str&&2147483647>=str)?str:null},exceptionGuard=function(fn){try{fn()}catch(e){setTimeout(function(){warn("Exception was thrown by user callback.",
e.stack||"");throw e;},0)}},setTimeoutNonBlocking=function(fn,time){fn=setTimeout(fn,time);"object"===typeof fn&&fn.unref&&fn.unref();return fn},Path=function(){function Path(pathOrString,pieceNum){if(void 0===pieceNum){this.pieces_=pathOrString.split("/");for(pieceNum=pathOrString=0;pieceNum<this.pieces_.length;pieceNum++)0<this.pieces_[pieceNum].length&&(this.pieces_[pathOrString]=this.pieces_[pieceNum],pathOrString++);this.pieces_.length=pathOrString;this.pieceNum_=0}else this.pieces_=pathOrString,
this.pieceNum_=pieceNum}Object.defineProperty(Path,"Empty",{get:function(){return new Path("")},enumerable:!1,configurable:!0});Path.prototype.getFront=function(){return this.pieceNum_>=this.pieces_.length?null:this.pieces_[this.pieceNum_]};Path.prototype.getLength=function(){return this.pieces_.length-this.pieceNum_};Path.prototype.popFront=function(){var pieceNum=this.pieceNum_;pieceNum<this.pieces_.length&&pieceNum++;return new Path(this.pieces_,pieceNum)};Path.prototype.getBack=function(){return this.pieceNum_<
this.pieces_.length?this.pieces_[this.pieces_.length-1]:null};Path.prototype.toString=function(){for(var pathString="",i=this.pieceNum_;i<this.pieces_.length;i++)""!==this.pieces_[i]&&(pathString+="/"+this.pieces_[i]);return pathString||"/"};Path.prototype.toUrlEncodedString=function(){for(var pathString="",i=this.pieceNum_;i<this.pieces_.length;i++)""!==this.pieces_[i]&&(pathString+="/"+encodeURIComponent(String(this.pieces_[i])));return pathString||"/"};Path.prototype.slice=function(begin){void 0===
begin&&(begin=0);return this.pieces_.slice(this.pieceNum_+begin)};Path.prototype.parent=function(){if(this.pieceNum_>=this.pieces_.length)return null;for(var pieces=[],i=this.pieceNum_;i<this.pieces_.length-1;i++)pieces.push(this.pieces_[i]);return new Path(pieces,0)};Path.prototype.child=function(childPathObj){for(var pieces=[],i=this.pieceNum_;i<this.pieces_.length;i++)pieces.push(this.pieces_[i]);if(childPathObj instanceof Path)for(i=childPathObj.pieceNum_;i<childPathObj.pieces_.length;i++)pieces.push(childPathObj.pieces_[i]);
else for(childPathObj=childPathObj.split("/"),i=0;i<childPathObj.length;i++)0<childPathObj[i].length&&pieces.push(childPathObj[i]);return new Path(pieces,0)};Path.prototype.isEmpty=function(){return this.pieceNum_>=this.pieces_.length};Path.relativePath=function(outerPath,innerPath){var outer=outerPath.getFront(),inner=innerPath.getFront();if(null===outer)return innerPath;if(outer===inner)return Path.relativePath(outerPath.popFront(),innerPath.popFront());throw Error("INTERNAL ERROR: innerPath ("+
innerPath+") is not within outerPath ("+outerPath+")");};Path.comparePaths=function(left,right){left=left.slice();right=right.slice();for(var i=0;i<left.length&&i<right.length;i++){var cmp=nameCompare(left[i],right[i]);if(0!==cmp)return cmp}return left.length===right.length?0:left.length<right.length?-1:1};Path.prototype.equals=function(other){if(this.getLength()!==other.getLength())return!1;for(var i=this.pieceNum_,j=other.pieceNum_;i<=this.pieces_.length;i++,j++)if(this.pieces_[i]!==other.pieces_[j])return!1;
return!0};Path.prototype.contains=function(other){var i=this.pieceNum_,j=other.pieceNum_;if(this.getLength()>other.getLength())return!1;for(;i<this.pieces_.length;){if(this.pieces_[i]!==other.pieces_[j])return!1;++i;++j}return!0};return Path}(),ValidationPath=function(){function ValidationPath(path,errorPrefix_){this.errorPrefix_=errorPrefix_;this.parts_=path.slice();this.byteLength_=Math.max(1,this.parts_.length);for(path=0;path<this.parts_.length;path++)this.byteLength_+=util.stringLength(this.parts_[path]);
this.checkValid_()}Object.defineProperty(ValidationPath,"MAX_PATH_DEPTH",{get:function(){return 32},enumerable:!1,configurable:!0});Object.defineProperty(ValidationPath,"MAX_PATH_LENGTH_BYTES",{get:function(){return 768},enumerable:!1,configurable:!0});ValidationPath.prototype.push=function(child){0<this.parts_.length&&(this.byteLength_+=1);this.parts_.push(child);this.byteLength_+=util.stringLength(child);this.checkValid_()};ValidationPath.prototype.pop=function(){var last=this.parts_.pop();this.byteLength_-=
util.stringLength(last);0<this.parts_.length&&--this.byteLength_};ValidationPath.prototype.checkValid_=function(){if(this.byteLength_>ValidationPath.MAX_PATH_LENGTH_BYTES)throw Error(this.errorPrefix_+"has a key path longer than "+ValidationPath.MAX_PATH_LENGTH_BYTES+" bytes ("+this.byteLength_+").");if(this.parts_.length>ValidationPath.MAX_PATH_DEPTH)throw Error(this.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+ValidationPath.MAX_PATH_DEPTH+") or object contains a cycle "+
this.toErrorString());};ValidationPath.prototype.toErrorString=function(){return 0===this.parts_.length?"":"in property '"+this.parts_.join(".")+"'"};return ValidationPath}(),RepoInfo=function(){function RepoInfo(host,secure,namespace,webSocketOnly,persistenceKey,includeNamespaceInQueryParams){void 0===persistenceKey&&(persistenceKey="");void 0===includeNamespaceInQueryParams&&(includeNamespaceInQueryParams=!1);this.secure=secure;this.namespace=namespace;this.webSocketOnly=webSocketOnly;this.persistenceKey=
persistenceKey;this.includeNamespaceInQueryParams=includeNamespaceInQueryParams;this.host=host.toLowerCase();this.domain=this.host.substr(this.host.indexOf(".")+1);this.internalHost=PersistentStorage.get("host:"+host)||this.host}RepoInfo.prototype.needsQueryParam=function(){return this.host!==this.internalHost||this.isCustomHost()||this.includeNamespaceInQueryParams};RepoInfo.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)};RepoInfo.prototype.isDemoHost=function(){return"firebaseio-demo.com"===
this.domain};RepoInfo.prototype.isCustomHost=function(){return"firebaseio.com"!==this.domain&&"firebaseio-demo.com"!==this.domain};RepoInfo.prototype.updateHost=function(newHost){newHost!==this.internalHost&&(this.internalHost=newHost,this.isCacheableHost()&&PersistentStorage.set("host:"+this.host,this.internalHost))};RepoInfo.prototype.connectionURL=function(type,params){util.assert("string"===typeof type,"typeof type must \x3d\x3d string");util.assert("object"===typeof params,"typeof params must \x3d\x3d object");
if("websocket"===type)type=(this.secure?"wss://":"ws://")+this.internalHost+"/.ws?";else if("long_polling"===type)type=(this.secure?"https://":"http://")+this.internalHost+"/.lp?";else throw Error("Unknown connection type: "+type);this.needsQueryParam()&&(params.ns=this.namespace);var pairs=[];each(params,function(key,value){pairs.push(key+"\x3d"+value)});return type+pairs.join("\x26")};RepoInfo.prototype.toString=function(){var str=this.toURLString();this.persistenceKey&&(str+="\x3c"+this.persistenceKey+
"\x3e");return str};RepoInfo.prototype.toURLString=function(){return(this.secure?"https://":"http://")+this.host};return RepoInfo}(),parseRepoInfo=function(dataURL){var JSCompiler_object_inline_host_1813,JSCompiler_object_inline_subdomain_1816,JSCompiler_object_inline_pathString_1819,dataURL$jscomp$0=dataURL,domain=JSCompiler_object_inline_host_1813="";dataURL=JSCompiler_object_inline_pathString_1819=JSCompiler_object_inline_subdomain_1816="";var JSCompiler_object_inline_secure_1817=!0;var JSCompiler_object_inline_scheme_1818=
"https";if("string"===typeof dataURL$jscomp$0){domain=dataURL$jscomp$0.indexOf("//");0<=domain&&(JSCompiler_object_inline_scheme_1818=dataURL$jscomp$0.substring(0,domain-1),dataURL$jscomp$0=dataURL$jscomp$0.substring(domain+2));var slashInd=dataURL$jscomp$0.indexOf("/");-1===slashInd&&(slashInd=dataURL$jscomp$0.length);domain=dataURL$jscomp$0.indexOf("?");-1===domain&&(domain=dataURL$jscomp$0.length);JSCompiler_object_inline_host_1813=dataURL$jscomp$0.substring(0,Math.min(slashInd,domain));if(slashInd<
domain){JSCompiler_object_inline_pathString_1819="";slashInd=dataURL$jscomp$0.substring(slashInd,domain).split("/");for(var i=0;i<slashInd.length;i++)if(0<slashInd[i].length){var piece=slashInd[i];try{piece=decodeURIComponent(piece.replace(/\+/g," "))}catch(e){}JSCompiler_object_inline_pathString_1819+="/"+piece}}domain=dataURL$jscomp$0.substring(Math.min(dataURL$jscomp$0.length,domain));var _a;dataURL$jscomp$0={};"?"===domain.charAt(0)&&(domain=domain.substring(1));try{for(var _b=tslib.__values(domain.split("\x26")),
_c=_b.next();!_c.done;_c=_b.next()){var segment=_c.value;if(0!==segment.length){var kv=segment.split("\x3d");2===kv.length?dataURL$jscomp$0[decodeURIComponent(kv[0])]=decodeURIComponent(kv[1]):warn("Invalid query segment '"+segment+"' in query '"+domain+"'")}}}catch(e_1_1){var JSCompiler_object_inline_domain_1815={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(JSCompiler_object_inline_domain_1815)throw JSCompiler_object_inline_domain_1815.error;}}domain=JSCompiler_object_inline_host_1813.indexOf(":");
0<=domain?(JSCompiler_object_inline_secure_1817="https"===JSCompiler_object_inline_scheme_1818||"wss"===JSCompiler_object_inline_scheme_1818,parseInt(JSCompiler_object_inline_host_1813.substring(domain+1),10)):domain=JSCompiler_object_inline_host_1813.length;JSCompiler_object_inline_domain_1815=JSCompiler_object_inline_host_1813.slice(0,domain);"localhost"===JSCompiler_object_inline_domain_1815.toLowerCase()?domain="localhost":2>=JSCompiler_object_inline_domain_1815.split(".").length?domain=JSCompiler_object_inline_domain_1815:
(dataURL=JSCompiler_object_inline_host_1813.indexOf("."),JSCompiler_object_inline_subdomain_1816=JSCompiler_object_inline_host_1813.substring(0,dataURL).toLowerCase(),domain=JSCompiler_object_inline_host_1813.substring(dataURL+1),dataURL=JSCompiler_object_inline_subdomain_1816);"ns"in dataURL$jscomp$0&&(dataURL=dataURL$jscomp$0.ns)}JSCompiler_object_inline_domain_1815=domain;"firebase.com"===JSCompiler_object_inline_domain_1815&&fatal(JSCompiler_object_inline_host_1813+" is no longer supported. Please use \x3cYOUR FIREBASE\x3e.firebaseio.com instead");
dataURL&&"undefined"!==dataURL||"localhost"===JSCompiler_object_inline_domain_1815||fatal("Cannot parse Firebase url. Please use https://\x3cYOUR FIREBASE\x3e.firebaseio.com");JSCompiler_object_inline_secure_1817||"undefined"!==typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&warn("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");return{repoInfo:new RepoInfo(JSCompiler_object_inline_host_1813,JSCompiler_object_inline_secure_1817,
dataURL,"ws"===JSCompiler_object_inline_scheme_1818||"wss"===JSCompiler_object_inline_scheme_1818,"",dataURL!==JSCompiler_object_inline_subdomain_1816),path:new Path(JSCompiler_object_inline_pathString_1819)}},INVALID_KEY_REGEX_=/[\[\].#$\/\u0000-\u001F\u007F]/,INVALID_PATH_REGEX_=/[\[\].#$\u0000-\u001F\u007F]/,isValidKey=function(key){return"string"===typeof key&&0!==key.length&&!INVALID_KEY_REGEX_.test(key)},isValidPathString=function(pathString){return"string"===typeof pathString&&0!==pathString.length&&
!INVALID_PATH_REGEX_.test(pathString)},isValidPriority=function(priority){return null===priority||"string"===typeof priority||"number"===typeof priority&&!isInvalidJSONNumber(priority)||priority&&"object"===typeof priority&&util.contains(priority,".sv")},validateFirebaseDataArg=function(fnName,argumentNumber,data,path,optional){optional&&void 0===data||validateFirebaseData(util.errorPrefix(fnName,argumentNumber,optional),data,path)},validateFirebaseData=function(errorPrefix,data,path_){var path=path_ instanceof
Path?new ValidationPath(path_,errorPrefix):path_;if(void 0===data)throw Error(errorPrefix+"contains undefined "+path.toErrorString());if("function"===typeof data)throw Error(errorPrefix+"contains a function "+path.toErrorString()+" with contents \x3d "+data.toString());if(isInvalidJSONNumber(data))throw Error(errorPrefix+"contains "+data.toString()+" "+path.toErrorString());if("string"===typeof data&&data.length>10485760/3&&10485760<util.stringLength(data))throw Error(errorPrefix+"contains a string greater than 10485760 utf8 bytes "+
path.toErrorString()+" ('"+data.substring(0,50)+"...')");if(data&&"object"===typeof data){var hasDotValue_1=!1,hasActualChild_1=!1;each(data,function(key,value){if(".value"===key)hasDotValue_1=!0;else if(".priority"!==key&&".sv"!==key&&(hasActualChild_1=!0,!isValidKey(key)))throw Error(errorPrefix+" contains an invalid key ("+key+") "+path.toErrorString()+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');path.push(key);validateFirebaseData(errorPrefix,value,path);
path.pop()});if(hasDotValue_1&&hasActualChild_1)throw Error(errorPrefix+' contains ".value" child '+path.toErrorString()+" in addition to actual children.");}},validateFirebaseMergePaths=function(errorPrefix,mergePaths){var i;for(i=0;i<mergePaths.length;i++){var curPath=mergePaths[i];for(var keys=curPath.slice(),j=0;j<keys.length;j++)if((".priority"!==keys[j]||j!==keys.length-1)&&!isValidKey(keys[j]))throw Error(errorPrefix+"contains an invalid key ("+keys[j]+") in path "+curPath.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');
}mergePaths.sort(Path.comparePaths);keys=null;for(i=0;i<mergePaths.length;i++){curPath=mergePaths[i];if(null!==keys&&keys.contains(curPath))throw Error(errorPrefix+"contains a path "+keys.toString()+" that is ancestor of another path "+curPath.toString());keys=curPath}},validateFirebaseMergeDataArg=function(fnName,argumentNumber,data,path,optional){if(!optional||void 0!==data){var errorPrefix=util.errorPrefix(fnName,argumentNumber,optional);if(!data||"object"!==typeof data||Array.isArray(data))throw Error(errorPrefix+
" must be an object containing the children to replace.");var mergePaths=[];each(data,function(key,value){key=new Path(key);validateFirebaseData(errorPrefix,value,path.child(key));if(".priority"===key.getBack()&&!isValidPriority(value))throw Error(errorPrefix+"contains an invalid value for '"+key.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");mergePaths.push(key)});validateFirebaseMergePaths(errorPrefix,mergePaths)}},validatePriority=function(fnName,
argumentNumber,priority,optional){if(!optional||void 0!==priority){if(isInvalidJSONNumber(priority))throw Error(util.errorPrefix(fnName,argumentNumber,optional)+"is "+priority.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!isValidPriority(priority))throw Error(util.errorPrefix(fnName,argumentNumber,optional)+"must be a valid Firebase priority (a string, finite number, server value, or null).");}},validateEventType=function(fnName,argumentNumber,
eventType,optional){if(!optional||void 0!==eventType)switch(eventType){case "value":case "child_added":case "child_removed":case "child_changed":case "child_moved":break;default:throw Error(util.errorPrefix(fnName,argumentNumber,optional)+'must be a valid event type \x3d "value", "child_added", "child_removed", "child_changed", or "child_moved".');}},validateKey=function(fnName,argumentNumber,key,optional){if(!(optional&&void 0===key||isValidKey(key)))throw Error(util.errorPrefix(fnName,argumentNumber,
optional)+'was an invalid key \x3d "'+key+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").');},validatePathString=function(fnName,argumentNumber,pathString,optional){if(!(optional&&void 0===pathString||isValidPathString(pathString)))throw Error(util.errorPrefix(fnName,argumentNumber,optional)+'was an invalid path \x3d "'+pathString+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"');},validateWritablePath=function(fnName,
path){if(".info"===path.getFront())throw Error(fnName+" failed \x3d Can't modify data under /.info/");},validateUrl=function(fnName,argumentNumber,parsedUrl){var pathString=parsedUrl.path.toString();!(parsedUrl="string"!==typeof parsedUrl.repoInfo.host||0===parsedUrl.repoInfo.host.length||!isValidKey(parsedUrl.repoInfo.namespace)&&"localhost"!==parsedUrl.repoInfo.host.split(":")[0])&&(parsedUrl=0!==pathString.length)&&(pathString&&(pathString=pathString.replace(/^\/*\.info(\/|$)/,"/")),parsedUrl=
!isValidPathString(pathString));if(parsedUrl)throw Error(util.errorPrefix(fnName,argumentNumber,!1)+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".');},OnDisconnect=function(){function OnDisconnect(repo_,path_){this.repo_=repo_;this.path_=path_}OnDisconnect.prototype.cancel=function(onComplete){util.validateArgCount("OnDisconnect.cancel",0,1,arguments.length);util.validateCallback("OnDisconnect.cancel",1,onComplete,!0);var deferred=new util.Deferred;this.repo_.onDisconnectCancel(this.path_,
deferred.wrapCallback(onComplete));return deferred.promise};OnDisconnect.prototype.remove=function(onComplete){util.validateArgCount("OnDisconnect.remove",0,1,arguments.length);validateWritablePath("OnDisconnect.remove",this.path_);util.validateCallback("OnDisconnect.remove",1,onComplete,!0);var deferred=new util.Deferred;this.repo_.onDisconnectSet(this.path_,null,deferred.wrapCallback(onComplete));return deferred.promise};OnDisconnect.prototype.set=function(value,onComplete){util.validateArgCount("OnDisconnect.set",
1,2,arguments.length);validateWritablePath("OnDisconnect.set",this.path_);validateFirebaseDataArg("OnDisconnect.set",1,value,this.path_,!1);util.validateCallback("OnDisconnect.set",2,onComplete,!0);var deferred=new util.Deferred;this.repo_.onDisconnectSet(this.path_,value,deferred.wrapCallback(onComplete));return deferred.promise};OnDisconnect.prototype.setWithPriority=function(value,priority,onComplete){util.validateArgCount("OnDisconnect.setWithPriority",2,3,arguments.length);validateWritablePath("OnDisconnect.setWithPriority",
this.path_);validateFirebaseDataArg("OnDisconnect.setWithPriority",1,value,this.path_,!1);validatePriority("OnDisconnect.setWithPriority",2,priority,!1);util.validateCallback("OnDisconnect.setWithPriority",3,onComplete,!0);var deferred=new util.Deferred;this.repo_.onDisconnectSetWithPriority(this.path_,value,priority,deferred.wrapCallback(onComplete));return deferred.promise};OnDisconnect.prototype.update=function(objectToMerge,onComplete){util.validateArgCount("OnDisconnect.update",1,2,arguments.length);
validateWritablePath("OnDisconnect.update",this.path_);if(Array.isArray(objectToMerge)){for(var newObjectToMerge={},i=0;i<objectToMerge.length;++i)newObjectToMerge[""+i]=objectToMerge[i];objectToMerge=newObjectToMerge;warn("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}validateFirebaseMergeDataArg("OnDisconnect.update",1,objectToMerge,
this.path_,!1);util.validateCallback("OnDisconnect.update",2,onComplete,!0);newObjectToMerge=new util.Deferred;this.repo_.onDisconnectUpdate(this.path_,objectToMerge,newObjectToMerge.wrapCallback(onComplete));return newObjectToMerge.promise};return OnDisconnect}(),TransactionResult=function(){function TransactionResult(committed,snapshot){this.committed=committed;this.snapshot=snapshot}TransactionResult.prototype.toJSON=function(){util.validateArgCount("TransactionResult.toJSON",0,1,arguments.length);
return{committed:this.committed,snapshot:this.snapshot.toJSON()}};return TransactionResult}(),nextPushId=function(){var lastPushTime=0,lastRandChars=[];return function(now){var duplicateTime=now===lastPushTime;lastPushTime=now;var i,timeStampChars=Array(8);for(i=7;0<=i;i--)timeStampChars[i]="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".charAt(now%64),now=Math.floor(now/64);util.assert(0===now,"Cannot push at time \x3d\x3d 0");now=timeStampChars.join("");if(duplicateTime){for(i=
11;0<=i&&63===lastRandChars[i];i--)lastRandChars[i]=0;lastRandChars[i]++}else for(i=0;12>i;i++)lastRandChars[i]=Math.floor(64*Math.random());for(i=0;12>i;i++)now+="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".charAt(lastRandChars[i]);util.assert(20===now.length,"nextPushId: Length should be 20.");return now}}(),NamedNode=function(){function NamedNode(name,node){this.name=name;this.node=node}NamedNode.Wrap=function(name,node){return new NamedNode(name,node)};return NamedNode}(),
Index=function(){function Index(){}Index.prototype.getCompare=function(){return this.compare.bind(this)};Index.prototype.indexedValueChanged=function(oldNode,newNode){oldNode=new NamedNode("[MIN_NAME]",oldNode);newNode=new NamedNode("[MIN_NAME]",newNode);return 0!==this.compare(oldNode,newNode)};Index.prototype.minPost=function(){return NamedNode.MIN};return Index}(),__EMPTY_NODE,KeyIndex=function(_super){function KeyIndex(){return null!==_super&&_super.apply(this,arguments)||this}tslib.__extends(KeyIndex,
_super);Object.defineProperty(KeyIndex,"__EMPTY_NODE",{get:function(){return __EMPTY_NODE},set:function(val){__EMPTY_NODE=val},enumerable:!1,configurable:!0});KeyIndex.prototype.compare=function(a,b){return nameCompare(a.name,b.name)};KeyIndex.prototype.isDefinedOn=function(node){throw util.assertionError("KeyIndex.isDefinedOn not expected to be called.");};KeyIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!1};KeyIndex.prototype.minPost=function(){return NamedNode.MIN};KeyIndex.prototype.maxPost=
function(){return new NamedNode("[MAX_NAME]",__EMPTY_NODE)};KeyIndex.prototype.makePost=function(indexValue,name){util.assert("string"===typeof indexValue,"KeyIndex indexValue must always be a string.");return new NamedNode(indexValue,__EMPTY_NODE)};KeyIndex.prototype.toString=function(){return".key"};return KeyIndex}(Index),KEY_INDEX=new KeyIndex,MAX_NODE,priorityHashText=function(priority){return"number"===typeof priority?"number:"+doubleToIEEE754String(priority):"string:"+priority},validatePriorityNode=
function(priorityNode){if(priorityNode.isLeafNode()){var val=priorityNode.val();util.assert("string"===typeof val||"number"===typeof val||"object"===typeof val&&util.contains(val,".sv"),"Priority must be a string or number.")}else util.assert(priorityNode===MAX_NODE||priorityNode.isEmpty(),"priority of unexpected type.");util.assert(priorityNode===MAX_NODE||priorityNode.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},__childrenNodeConstructor,LeafNode=function(){function LeafNode(value_,
priorityNode_){void 0===priorityNode_&&(priorityNode_=LeafNode.__childrenNodeConstructor.EMPTY_NODE);this.value_=value_;this.priorityNode_=priorityNode_;this.lazyHash_=null;util.assert(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value.");validatePriorityNode(this.priorityNode_)}Object.defineProperty(LeafNode,"__childrenNodeConstructor",{get:function(){return __childrenNodeConstructor},set:function(val){__childrenNodeConstructor=val},enumerable:!1,configurable:!0});
LeafNode.prototype.isLeafNode=function(){return!0};LeafNode.prototype.getPriority=function(){return this.priorityNode_};LeafNode.prototype.updatePriority=function(newPriorityNode){return new LeafNode(this.value_,newPriorityNode)};LeafNode.prototype.getImmediateChild=function(childName){return".priority"===childName?this.priorityNode_:LeafNode.__childrenNodeConstructor.EMPTY_NODE};LeafNode.prototype.getChild=function(path){return path.isEmpty()?this:".priority"===path.getFront()?this.priorityNode_:
LeafNode.__childrenNodeConstructor.EMPTY_NODE};LeafNode.prototype.hasChild=function(){return!1};LeafNode.prototype.getPredecessorChildName=function(childName,childNode){return null};LeafNode.prototype.updateImmediateChild=function(childName,newChildNode){return".priority"===childName?this.updatePriority(newChildNode):newChildNode.isEmpty()&&".priority"!==childName?this:LeafNode.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(childName,newChildNode).updatePriority(this.priorityNode_)};LeafNode.prototype.updateChild=
function(path,newChildNode){var front=path.getFront();if(null===front)return newChildNode;if(newChildNode.isEmpty()&&".priority"!==front)return this;util.assert(".priority"!==front||1===path.getLength(),".priority must be the last token in a path");return this.updateImmediateChild(front,LeafNode.__childrenNodeConstructor.EMPTY_NODE.updateChild(path.popFront(),newChildNode))};LeafNode.prototype.isEmpty=function(){return!1};LeafNode.prototype.numChildren=function(){return 0};LeafNode.prototype.forEachChild=
function(index,action){return!1};LeafNode.prototype.val=function(exportFormat){return exportFormat&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()};LeafNode.prototype.hash=function(){if(null===this.lazyHash_){var toHash="";this.priorityNode_.isEmpty()||(toHash+="priority:"+priorityHashText(this.priorityNode_.val())+":");var type=typeof this.value_;toHash+=type+":";toHash="number"===type?toHash+doubleToIEEE754String(this.value_):toHash+
this.value_;this.lazyHash_=sha1(toHash)}return this.lazyHash_};LeafNode.prototype.getValue=function(){return this.value_};LeafNode.prototype.compareTo=function(other){if(other===LeafNode.__childrenNodeConstructor.EMPTY_NODE)return 1;if(other instanceof LeafNode.__childrenNodeConstructor)return-1;util.assert(other.isLeafNode(),"Unknown node type");return this.compareToLeafNode_(other)};LeafNode.prototype.compareToLeafNode_=function(otherLeaf){var otherLeafType=typeof otherLeaf.value_,thisLeafType=
typeof this.value_,otherIndex=LeafNode.VALUE_TYPE_ORDER.indexOf(otherLeafType),thisIndex=LeafNode.VALUE_TYPE_ORDER.indexOf(thisLeafType);util.assert(0<=otherIndex,"Unknown leaf type: "+otherLeafType);util.assert(0<=thisIndex,"Unknown leaf type: "+thisLeafType);return otherIndex===thisIndex?"object"===thisLeafType?0:this.value_<otherLeaf.value_?-1:this.value_===otherLeaf.value_?0:1:thisIndex-otherIndex};LeafNode.prototype.withIndex=function(){return this};LeafNode.prototype.isIndexed=function(){return!0};
LeafNode.prototype.equals=function(other){return other===this?!0:other.isLeafNode()?this.value_===other.value_&&this.priorityNode_.equals(other.priorityNode_):!1};LeafNode.VALUE_TYPE_ORDER=["object","boolean","number","string"];return LeafNode}(),PRIORITY_INDEX=new (function(_super){function PriorityIndex(){return null!==_super&&_super.apply(this,arguments)||this}tslib.__extends(PriorityIndex,_super);PriorityIndex.prototype.compare=function(a,b){var aPriority=a.node.getPriority(),bPriority=b.node.getPriority();
aPriority=aPriority.compareTo(bPriority);return 0===aPriority?nameCompare(a.name,b.name):aPriority};PriorityIndex.prototype.isDefinedOn=function(node){return!node.getPriority().isEmpty()};PriorityIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!oldNode.getPriority().equals(newNode.getPriority())};PriorityIndex.prototype.minPost=function(){return NamedNode.MIN};PriorityIndex.prototype.maxPost=function(){return new NamedNode("[MAX_NAME]",new LeafNode("[PRIORITY-POST]",MAX_NODE$1))};
PriorityIndex.prototype.makePost=function(indexValue,name){indexValue=nodeFromJSON(indexValue);return new NamedNode(name,new LeafNode("[PRIORITY-POST]",indexValue))};PriorityIndex.prototype.toString=function(){return".priority"};return PriorityIndex}(Index)),SortedMapIterator=function(){function SortedMapIterator(node,startKey,comparator,isReverse_,resultGenerator_){void 0===resultGenerator_&&(resultGenerator_=null);this.isReverse_=isReverse_;this.resultGenerator_=resultGenerator_;for(this.nodeStack_=
[];!node.isEmpty();)if(resultGenerator_=startKey?comparator(node.key,startKey):1,isReverse_&&(resultGenerator_*=-1),0>resultGenerator_)node=this.isReverse_?node.left:node.right;else if(0===resultGenerator_){this.nodeStack_.push(node);break}else this.nodeStack_.push(node),node=this.isReverse_?node.right:node.left}SortedMapIterator.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var node=this.nodeStack_.pop();var result=this.resultGenerator_?this.resultGenerator_(node.key,node.value):
{key:node.key,value:node.value};if(this.isReverse_)for(node=node.left;!node.isEmpty();)this.nodeStack_.push(node),node=node.right;else for(node=node.right;!node.isEmpty();)this.nodeStack_.push(node),node=node.left;return result};SortedMapIterator.prototype.hasNext=function(){return 0<this.nodeStack_.length};SortedMapIterator.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var node=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(node.key,
node.value):{key:node.key,value:node.value}};return SortedMapIterator}(),LLRBNode=function(){function LLRBNode(key,value,color,left,right){this.key=key;this.value=value;this.color=null!=color?color:LLRBNode.RED;this.left=null!=left?left:SortedMap.EMPTY_NODE;this.right=null!=right?right:SortedMap.EMPTY_NODE}LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(null!=key?key:this.key,null!=value?value:this.value,null!=color?color:this.color,null!=left?left:this.left,null!=
right?right:this.right)};LLRBNode.prototype.count=function(){return this.left.count()+1+this.right.count()};LLRBNode.prototype.isEmpty=function(){return!1};LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||!!action(this.key,this.value)||this.right.inorderTraversal(action)};LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)};LLRBNode.prototype.min_=
function(){return this.left.isEmpty()?this:this.left.min_()};LLRBNode.prototype.minKey=function(){return this.min_().key};LLRBNode.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()};LLRBNode.prototype.insert=function(key,value,comparator){var n=this,cmp=comparator(key,n.key);n=0>cmp?n.copy(null,null,null,n.left.insert(key,value,comparator),null):0===cmp?n.copy(null,value,null,null,null):n.copy(null,null,null,null,n.right.insert(key,value,comparator));return n.fixUp_()};
LLRBNode.prototype.removeMin_=function(){if(this.left.isEmpty())return SortedMap.EMPTY_NODE;var n=this;n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_());n=n.copy(null,null,null,n.left.removeMin_(),null);return n.fixUp_()};LLRBNode.prototype.remove=function(key,comparator){var n=this;if(0>comparator(key,n.key))n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(key,comparator),null);else{n.left.isRed_()&&(n=n.rotateRight_());
n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_());if(0===comparator(key,n.key)){if(n.right.isEmpty())return SortedMap.EMPTY_NODE;var smallest=n.right.min_();n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp_()};LLRBNode.prototype.isRed_=function(){return this.color};LLRBNode.prototype.fixUp_=function(){var n=this;n.right.isRed_()&&!n.left.isRed_()&&(n=n.rotateLeft_());n.left.isRed_()&&
n.left.left.isRed_()&&(n=n.rotateRight_());n.left.isRed_()&&n.right.isRed_()&&(n=n.colorFlip_());return n};LLRBNode.prototype.moveRedLeft_=function(){var n=this.colorFlip_();n.right.left.isRed_()&&(n=n.copy(null,null,null,null,n.right.rotateRight_()),n=n.rotateLeft_(),n=n.colorFlip_());return n};LLRBNode.prototype.moveRedRight_=function(){var n=this.colorFlip_();n.left.left.isRed_()&&(n=n.rotateRight_(),n=n.colorFlip_());return n};LLRBNode.prototype.rotateLeft_=function(){var nl=this.copy(null,null,
LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,nl,null)};LLRBNode.prototype.rotateRight_=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,nr)};LLRBNode.prototype.colorFlip_=function(){var left=this.left.copy(null,null,!this.left.color,null,null),right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)};LLRBNode.prototype.checkMaxDepth_=function(){var blackDepth=
this.check_();return Math.pow(2,blackDepth)<=this.count()+1};LLRBNode.prototype.check_=function(){if(this.isRed_()&&this.left.isRed_())throw Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw Error("Right child of ("+this.key+","+this.value+") is red");var blackDepth=this.left.check_();if(blackDepth!==this.right.check_())throw Error("Black depths differ");return blackDepth+(this.isRed_()?0:1)};LLRBNode.RED=!0;LLRBNode.BLACK=!1;return LLRBNode}(),LLRBEmptyNode=
function(){function LLRBEmptyNode(){}LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this};LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode(key,value,null)};LLRBEmptyNode.prototype.remove=function(key,comparator){return this};LLRBEmptyNode.prototype.count=function(){return 0};LLRBEmptyNode.prototype.isEmpty=function(){return!0};LLRBEmptyNode.prototype.inorderTraversal=function(action){return!1};LLRBEmptyNode.prototype.reverseTraversal=function(action){return!1};
LLRBEmptyNode.prototype.minKey=function(){return null};LLRBEmptyNode.prototype.maxKey=function(){return null};LLRBEmptyNode.prototype.check_=function(){return 0};LLRBEmptyNode.prototype.isRed_=function(){return!1};return LLRBEmptyNode}(),SortedMap=function(){function SortedMap(comparator_,root_){void 0===root_&&(root_=SortedMap.EMPTY_NODE);this.comparator_=comparator_;this.root_=root_}SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator_,this.root_.insert(key,value,
this.comparator_).copy(null,null,LLRBNode.BLACK,null,null))};SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator_,this.root_.remove(key,this.comparator_).copy(null,null,LLRBNode.BLACK,null,null))};SortedMap.prototype.get=function(key){for(var cmp,node=this.root_;!node.isEmpty();){cmp=this.comparator_(key,node.key);if(0===cmp)return node.value;0>cmp?node=node.left:0<cmp&&(node=node.right)}return null};SortedMap.prototype.getPredecessorKey=function(key){for(var cmp,node=this.root_,
rightParent=null;!node.isEmpty();){cmp=this.comparator_(key,node.key);if(0===cmp){if(node.left.isEmpty())return rightParent?rightParent.key:null;for(node=node.left;!node.right.isEmpty();)node=node.right;return node.key}0>cmp?node=node.left:0<cmp&&(rightParent=node,node=node.right)}throw Error("Attempted to find predecessor key for a nonexistent key.  What gives?");};SortedMap.prototype.isEmpty=function(){return this.root_.isEmpty()};SortedMap.prototype.count=function(){return this.root_.count()};
SortedMap.prototype.minKey=function(){return this.root_.minKey()};SortedMap.prototype.maxKey=function(){return this.root_.maxKey()};SortedMap.prototype.inorderTraversal=function(action){return this.root_.inorderTraversal(action)};SortedMap.prototype.reverseTraversal=function(action){return this.root_.reverseTraversal(action)};SortedMap.prototype.getIterator=function(resultGenerator){return new SortedMapIterator(this.root_,null,this.comparator_,!1,resultGenerator)};SortedMap.prototype.getIteratorFrom=
function(key,resultGenerator){return new SortedMapIterator(this.root_,key,this.comparator_,!1,resultGenerator)};SortedMap.prototype.getReverseIteratorFrom=function(key,resultGenerator){return new SortedMapIterator(this.root_,key,this.comparator_,!0,resultGenerator)};SortedMap.prototype.getReverseIterator=function(resultGenerator){return new SortedMapIterator(this.root_,null,this.comparator_,!0,resultGenerator)};SortedMap.EMPTY_NODE=new LLRBEmptyNode;return SortedMap}(),LOG_2=Math.log(2),Base12Num=
function(){function Base12Num(length){this.count=parseInt(Math.log(length+1)/LOG_2,10);this.current_=this.count-1;var mask=parseInt(Array(this.count+1).join("1"),2);this.bits_=length+1&mask}Base12Num.prototype.nextBitIsOne=function(){var result=!(this.bits_&1<<this.current_);this.current_--;return result};return Base12Num}(),buildChildSet=function(childList,cmp,keyFn,mapSortFn){childList.sort(cmp);var buildBalancedTree=function(low,high){var length=high-low;if(0===length)return null;if(1===length){length=
childList[low];var key=keyFn?keyFn(length):length;return new LLRBNode(key,length.node,LLRBNode.BLACK,null,null)}length=parseInt(length/2,10)+low;low=buildBalancedTree(low,length);high=buildBalancedTree(length+1,high);length=childList[length];key=keyFn?keyFn(length):length;return new LLRBNode(key,length.node,LLRBNode.BLACK,low,high)},root$jscomp$0=function(base12){for(var node=null,root=null,index=childList.length,buildPennant=function(chunkSize,color){var low=index-chunkSize,high=index;index-=chunkSize;
chunkSize=buildBalancedTree(low+1,high);low=childList[low];high=keyFn?keyFn(low):low;color=new LLRBNode(high,low.node,color,null,chunkSize);node?node.left=color:root=color;node=color},i=0;i<base12.count;++i){var isOne=base12.nextBitIsOne(),chunkSize=Math.pow(2,base12.count-(i+1));isOne?buildPennant(chunkSize,LLRBNode.BLACK):(buildPennant(chunkSize,LLRBNode.BLACK),buildPennant(chunkSize,LLRBNode.RED))}return root}(new Base12Num(childList.length));return new SortedMap(mapSortFn||cmp,root$jscomp$0)},
_defaultIndexMap,fallbackObject={},IndexMap=function(){function IndexMap(indexes_,indexSet_){this.indexes_=indexes_;this.indexSet_=indexSet_}Object.defineProperty(IndexMap,"Default",{get:function(){util.assert(fallbackObject&&PRIORITY_INDEX,"ChildrenNode.ts has not been loaded");return _defaultIndexMap=_defaultIndexMap||new IndexMap({".priority":fallbackObject},{".priority":PRIORITY_INDEX})},enumerable:!1,configurable:!0});IndexMap.prototype.get=function(indexKey){var sortedMap=util.safeGet(this.indexes_,
indexKey);if(!sortedMap)throw Error("No index defined for "+indexKey);return sortedMap instanceof SortedMap?sortedMap:null};IndexMap.prototype.hasIndex=function(indexDefinition){return util.contains(this.indexSet_,indexDefinition.toString())};IndexMap.prototype.addIndex=function(indexDefinition,existingChildren){util.assert(indexDefinition!==KEY_INDEX,"KeyIndex always exists and isn't meant to be added to the IndexMap.");var childList=[],sawIndexedValue=!1;existingChildren=existingChildren.getIterator(NamedNode.Wrap);
for(var next=existingChildren.getNext();next;)sawIndexedValue=sawIndexedValue||indexDefinition.isDefinedOn(next.node),childList.push(next),next=existingChildren.getNext();childList=sawIndexedValue?buildChildSet(childList,indexDefinition.getCompare()):fallbackObject;sawIndexedValue=indexDefinition.toString();existingChildren=tslib.__assign({},this.indexSet_);existingChildren[sawIndexedValue]=indexDefinition;indexDefinition=tslib.__assign({},this.indexes_);indexDefinition[sawIndexedValue]=childList;
return new IndexMap(indexDefinition,existingChildren)};IndexMap.prototype.addToIndexes=function(namedNode,existingChildren){var _this=this,newIndexes=util.map(this.indexes_,function(indexedChildren,indexName){var index=util.safeGet(_this.indexSet_,indexName);util.assert(index,"Missing index implementation for "+indexName);if(indexedChildren===fallbackObject){if(index.isDefinedOn(namedNode.node)){indexedChildren=[];indexName=existingChildren.getIterator(NamedNode.Wrap);for(var next=indexName.getNext();next;)next.name!==
namedNode.name&&indexedChildren.push(next),next=indexName.getNext();indexedChildren.push(namedNode);return buildChildSet(indexedChildren,index.getCompare())}return fallbackObject}(index=existingChildren.get(namedNode.name))&&(indexedChildren=indexedChildren.remove(new NamedNode(namedNode.name,index)));return indexedChildren.insert(namedNode,namedNode.node)});return new IndexMap(newIndexes,this.indexSet_)};IndexMap.prototype.removeFromIndexes=function(namedNode,existingChildren){var newIndexes=util.map(this.indexes_,
function(indexedChildren){if(indexedChildren===fallbackObject)return indexedChildren;var existingSnap=existingChildren.get(namedNode.name);return existingSnap?indexedChildren.remove(new NamedNode(namedNode.name,existingSnap)):indexedChildren});return new IndexMap(newIndexes,this.indexSet_)};return IndexMap}(),EMPTY_NODE,ChildrenNode=function(){function ChildrenNode(children_,priorityNode_,indexMap_){this.children_=children_;this.priorityNode_=priorityNode_;this.indexMap_=indexMap_;this.lazyHash_=
null;this.priorityNode_&&validatePriorityNode(this.priorityNode_);this.children_.isEmpty()&&util.assert(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}Object.defineProperty(ChildrenNode,"EMPTY_NODE",{get:function(){return EMPTY_NODE||(EMPTY_NODE=new ChildrenNode(new SortedMap(NAME_COMPARATOR),null,IndexMap.Default))},enumerable:!1,configurable:!0});ChildrenNode.prototype.isLeafNode=function(){return!1};ChildrenNode.prototype.getPriority=function(){return this.priorityNode_||
EMPTY_NODE};ChildrenNode.prototype.updatePriority=function(newPriorityNode){return this.children_.isEmpty()?this:new ChildrenNode(this.children_,newPriorityNode,this.indexMap_)};ChildrenNode.prototype.getImmediateChild=function(childName){if(".priority"===childName)return this.getPriority();childName=this.children_.get(childName);return null===childName?EMPTY_NODE:childName};ChildrenNode.prototype.getChild=function(path){var front=path.getFront();return null===front?this:this.getImmediateChild(front).getChild(path.popFront())};
ChildrenNode.prototype.hasChild=function(childName){return null!==this.children_.get(childName)};ChildrenNode.prototype.updateImmediateChild=function(childName,newChildNode){util.assert(newChildNode,"We should always be passing snapshot nodes");if(".priority"===childName)return this.updatePriority(newChildNode);var namedNode=new NamedNode(childName,newChildNode);newChildNode.isEmpty()?(childName=this.children_.remove(childName),namedNode=this.indexMap_.removeFromIndexes(namedNode,this.children_)):
(childName=this.children_.insert(childName,newChildNode),namedNode=this.indexMap_.addToIndexes(namedNode,this.children_));newChildNode=childName.isEmpty()?EMPTY_NODE:this.priorityNode_;return new ChildrenNode(childName,newChildNode,namedNode)};ChildrenNode.prototype.updateChild=function(path,newChildNode){var front=path.getFront();if(null===front)return newChildNode;util.assert(".priority"!==path.getFront()||1===path.getLength(),".priority must be the last token in a path");path=this.getImmediateChild(front).updateChild(path.popFront(),
newChildNode);return this.updateImmediateChild(front,path)};ChildrenNode.prototype.isEmpty=function(){return this.children_.isEmpty()};ChildrenNode.prototype.numChildren=function(){return this.children_.count()};ChildrenNode.prototype.val=function(exportFormat){if(this.isEmpty())return null;var obj={},numKeys=0,maxKey=0,allIntegerKeys=!0;this.forEachChild(PRIORITY_INDEX,function(key,childNode){obj[key]=childNode.val(exportFormat);numKeys++;allIntegerKeys&&ChildrenNode.INTEGER_REGEXP_.test(key)?maxKey=
Math.max(maxKey,Number(key)):allIntegerKeys=!1});if(!exportFormat&&allIntegerKeys&&maxKey<2*numKeys){var array=[],key$jscomp$0;for(key$jscomp$0 in obj)array[key$jscomp$0]=obj[key$jscomp$0];return array}exportFormat&&!this.getPriority().isEmpty()&&(obj[".priority"]=this.getPriority().val());return obj};ChildrenNode.prototype.hash=function(){if(null===this.lazyHash_){var toHash_1="";this.getPriority().isEmpty()||(toHash_1+="priority:"+priorityHashText(this.getPriority().val())+":");this.forEachChild(PRIORITY_INDEX,
function(key,childNode){childNode=childNode.hash();""!==childNode&&(toHash_1+=":"+key+":"+childNode)});this.lazyHash_=""===toHash_1?"":sha1(toHash_1)}return this.lazyHash_};ChildrenNode.prototype.getPredecessorChildName=function(childName,childNode,index){return(index=this.resolveIndex_(index))?(childName=index.getPredecessorKey(new NamedNode(childName,childNode)))?childName.name:null:this.children_.getPredecessorKey(childName)};ChildrenNode.prototype.getFirstChildName=function(indexDefinition){return(indexDefinition=
this.resolveIndex_(indexDefinition))?(indexDefinition=indexDefinition.minKey())&&indexDefinition.name:this.children_.minKey()};ChildrenNode.prototype.getFirstChild=function(indexDefinition){return(indexDefinition=this.getFirstChildName(indexDefinition))?new NamedNode(indexDefinition,this.children_.get(indexDefinition)):null};ChildrenNode.prototype.getLastChildName=function(indexDefinition){return(indexDefinition=this.resolveIndex_(indexDefinition))?(indexDefinition=indexDefinition.maxKey())&&indexDefinition.name:
this.children_.maxKey()};ChildrenNode.prototype.getLastChild=function(indexDefinition){return(indexDefinition=this.getLastChildName(indexDefinition))?new NamedNode(indexDefinition,this.children_.get(indexDefinition)):null};ChildrenNode.prototype.forEachChild=function(index,action){return(index=this.resolveIndex_(index))?index.inorderTraversal(function(wrappedNode){return action(wrappedNode.name,wrappedNode.node)}):this.children_.inorderTraversal(action)};ChildrenNode.prototype.getIterator=function(indexDefinition){return this.getIteratorFrom(indexDefinition.minPost(),
indexDefinition)};ChildrenNode.prototype.getIteratorFrom=function(startPost,indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx)return idx.getIteratorFrom(startPost,function(key){return key});idx=this.children_.getIteratorFrom(startPost.name,NamedNode.Wrap);for(var next=idx.peek();null!=next&&0>indexDefinition.compare(next,startPost);)idx.getNext(),next=idx.peek();return idx};ChildrenNode.prototype.getReverseIterator=function(indexDefinition){return this.getReverseIteratorFrom(indexDefinition.maxPost(),
indexDefinition)};ChildrenNode.prototype.getReverseIteratorFrom=function(endPost,indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx)return idx.getReverseIteratorFrom(endPost,function(key){return key});idx=this.children_.getReverseIteratorFrom(endPost.name,NamedNode.Wrap);for(var next=idx.peek();null!=next&&0<indexDefinition.compare(next,endPost);)idx.getNext(),next=idx.peek();return idx};ChildrenNode.prototype.compareTo=function(other){return this.isEmpty()?other.isEmpty()?0:-1:other.isLeafNode()||
other.isEmpty()?1:other===MAX_NODE$2?-1:0};ChildrenNode.prototype.withIndex=function(indexDefinition){if(indexDefinition===KEY_INDEX||this.indexMap_.hasIndex(indexDefinition))return this;indexDefinition=this.indexMap_.addIndex(indexDefinition,this.children_);return new ChildrenNode(this.children_,this.priorityNode_,indexDefinition)};ChildrenNode.prototype.isIndexed=function(index){return index===KEY_INDEX||this.indexMap_.hasIndex(index)};ChildrenNode.prototype.equals=function(other){if(other===this)return!0;
if(other.isLeafNode())return!1;if(this.getPriority().equals(other.getPriority())&&this.children_.count()===other.children_.count()){var thisIter=this.getIterator(PRIORITY_INDEX);other=other.getIterator(PRIORITY_INDEX);for(var thisCurrent=thisIter.getNext(),otherCurrent=other.getNext();thisCurrent&&otherCurrent;){if(thisCurrent.name!==otherCurrent.name||!thisCurrent.node.equals(otherCurrent.node))return!1;thisCurrent=thisIter.getNext();otherCurrent=other.getNext()}return null===thisCurrent&&null===
otherCurrent}return!1};ChildrenNode.prototype.resolveIndex_=function(indexDefinition){return indexDefinition===KEY_INDEX?null:this.indexMap_.get(indexDefinition.toString())};ChildrenNode.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;return ChildrenNode}(),MAX_NODE$2=new (function(_super){function MaxNode(){return _super.call(this,new SortedMap(NAME_COMPARATOR),ChildrenNode.EMPTY_NODE,IndexMap.Default)||this}tslib.__extends(MaxNode,_super);MaxNode.prototype.compareTo=function(other){return other===this?0:1};MaxNode.prototype.equals=
function(other){return other===this};MaxNode.prototype.getPriority=function(){return this};MaxNode.prototype.getImmediateChild=function(childName){return ChildrenNode.EMPTY_NODE};MaxNode.prototype.isEmpty=function(){return!1};return MaxNode}(ChildrenNode));Object.defineProperties(NamedNode,{MIN:{value:new NamedNode("[MIN_NAME]",ChildrenNode.EMPTY_NODE)},MAX:{value:new NamedNode("[MAX_NAME]",MAX_NODE$2)}});KeyIndex.__EMPTY_NODE=ChildrenNode.EMPTY_NODE;LeafNode.__childrenNodeConstructor=ChildrenNode;
var MAX_NODE$1=MAX_NODE=MAX_NODE$2;var nodeFromJSON=nodeFromJSON$1;var VALUE_INDEX=new (function(_super){function ValueIndex(){return null!==_super&&_super.apply(this,arguments)||this}tslib.__extends(ValueIndex,_super);ValueIndex.prototype.compare=function(a,b){var indexCmp=a.node.compareTo(b.node);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp};ValueIndex.prototype.isDefinedOn=function(node){return!0};ValueIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!oldNode.equals(newNode)};
ValueIndex.prototype.minPost=function(){return NamedNode.MIN};ValueIndex.prototype.maxPost=function(){return NamedNode.MAX};ValueIndex.prototype.makePost=function(indexValue,name){indexValue=nodeFromJSON$1(indexValue);return new NamedNode(name,indexValue)};ValueIndex.prototype.toString=function(){return".value"};return ValueIndex}(Index)),PathIndex=function(_super){function PathIndex(indexPath_){var _this=_super.call(this)||this;_this.indexPath_=indexPath_;util.assert(!indexPath_.isEmpty()&&".priority"!==
indexPath_.getFront(),"Can't create PathIndex with empty path or .priority key");return _this}tslib.__extends(PathIndex,_super);PathIndex.prototype.extractChild=function(snap){return snap.getChild(this.indexPath_)};PathIndex.prototype.isDefinedOn=function(node){return!node.getChild(this.indexPath_).isEmpty()};PathIndex.prototype.compare=function(a,b){var aChild=this.extractChild(a.node),bChild=this.extractChild(b.node);aChild=aChild.compareTo(bChild);return 0===aChild?nameCompare(a.name,b.name):aChild};
PathIndex.prototype.makePost=function(indexValue,name){indexValue=nodeFromJSON$1(indexValue);indexValue=ChildrenNode.EMPTY_NODE.updateChild(this.indexPath_,indexValue);return new NamedNode(name,indexValue)};PathIndex.prototype.maxPost=function(){var node=ChildrenNode.EMPTY_NODE.updateChild(this.indexPath_,MAX_NODE$2);return new NamedNode("[MAX_NAME]",node)};PathIndex.prototype.toString=function(){return this.indexPath_.slice().join("/")};return PathIndex}(Index),DataSnapshot=function(){function DataSnapshot(node_,
ref_,index_){this.node_=node_;this.ref_=ref_;this.index_=index_}DataSnapshot.prototype.val=function(){util.validateArgCount("DataSnapshot.val",0,0,arguments.length);return this.node_.val()};DataSnapshot.prototype.exportVal=function(){util.validateArgCount("DataSnapshot.exportVal",0,0,arguments.length);return this.node_.val(!0)};DataSnapshot.prototype.toJSON=function(){util.validateArgCount("DataSnapshot.toJSON",0,1,arguments.length);return this.exportVal()};DataSnapshot.prototype.exists=function(){util.validateArgCount("DataSnapshot.exists",
0,0,arguments.length);return!this.node_.isEmpty()};DataSnapshot.prototype.child=function(childPathString){util.validateArgCount("DataSnapshot.child",0,1,arguments.length);childPathString=String(childPathString);validatePathString("DataSnapshot.child",1,childPathString,!1);var childPath=new Path(childPathString),childRef=this.ref_.child(childPath);return new DataSnapshot(this.node_.getChild(childPath),childRef,PRIORITY_INDEX)};DataSnapshot.prototype.hasChild=function(childPathString){util.validateArgCount("DataSnapshot.hasChild",
1,1,arguments.length);validatePathString("DataSnapshot.hasChild",1,childPathString,!1);var childPath=new Path(childPathString);return!this.node_.getChild(childPath).isEmpty()};DataSnapshot.prototype.getPriority=function(){util.validateArgCount("DataSnapshot.getPriority",0,0,arguments.length);return this.node_.getPriority().val()};DataSnapshot.prototype.forEach=function(action){var _this=this;util.validateArgCount("DataSnapshot.forEach",1,1,arguments.length);util.validateCallback("DataSnapshot.forEach",
1,action,!1);return this.node_.isLeafNode()?!1:!!this.node_.forEachChild(this.index_,function(key,node){return action(new DataSnapshot(node,_this.ref_.child(key),PRIORITY_INDEX))})};DataSnapshot.prototype.hasChildren=function(){util.validateArgCount("DataSnapshot.hasChildren",0,0,arguments.length);return this.node_.isLeafNode()?!1:!this.node_.isEmpty()};Object.defineProperty(DataSnapshot.prototype,"key",{get:function(){return this.ref_.getKey()},enumerable:!1,configurable:!0});DataSnapshot.prototype.numChildren=
function(){util.validateArgCount("DataSnapshot.numChildren",0,0,arguments.length);return this.node_.numChildren()};DataSnapshot.prototype.getRef=function(){util.validateArgCount("DataSnapshot.ref",0,0,arguments.length);return this.ref_};Object.defineProperty(DataSnapshot.prototype,"ref",{get:function(){return this.getRef()},enumerable:!1,configurable:!0});return DataSnapshot}(),DataEvent=function(){function DataEvent(eventType,eventRegistration,snapshot,prevName){this.eventType=eventType;this.eventRegistration=
eventRegistration;this.snapshot=snapshot;this.prevName=prevName}DataEvent.prototype.getPath=function(){var ref=this.snapshot.getRef();return"value"===this.eventType?ref.path:ref.getParent().path};DataEvent.prototype.getEventType=function(){return this.eventType};DataEvent.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)};DataEvent.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+util.stringify(this.snapshot.exportVal())};return DataEvent}(),
CancelEvent=function(){function CancelEvent(eventRegistration,error,path){this.eventRegistration=eventRegistration;this.error=error;this.path=path}CancelEvent.prototype.getPath=function(){return this.path};CancelEvent.prototype.getEventType=function(){return"cancel"};CancelEvent.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)};CancelEvent.prototype.toString=function(){return this.path.toString()+":cancel"};return CancelEvent}(),ValueEventRegistration=function(){function ValueEventRegistration(callback_,
cancelCallback_,context_){this.callback_=callback_;this.cancelCallback_=cancelCallback_;this.context_=context_}ValueEventRegistration.prototype.respondsTo=function(eventType){return"value"===eventType};ValueEventRegistration.prototype.createEvent=function(change,query){var index=query.getQueryParams().getIndex();return new DataEvent("value",this,new DataSnapshot(change.snapshotNode,query.getRef(),index))};ValueEventRegistration.prototype.getEventRunner=function(eventData){var ctx=this.context_;if("cancel"===
eventData.getEventType()){util.assert(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var cancelCB_1=this.cancelCallback_;return function(){cancelCB_1.call(ctx,eventData.error)}}var cb_1=this.callback_;return function(){cb_1.call(ctx,eventData.snapshot)}};ValueEventRegistration.prototype.createCancelEvent=function(error,path){return this.cancelCallback_?new CancelEvent(this,error,path):null};ValueEventRegistration.prototype.matches=function(other){return other instanceof
ValueEventRegistration?other.callback_&&this.callback_?other.callback_===this.callback_&&other.context_===this.context_:!0:!1};ValueEventRegistration.prototype.hasAnyCallback=function(){return null!==this.callback_};return ValueEventRegistration}(),ChildEventRegistration=function(){function ChildEventRegistration(callbacks_,cancelCallback_,context_){this.callbacks_=callbacks_;this.cancelCallback_=cancelCallback_;this.context_=context_}ChildEventRegistration.prototype.respondsTo=function(eventType){eventType=
"children_added"===eventType?"child_added":eventType;return util.contains(this.callbacks_,"children_removed"===eventType?"child_removed":eventType)};ChildEventRegistration.prototype.createCancelEvent=function(error,path){return this.cancelCallback_?new CancelEvent(this,error,path):null};ChildEventRegistration.prototype.createEvent=function(change,query){util.assert(null!=change.childName,"Child events should have a childName.");var ref=query.getRef().child(change.childName);query=query.getQueryParams().getIndex();
return new DataEvent(change.type,this,new DataSnapshot(change.snapshotNode,ref,query),change.prevName)};ChildEventRegistration.prototype.getEventRunner=function(eventData){var ctx=this.context_;if("cancel"===eventData.getEventType()){util.assert(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var cancelCB_2=this.cancelCallback_;return function(){cancelCB_2.call(ctx,eventData.error)}}var cb_2=this.callbacks_[eventData.eventType];return function(){cb_2.call(ctx,
eventData.snapshot,eventData.prevName)}};ChildEventRegistration.prototype.matches=function(other){var _this=this;if(other instanceof ChildEventRegistration){if(!this.callbacks_||!other.callbacks_)return!0;if(this.context_===other.context_){var otherKeys=Object.keys(other.callbacks_),thisKeys=Object.keys(this.callbacks_),otherCount=otherKeys.length;if(otherCount===thisKeys.length)return 1===otherCount?(otherKeys=otherKeys[0],thisKeys=thisKeys[0],thisKeys===otherKeys&&(!other.callbacks_[otherKeys]||
!this.callbacks_[thisKeys]||other.callbacks_[otherKeys]===this.callbacks_[thisKeys])):thisKeys.every(function(eventType){return other.callbacks_[eventType]===_this.callbacks_[eventType]})}}return!1};ChildEventRegistration.prototype.hasAnyCallback=function(){return null!==this.callbacks_};return ChildEventRegistration}(),__referenceConstructor,Query=function(){function Query(repo,path,queryParams_,orderByCalled_){this.repo=repo;this.path=path;this.queryParams_=queryParams_;this.orderByCalled_=orderByCalled_}
Object.defineProperty(Query,"__referenceConstructor",{get:function(){util.assert(__referenceConstructor,"Reference.ts has not been loaded");return __referenceConstructor},set:function(val){__referenceConstructor=val},enumerable:!1,configurable:!0});Query.validateQueryEndpoints_=function(params){var startNode=null,endNode=null;params.hasStart()&&(startNode=params.getIndexStartValue());params.hasEnd()&&(endNode=params.getIndexEndValue());if(params.getIndex()===KEY_INDEX){if(params.hasStart()){if("[MIN_NAME]"!==
params.getIndexStartName())throw Error("Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().");if("string"!==typeof startNode)throw Error("Query: When ordering by key, the argument passed to startAt(), endAt(),or equalTo() must be a string.");}if(params.hasEnd()){if("[MAX_NAME]"!==params.getIndexEndName())throw Error("Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().");if("string"!==typeof endNode)throw Error("Query: When ordering by key, the argument passed to startAt(), endAt(),or equalTo() must be a string.");
}}else if(params.getIndex()===PRIORITY_INDEX){if(null!=startNode&&!isValidPriority(startNode)||null!=endNode&&!isValidPriority(endNode))throw Error("Query: When ordering by priority, the first argument passed to startAt(), endAt(), or equalTo() must be a valid priority value (null, a number, or a string).");}else if(util.assert(params.getIndex()instanceof PathIndex||params.getIndex()===VALUE_INDEX,"unknown index type."),null!=startNode&&"object"===typeof startNode||null!=endNode&&"object"===typeof endNode)throw Error("Query: First argument passed to startAt(), endAt(), or equalTo() cannot be an object.");
};Query.validateLimit_=function(params){if(params.hasStart()&&params.hasEnd()&&params.hasLimit()&&!params.hasAnchoredLimit())throw Error("Query: Can't combine startAt(), endAt(), and limit(). Use limitToFirst() or limitToLast() instead.");};Query.prototype.validateNoPreviousOrderByCall_=function(fnName){if(!0===this.orderByCalled_)throw Error(fnName+": You can't combine multiple orderBy calls.");};Query.prototype.getQueryParams=function(){return this.queryParams_};Query.prototype.getRef=function(){util.validateArgCount("Query.ref",
0,0,arguments.length);return new Query.__referenceConstructor(this.repo,this.path)};Query.prototype.on=function(eventType,callback,cancelCallbackOrContext,context){util.validateArgCount("Query.on",2,4,arguments.length);validateEventType("Query.on",1,eventType,!1);util.validateCallback("Query.on",2,callback,!1);var ret=Query.getCancelAndContextArgs_("Query.on",cancelCallbackOrContext,context);if("value"===eventType)this.onValueEvent(callback,ret.cancel,ret.context);else{var callbacks={};callbacks[eventType]=
callback;this.onChildEvent(callbacks,ret.cancel,ret.context)}return callback};Query.prototype.onValueEvent=function(callback,cancelCallback,context){callback=new ValueEventRegistration(callback,cancelCallback||null,context||null);this.repo.addEventCallbackForQuery(this,callback)};Query.prototype.onChildEvent=function(callbacks,cancelCallback,context){callbacks=new ChildEventRegistration(callbacks,cancelCallback,context);this.repo.addEventCallbackForQuery(this,callbacks)};Query.prototype.off=function(eventType,
callback,context){util.validateArgCount("Query.off",0,3,arguments.length);validateEventType("Query.off",1,eventType,!0);util.validateCallback("Query.off",2,callback,!0);util.validateContextObject("Query.off",3,context,!0);var container=null,callbacks=null;"value"===eventType?container=new ValueEventRegistration(callback||null,null,context||null):eventType&&(callback&&(callbacks={},callbacks[eventType]=callback),container=new ChildEventRegistration(callbacks,null,context||null));this.repo.removeEventCallbackForQuery(this,
container)};Query.prototype.once=function(eventType,userCallback,failureCallbackOrContext,context){var _this=this;util.validateArgCount("Query.once",1,4,arguments.length);validateEventType("Query.once",1,eventType,!1);util.validateCallback("Query.once",2,userCallback,!0);var ret=Query.getCancelAndContextArgs_("Query.once",failureCallbackOrContext,context),firstCall=!0,deferred=new util.Deferred;deferred.promise.catch(function(){});var onceCallback=function(snapshot){firstCall&&(firstCall=!1,_this.off(eventType,
onceCallback),userCallback&&userCallback.bind(ret.context)(snapshot),deferred.resolve(snapshot))};this.on(eventType,onceCallback,function(err){_this.off(eventType,onceCallback);ret.cancel&&ret.cancel.bind(ret.context)(err);deferred.reject(err)});return deferred.promise};Query.prototype.limitToFirst=function(limit){util.validateArgCount("Query.limitToFirst",1,1,arguments.length);if("number"!==typeof limit||Math.floor(limit)!==limit||0>=limit)throw Error("Query.limitToFirst: First argument must be a positive integer.");
if(this.queryParams_.hasLimit())throw Error("Query.limitToFirst: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Query(this.repo,this.path,this.queryParams_.limitToFirst(limit),this.orderByCalled_)};Query.prototype.limitToLast=function(limit){util.validateArgCount("Query.limitToLast",1,1,arguments.length);if("number"!==typeof limit||Math.floor(limit)!==limit||0>=limit)throw Error("Query.limitToLast: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw Error("Query.limitToLast: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");
return new Query(this.repo,this.path,this.queryParams_.limitToLast(limit),this.orderByCalled_)};Query.prototype.orderByChild=function(path){util.validateArgCount("Query.orderByChild",1,1,arguments.length);if("$key"===path)throw Error('Query.orderByChild: "$key" is invalid.  Use Query.orderByKey() instead.');if("$priority"===path)throw Error('Query.orderByChild: "$priority" is invalid.  Use Query.orderByPriority() instead.');if("$value"===path)throw Error('Query.orderByChild: "$value" is invalid.  Use Query.orderByValue() instead.');
validatePathString("Query.orderByChild",1,path,!1);this.validateNoPreviousOrderByCall_("Query.orderByChild");var parsedPath=new Path(path);if(parsedPath.isEmpty())throw Error("Query.orderByChild: cannot pass in empty path.  Use Query.orderByValue() instead.");parsedPath=new PathIndex(parsedPath);parsedPath=this.queryParams_.orderBy(parsedPath);Query.validateQueryEndpoints_(parsedPath);return new Query(this.repo,this.path,parsedPath,!0)};Query.prototype.orderByKey=function(){util.validateArgCount("Query.orderByKey",
0,0,arguments.length);this.validateNoPreviousOrderByCall_("Query.orderByKey");var newParams=this.queryParams_.orderBy(KEY_INDEX);Query.validateQueryEndpoints_(newParams);return new Query(this.repo,this.path,newParams,!0)};Query.prototype.orderByPriority=function(){util.validateArgCount("Query.orderByPriority",0,0,arguments.length);this.validateNoPreviousOrderByCall_("Query.orderByPriority");var newParams=this.queryParams_.orderBy(PRIORITY_INDEX);Query.validateQueryEndpoints_(newParams);return new Query(this.repo,
this.path,newParams,!0)};Query.prototype.orderByValue=function(){util.validateArgCount("Query.orderByValue",0,0,arguments.length);this.validateNoPreviousOrderByCall_("Query.orderByValue");var newParams=this.queryParams_.orderBy(VALUE_INDEX);Query.validateQueryEndpoints_(newParams);return new Query(this.repo,this.path,newParams,!0)};Query.prototype.startAt=function(value,name){void 0===value&&(value=null);util.validateArgCount("Query.startAt",0,2,arguments.length);validateFirebaseDataArg("Query.startAt",
1,value,this.path,!0);validateKey("Query.startAt",2,name,!0);var newParams=this.queryParams_.startAt(value,name);Query.validateLimit_(newParams);Query.validateQueryEndpoints_(newParams);if(this.queryParams_.hasStart())throw Error("Query.startAt: Starting point was already set (by another call to startAt or equalTo).");void 0===value&&(name=value=null);return new Query(this.repo,this.path,newParams,this.orderByCalled_)};Query.prototype.endAt=function(value,name){void 0===value&&(value=null);util.validateArgCount("Query.endAt",
0,2,arguments.length);validateFirebaseDataArg("Query.endAt",1,value,this.path,!0);validateKey("Query.endAt",2,name,!0);var newParams=this.queryParams_.endAt(value,name);Query.validateLimit_(newParams);Query.validateQueryEndpoints_(newParams);if(this.queryParams_.hasEnd())throw Error("Query.endAt: Ending point was already set (by another call to endAt or equalTo).");return new Query(this.repo,this.path,newParams,this.orderByCalled_)};Query.prototype.equalTo=function(value,name){util.validateArgCount("Query.equalTo",
1,2,arguments.length);validateFirebaseDataArg("Query.equalTo",1,value,this.path,!1);validateKey("Query.equalTo",2,name,!0);if(this.queryParams_.hasStart())throw Error("Query.equalTo: Starting point was already set (by another call to startAt or equalTo).");if(this.queryParams_.hasEnd())throw Error("Query.equalTo: Ending point was already set (by another call to endAt or equalTo).");return this.startAt(value,name).endAt(value,name)};Query.prototype.toString=function(){util.validateArgCount("Query.toString",
0,0,arguments.length);return this.repo.toString()+this.path.toUrlEncodedString()};Query.prototype.toJSON=function(){util.validateArgCount("Query.toJSON",0,1,arguments.length);return this.toString()};Query.prototype.queryObject=function(){return this.queryParams_.getQueryObject()};Query.prototype.queryIdentifier=function(){var obj=this.queryObject();obj=ObjectToUniqueKey(obj);return"{}"===obj?"default":obj};Query.prototype.isEqual=function(other){util.validateArgCount("Query.isEqual",1,1,arguments.length);
if(!(other instanceof Query))throw Error("Query.isEqual failed: First argument must be an instance of firebase.database.Query.");var sameRepo=this.repo===other.repo,samePath=this.path.equals(other.path),sameQueryIdentifier=this.queryIdentifier()===other.queryIdentifier();return sameRepo&&samePath&&sameQueryIdentifier};Query.getCancelAndContextArgs_=function(fnName,cancelOrContext,context){var ret={cancel:null,context:null};if(cancelOrContext&&context)ret.cancel=cancelOrContext,util.validateCallback(fnName,
3,ret.cancel,!0),ret.context=context,util.validateContextObject(fnName,4,ret.context,!0);else if(cancelOrContext)if("object"===typeof cancelOrContext&&null!==cancelOrContext)ret.context=cancelOrContext;else if("function"===typeof cancelOrContext)ret.cancel=cancelOrContext;else throw Error(util.errorPrefix(fnName,3,!0)+" must either be a cancel callback or a context object.");return ret};Object.defineProperty(Query.prototype,"ref",{get:function(){return this.getRef()},enumerable:!1,configurable:!0});
return Query}(),ExistingValueProvider=function(){function ExistingValueProvider(node_){this.node_=node_}ExistingValueProvider.prototype.getImmediateChild=function(childName){childName=this.node_.getImmediateChild(childName);return new ExistingValueProvider(childName)};ExistingValueProvider.prototype.node=function(){return this.node_};return ExistingValueProvider}(),DeferredValueProvider=function(){function DeferredValueProvider(syncTree,path){this.syncTree_=syncTree;this.path_=path}DeferredValueProvider.prototype.getImmediateChild=
function(childName){childName=this.path_.child(childName);return new DeferredValueProvider(this.syncTree_,childName)};DeferredValueProvider.prototype.node=function(){return this.syncTree_.calcCompleteEventCache(this.path_)};return DeferredValueProvider}(),resolveDeferredLeafValue=function(value,existingVal,serverValues){if(!value||"object"!==typeof value)return value;util.assert(".sv"in value,"Unexpected leaf node or priority contents");if("string"===typeof value[".sv"]){a:{existingVal=value[".sv"];
switch(existingVal){case "timestamp":existingVal=serverValues.timestamp;break a;default:util.assert(!1,"Unexpected server value: "+existingVal)}existingVal=void 0}return existingVal}if("object"===typeof value[".sv"])return serverValues=value[".sv"],serverValues.hasOwnProperty("increment")||util.assert(!1,"Unexpected server value: "+JSON.stringify(serverValues,null,2)),serverValues=serverValues.increment,"number"!==typeof serverValues&&util.assert(!1,"Unexpected increment value: "+serverValues),existingVal=
existingVal.node(),util.assert(null!==existingVal&&"undefined"!==typeof existingVal,"Expected ChildrenNode.EMPTY_NODE for nulls"),existingVal.isLeafNode()?(existingVal=existingVal.getValue(),existingVal="number"!==typeof existingVal?serverValues:existingVal+serverValues):existingVal=serverValues,existingVal;util.assert(!1,"Unexpected server value: "+JSON.stringify(value,null,2))},resolveDeferredValueSnapshot=function(node,existing,serverValues){return resolveDeferredValue(node,new ExistingValueProvider(existing),
serverValues)},SparseSnapshotTree=function(){function SparseSnapshotTree(){this.value=null;this.children=new Map}SparseSnapshotTree.prototype.find=function(path){if(null!=this.value)return this.value.getChild(path);if(!path.isEmpty()&&0<this.children.size){var childKey=path.getFront();path=path.popFront();return this.children.has(childKey)?this.children.get(childKey).find(path):null}return null};SparseSnapshotTree.prototype.remember=function(path,data){if(path.isEmpty())this.value=data,this.children.clear();
else if(null!==this.value)this.value=this.value.updateChild(path,data);else{var childKey=path.getFront();this.children.has(childKey)||this.children.set(childKey,new SparseSnapshotTree);childKey=this.children.get(childKey);path=path.popFront();childKey.remember(path,data)}};SparseSnapshotTree.prototype.forget=function(path){if(path.isEmpty())return this.value=null,this.children.clear(),!0;if(null!==this.value){if(this.value.isLeafNode())return!1;var value=this.value;this.value=null;var self_1=this;
value.forEachChild(PRIORITY_INDEX,function(key,tree){self_1.remember(new Path(key),tree)});return this.forget(path)}return 0<this.children.size?(value=path.getFront(),path=path.popFront(),this.children.has(value)&&this.children.get(value).forget(path)&&this.children.delete(value),0===this.children.size):!0};SparseSnapshotTree.prototype.forEachTree=function(prefixPath,func){null!==this.value?func(prefixPath,this.value):this.forEachChild(function(key,tree){key=new Path(prefixPath.toString()+"/"+key);
tree.forEachTree(key,func)})};SparseSnapshotTree.prototype.forEachChild=function(func){this.children.forEach(function(tree,key){func(key,tree)})};return SparseSnapshotTree}(),OperationType;(function(OperationType){OperationType[OperationType.OVERWRITE=0]="OVERWRITE";OperationType[OperationType.MERGE=1]="MERGE";OperationType[OperationType.ACK_USER_WRITE=2]="ACK_USER_WRITE";OperationType[OperationType.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(OperationType||(OperationType={}));var OperationSource=function(){function OperationSource(fromUser,
fromServer,queryId,tagged){this.fromUser=fromUser;this.fromServer=fromServer;this.queryId=queryId;this.tagged=tagged;util.assert(!tagged||fromServer,"Tagged queries must be from server.")}OperationSource.User=new OperationSource(!0,!1,null,!1);OperationSource.Server=new OperationSource(!1,!0,null,!1);OperationSource.forServerTaggedQuery=function(queryId){return new OperationSource(!1,!0,queryId,!0)};return OperationSource}(),AckUserWrite=function(){function AckUserWrite(path,affectedTree,revert){this.path=
path;this.affectedTree=affectedTree;this.revert=revert;this.type=OperationType.ACK_USER_WRITE;this.source=OperationSource.User}AckUserWrite.prototype.operationForChild=function(childName){if(this.path.isEmpty()){if(null!=this.affectedTree.value)return util.assert(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;childName=this.affectedTree.subtree(new Path(childName));return new AckUserWrite(Path.Empty,childName,this.revert)}util.assert(this.path.getFront()===
childName,"operationForChild called for unrelated child.");return new AckUserWrite(this.path.popFront(),this.affectedTree,this.revert)};return AckUserWrite}(),emptyChildrenSingleton,ImmutableTree=function(){function ImmutableTree(value,children){void 0===children&&(emptyChildrenSingleton||(emptyChildrenSingleton=new SortedMap(stringCompare)),children=emptyChildrenSingleton);this.value=value;this.children=children}ImmutableTree.fromObject=function(obj){var tree=ImmutableTree.Empty;each(obj,function(childPath,
childSnap){tree=tree.set(new Path(childPath),childSnap)});return tree};ImmutableTree.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()};ImmutableTree.prototype.findRootMostMatchingPathAndValue=function(relativePath,predicate){if(null!=this.value&&predicate(this.value))return{path:Path.Empty,value:this.value};if(relativePath.isEmpty())return null;var front=relativePath.getFront(),child=this.children.get(front);return null!==child?(relativePath=child.findRootMostMatchingPathAndValue(relativePath.popFront(),
predicate),null!=relativePath?{path:(new Path(front)).child(relativePath.path),value:relativePath.value}:null):null};ImmutableTree.prototype.findRootMostValueAndPath=function(relativePath){return this.findRootMostMatchingPathAndValue(relativePath,function(){return!0})};ImmutableTree.prototype.subtree=function(relativePath){if(relativePath.isEmpty())return this;var front=relativePath.getFront();front=this.children.get(front);return null!==front?front.subtree(relativePath.popFront()):ImmutableTree.Empty};
ImmutableTree.prototype.set=function(relativePath,toSet){if(relativePath.isEmpty())return new ImmutableTree(toSet,this.children);var front=relativePath.getFront();relativePath=(this.children.get(front)||ImmutableTree.Empty).set(relativePath.popFront(),toSet);front=this.children.insert(front,relativePath);return new ImmutableTree(this.value,front)};ImmutableTree.prototype.remove=function(relativePath){if(relativePath.isEmpty())return this.children.isEmpty()?ImmutableTree.Empty:new ImmutableTree(null,
this.children);var front=relativePath.getFront(),child=this.children.get(front);return child?(relativePath=child.remove(relativePath.popFront()),front=relativePath.isEmpty()?this.children.remove(front):this.children.insert(front,relativePath),null===this.value&&front.isEmpty()?ImmutableTree.Empty:new ImmutableTree(this.value,front)):this};ImmutableTree.prototype.get=function(relativePath){if(relativePath.isEmpty())return this.value;var front=relativePath.getFront();return(front=this.children.get(front))?
front.get(relativePath.popFront()):null};ImmutableTree.prototype.setTree=function(relativePath,newTree){if(relativePath.isEmpty())return newTree;var front=relativePath.getFront();relativePath=(this.children.get(front)||ImmutableTree.Empty).setTree(relativePath.popFront(),newTree);front=relativePath.isEmpty()?this.children.remove(front):this.children.insert(front,relativePath);return new ImmutableTree(this.value,front)};ImmutableTree.prototype.fold=function(fn){return this.fold_(Path.Empty,fn)};ImmutableTree.prototype.fold_=
function(pathSoFar,fn){var accum={};this.children.inorderTraversal(function(childKey,childTree){accum[childKey]=childTree.fold_(pathSoFar.child(childKey),fn)});return fn(pathSoFar,this.value,accum)};ImmutableTree.prototype.findOnPath=function(path,f){return this.findOnPath_(path,Path.Empty,f)};ImmutableTree.prototype.findOnPath_=function(pathToFollow,pathSoFar,f){var result=this.value?f(pathSoFar,this.value):!1;if(result)return result;if(pathToFollow.isEmpty())return null;result=pathToFollow.getFront();
var nextChild=this.children.get(result);return nextChild?nextChild.findOnPath_(pathToFollow.popFront(),pathSoFar.child(result),f):null};ImmutableTree.prototype.foreachOnPath=function(path,f){return this.foreachOnPath_(path,Path.Empty,f)};ImmutableTree.prototype.foreachOnPath_=function(pathToFollow,currentRelativePath,f){if(pathToFollow.isEmpty())return this;this.value&&f(currentRelativePath,this.value);var front=pathToFollow.getFront(),nextChild=this.children.get(front);return nextChild?nextChild.foreachOnPath_(pathToFollow.popFront(),
currentRelativePath.child(front),f):ImmutableTree.Empty};ImmutableTree.prototype.foreach=function(f){this.foreach_(Path.Empty,f)};ImmutableTree.prototype.foreach_=function(currentRelativePath,f){this.children.inorderTraversal(function(childName,childTree){childTree.foreach_(currentRelativePath.child(childName),f)});this.value&&f(currentRelativePath,this.value)};ImmutableTree.prototype.foreachChild=function(f){this.children.inorderTraversal(function(childName,childTree){childTree.value&&f(childName,
childTree.value)})};ImmutableTree.Empty=new ImmutableTree(null);return ImmutableTree}(),ListenComplete=function(){function ListenComplete(source,path){this.source=source;this.path=path;this.type=OperationType.LISTEN_COMPLETE}ListenComplete.prototype.operationForChild=function(childName){return this.path.isEmpty()?new ListenComplete(this.source,Path.Empty):new ListenComplete(this.source,this.path.popFront())};return ListenComplete}(),Overwrite=function(){function Overwrite(source,path,snap){this.source=
source;this.path=path;this.snap=snap;this.type=OperationType.OVERWRITE}Overwrite.prototype.operationForChild=function(childName){return this.path.isEmpty()?new Overwrite(this.source,Path.Empty,this.snap.getImmediateChild(childName)):new Overwrite(this.source,this.path.popFront(),this.snap)};return Overwrite}(),Merge=function(){function Merge(source,path,children){this.source=source;this.path=path;this.children=children;this.type=OperationType.MERGE}Merge.prototype.operationForChild=function(childName){if(this.path.isEmpty())return childName=
this.children.subtree(new Path(childName)),childName.isEmpty()?null:childName.value?new Overwrite(this.source,Path.Empty,childName.value):new Merge(this.source,Path.Empty,childName);util.assert(this.path.getFront()===childName,"Can't get a merge for a child not on the path of the operation");return new Merge(this.source,this.path.popFront(),this.children)};Merge.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"};return Merge}(),
CacheNode=function(){function CacheNode(node_,fullyInitialized_,filtered_){this.node_=node_;this.fullyInitialized_=fullyInitialized_;this.filtered_=filtered_}CacheNode.prototype.isFullyInitialized=function(){return this.fullyInitialized_};CacheNode.prototype.isFiltered=function(){return this.filtered_};CacheNode.prototype.isCompleteForPath=function(path){if(path.isEmpty())return this.isFullyInitialized()&&!this.filtered_;path=path.getFront();return this.isCompleteForChild(path)};CacheNode.prototype.isCompleteForChild=
function(key){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(key)};CacheNode.prototype.getNode=function(){return this.node_};return CacheNode}(),ViewCache=function(){function ViewCache(eventCache_,serverCache_){this.eventCache_=eventCache_;this.serverCache_=serverCache_}ViewCache.prototype.updateEventSnap=function(eventSnap,complete,filtered){return new ViewCache(new CacheNode(eventSnap,complete,filtered),this.serverCache_)};ViewCache.prototype.updateServerSnap=function(serverSnap,
complete,filtered){return new ViewCache(this.eventCache_,new CacheNode(serverSnap,complete,filtered))};ViewCache.prototype.getEventCache=function(){return this.eventCache_};ViewCache.prototype.getCompleteEventSnap=function(){return this.eventCache_.isFullyInitialized()?this.eventCache_.getNode():null};ViewCache.prototype.getServerCache=function(){return this.serverCache_};ViewCache.prototype.getCompleteServerSnap=function(){return this.serverCache_.isFullyInitialized()?this.serverCache_.getNode():
null};ViewCache.Empty=new ViewCache(new CacheNode(ChildrenNode.EMPTY_NODE,!1,!1),new CacheNode(ChildrenNode.EMPTY_NODE,!1,!1));return ViewCache}(),Change=function(){function Change(type,snapshotNode,childName,oldSnap,prevName){this.type=type;this.snapshotNode=snapshotNode;this.childName=childName;this.oldSnap=oldSnap;this.prevName=prevName}Change.valueChange=function(snapshot){return new Change(Change.VALUE,snapshot)};Change.childAddedChange=function(childKey,snapshot){return new Change(Change.CHILD_ADDED,
snapshot,childKey)};Change.childRemovedChange=function(childKey,snapshot){return new Change(Change.CHILD_REMOVED,snapshot,childKey)};Change.childChangedChange=function(childKey,newSnapshot,oldSnapshot){return new Change(Change.CHILD_CHANGED,newSnapshot,childKey,oldSnapshot)};Change.childMovedChange=function(childKey,snapshot){return new Change(Change.CHILD_MOVED,snapshot,childKey)};Change.CHILD_ADDED="child_added";Change.CHILD_REMOVED="child_removed";Change.CHILD_CHANGED="child_changed";Change.CHILD_MOVED=
"child_moved";Change.VALUE="value";return Change}(),IndexedFilter=function(){function IndexedFilter(index_){this.index_=index_}IndexedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){util.assert(snap.isIndexed(this.index_),"A node must be indexed if only a child is updated");source=snap.getImmediateChild(key);if(source.getChild(affectedPath).equals(newChild.getChild(affectedPath))&&source.isEmpty()===newChild.isEmpty())return snap;null!=optChangeAccumulator&&
(newChild.isEmpty()?snap.hasChild(key)?optChangeAccumulator.trackChildChange(Change.childRemovedChange(key,source)):util.assert(snap.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):source.isEmpty()?optChangeAccumulator.trackChildChange(Change.childAddedChange(key,newChild)):optChangeAccumulator.trackChildChange(Change.childChangedChange(key,newChild,source)));return snap.isLeafNode()&&newChild.isEmpty()?snap:snap.updateImmediateChild(key,newChild).withIndex(this.index_)};
IndexedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){null!=optChangeAccumulator&&(oldSnap.isLeafNode()||oldSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){newSnap.hasChild(key)||optChangeAccumulator.trackChildChange(Change.childRemovedChange(key,childNode))}),newSnap.isLeafNode()||newSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){if(oldSnap.hasChild(key)){var oldChild=oldSnap.getImmediateChild(key);oldChild.equals(childNode)||optChangeAccumulator.trackChildChange(Change.childChangedChange(key,
childNode,oldChild))}else optChangeAccumulator.trackChildChange(Change.childAddedChange(key,childNode))}));return newSnap.withIndex(this.index_)};IndexedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap.isEmpty()?ChildrenNode.EMPTY_NODE:oldSnap.updatePriority(newPriority)};IndexedFilter.prototype.filtersNodes=function(){return!1};IndexedFilter.prototype.getIndexedFilter=function(){return this};IndexedFilter.prototype.getIndex=function(){return this.index_};return IndexedFilter}(),
ChildChangeAccumulator=function(){function ChildChangeAccumulator(){this.changeMap=new Map}ChildChangeAccumulator.prototype.trackChildChange=function(change){var type=change.type,childKey=change.childName;util.assert(type===Change.CHILD_ADDED||type===Change.CHILD_CHANGED||type===Change.CHILD_REMOVED,"Only child changes supported for tracking");util.assert(".priority"!==childKey,"Only non-priority child changes can be tracked.");var oldChange=this.changeMap.get(childKey);if(oldChange){var oldType=
oldChange.type;if(type===Change.CHILD_ADDED&&oldType===Change.CHILD_REMOVED)this.changeMap.set(childKey,Change.childChangedChange(childKey,change.snapshotNode,oldChange.snapshotNode));else if(type===Change.CHILD_REMOVED&&oldType===Change.CHILD_ADDED)this.changeMap.delete(childKey);else if(type===Change.CHILD_REMOVED&&oldType===Change.CHILD_CHANGED)this.changeMap.set(childKey,Change.childRemovedChange(childKey,oldChange.oldSnap));else if(type===Change.CHILD_CHANGED&&oldType===Change.CHILD_ADDED)this.changeMap.set(childKey,
Change.childAddedChange(childKey,change.snapshotNode));else if(type===Change.CHILD_CHANGED&&oldType===Change.CHILD_CHANGED)this.changeMap.set(childKey,Change.childChangedChange(childKey,change.snapshotNode,oldChange.oldSnap));else throw util.assertionError("Illegal combination of changes: "+change+" occurred after "+oldChange);}else this.changeMap.set(childKey,change)};ChildChangeAccumulator.prototype.getChanges=function(){return Array.from(this.changeMap.values())};return ChildChangeAccumulator}(),
NO_COMPLETE_CHILD_SOURCE=new (function(){function NoCompleteChildSource_(){}NoCompleteChildSource_.prototype.getCompleteChild=function(childKey){return null};NoCompleteChildSource_.prototype.getChildAfterChild=function(index,child,reverse){return null};return NoCompleteChildSource_}()),WriteTreeCompleteChildSource=function(){function WriteTreeCompleteChildSource(writes_,viewCache_,optCompleteServerCache_){void 0===optCompleteServerCache_&&(optCompleteServerCache_=null);this.writes_=writes_;this.viewCache_=
viewCache_;this.optCompleteServerCache_=optCompleteServerCache_}WriteTreeCompleteChildSource.prototype.getCompleteChild=function(childKey){var node=this.viewCache_.getEventCache();if(node.isCompleteForChild(childKey))return node.getNode().getImmediateChild(childKey);node=null!=this.optCompleteServerCache_?new CacheNode(this.optCompleteServerCache_,!0,!1):this.viewCache_.getServerCache();return this.writes_.calcCompleteChild(childKey,node)};WriteTreeCompleteChildSource.prototype.getChildAfterChild=
function(index,child,reverse){var completeServerData=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:this.viewCache_.getCompleteServerSnap();index=this.writes_.calcIndexedSlice(completeServerData,child,1,reverse,index);return 0===index.length?null:index[0]};return WriteTreeCompleteChildSource}(),ProcessorResult=function(){return function(viewCache,changes){this.viewCache=viewCache;this.changes=changes}}(),ViewProcessor=function(){function ViewProcessor(filter_){this.filter_=filter_}
ViewProcessor.prototype.assertIndexed=function(viewCache){util.assert(viewCache.getEventCache().getNode().isIndexed(this.filter_.getIndex()),"Event snap not indexed");util.assert(viewCache.getServerCache().getNode().isIndexed(this.filter_.getIndex()),"Server snap not indexed")};ViewProcessor.prototype.applyOperation=function(oldViewCache,operation,writesCache,completeCache){var accumulator=new ChildChangeAccumulator;if(operation.type===OperationType.OVERWRITE)if(operation.source.fromUser)operation=
this.applyUserOverwrite_(oldViewCache,operation.path,operation.snap,writesCache,completeCache,accumulator);else{util.assert(operation.source.fromServer,"Unknown source.");var filterServerNode=operation.source.tagged||oldViewCache.getServerCache().isFiltered()&&!operation.path.isEmpty();operation=this.applyServerOverwrite_(oldViewCache,operation.path,operation.snap,writesCache,completeCache,filterServerNode,accumulator)}else if(operation.type===OperationType.MERGE)operation.source.fromUser?operation=
this.applyUserMerge_(oldViewCache,operation.path,operation.children,writesCache,completeCache,accumulator):(util.assert(operation.source.fromServer,"Unknown source."),filterServerNode=operation.source.tagged||oldViewCache.getServerCache().isFiltered(),operation=this.applyServerMerge_(oldViewCache,operation.path,operation.children,writesCache,completeCache,filterServerNode,accumulator));else if(operation.type===OperationType.ACK_USER_WRITE)operation=operation.revert?this.revertUserWrite_(oldViewCache,
operation.path,writesCache,completeCache,accumulator):this.ackUserWrite_(oldViewCache,operation.path,operation.affectedTree,writesCache,completeCache,accumulator);else if(operation.type===OperationType.LISTEN_COMPLETE)operation=this.listenComplete_(oldViewCache,operation.path,writesCache,accumulator);else throw util.assertionError("Unknown operation type: "+operation.type);accumulator=accumulator.getChanges();ViewProcessor.maybeAddValueEvent_(oldViewCache,operation,accumulator);return new ProcessorResult(operation,
accumulator)};ViewProcessor.maybeAddValueEvent_=function(oldViewCache,newViewCache,accumulator){var eventSnap=newViewCache.getEventCache();if(eventSnap.isFullyInitialized()){var isLeafOrEmpty=eventSnap.getNode().isLeafNode()||eventSnap.getNode().isEmpty(),oldCompleteSnap=oldViewCache.getCompleteEventSnap();(0<accumulator.length||!oldViewCache.getEventCache().isFullyInitialized()||isLeafOrEmpty&&!eventSnap.getNode().equals(oldCompleteSnap)||!eventSnap.getNode().getPriority().equals(oldCompleteSnap.getPriority()))&&
accumulator.push(Change.valueChange(newViewCache.getCompleteEventSnap()))}};ViewProcessor.prototype.generateEventCacheAfterServerEvent_=function(viewCache,changePath,writesCache,source,accumulator){var oldEventSnap=viewCache.getEventCache();if(null!=writesCache.shadowingWrite(changePath))return viewCache;if(changePath.isEmpty())util.assert(viewCache.getServerCache().isFullyInitialized(),"If change path is empty, we must have complete server data"),viewCache.getServerCache().isFiltered()?(source=viewCache.getCompleteServerSnap(),
writesCache=writesCache.calcCompleteEventChildren(source instanceof ChildrenNode?source:ChildrenNode.EMPTY_NODE),accumulator=this.filter_.updateFullNode(viewCache.getEventCache().getNode(),writesCache,accumulator)):(writesCache=writesCache.calcCompleteEventCache(viewCache.getCompleteServerSnap()),accumulator=this.filter_.updateFullNode(viewCache.getEventCache().getNode(),writesCache,accumulator));else{var childKey=changePath.getFront();if(".priority"===childKey){util.assert(1===changePath.getLength(),
"Can't have a priority with additional path components");accumulator=oldEventSnap.getNode();var serverNode=viewCache.getServerCache().getNode();writesCache=writesCache.calcEventCacheAfterServerOverwrite(changePath,accumulator,serverNode);accumulator=null!=writesCache?this.filter_.updatePriority(accumulator,writesCache):oldEventSnap.getNode()}else{var childChangePath=changePath.popFront();oldEventSnap.isCompleteForChild(childKey)?(serverNode=viewCache.getServerCache().getNode(),writesCache=writesCache.calcEventCacheAfterServerOverwrite(changePath,
oldEventSnap.getNode(),serverNode),writesCache=null!=writesCache?oldEventSnap.getNode().getImmediateChild(childKey).updateChild(childChangePath,writesCache):oldEventSnap.getNode().getImmediateChild(childKey)):writesCache=writesCache.calcCompleteChild(childKey,viewCache.getServerCache());accumulator=null!=writesCache?this.filter_.updateChild(oldEventSnap.getNode(),childKey,writesCache,childChangePath,source,accumulator):oldEventSnap.getNode()}}return viewCache.updateEventSnap(accumulator,oldEventSnap.isFullyInitialized()||
changePath.isEmpty(),this.filter_.filtersNodes())};ViewProcessor.prototype.applyServerOverwrite_=function(oldViewCache,changePath,changedSnap,writesCache,completeCache,filterServerNode,accumulator){var oldServerSnap=oldViewCache.getServerCache();filterServerNode=filterServerNode?this.filter_:this.filter_.getIndexedFilter();if(changePath.isEmpty())changedSnap=filterServerNode.updateFullNode(oldServerSnap.getNode(),changedSnap,null);else if(filterServerNode.filtersNodes()&&!oldServerSnap.isFiltered())changedSnap=
oldServerSnap.getNode().updateChild(changePath,changedSnap),changedSnap=filterServerNode.updateFullNode(oldServerSnap.getNode(),changedSnap,null);else{var childKey=changePath.getFront();if(!oldServerSnap.isCompleteForPath(changePath)&&1<changePath.getLength())return oldViewCache;var childChangePath=changePath.popFront();changedSnap=oldServerSnap.getNode().getImmediateChild(childKey).updateChild(childChangePath,changedSnap);changedSnap=".priority"===childKey?filterServerNode.updatePriority(oldServerSnap.getNode(),
changedSnap):filterServerNode.updateChild(oldServerSnap.getNode(),childKey,changedSnap,childChangePath,NO_COMPLETE_CHILD_SOURCE,null)}oldViewCache=oldViewCache.updateServerSnap(changedSnap,oldServerSnap.isFullyInitialized()||changePath.isEmpty(),filterServerNode.filtersNodes());completeCache=new WriteTreeCompleteChildSource(writesCache,oldViewCache,completeCache);return this.generateEventCacheAfterServerEvent_(oldViewCache,changePath,writesCache,completeCache,accumulator)};ViewProcessor.prototype.applyUserOverwrite_=
function(oldViewCache,changePath,changedSnap,writesCache,completeCache,accumulator){var oldEventSnap=oldViewCache.getEventCache();writesCache=new WriteTreeCompleteChildSource(writesCache,oldViewCache,completeCache);if(changePath.isEmpty())accumulator=this.filter_.updateFullNode(oldViewCache.getEventCache().getNode(),changedSnap,accumulator),oldViewCache=oldViewCache.updateEventSnap(accumulator,!0,this.filter_.filtersNodes());else if(completeCache=changePath.getFront(),".priority"===completeCache)accumulator=
this.filter_.updatePriority(oldViewCache.getEventCache().getNode(),changedSnap),oldViewCache=oldViewCache.updateEventSnap(accumulator,oldEventSnap.isFullyInitialized(),oldEventSnap.isFiltered());else{changePath=changePath.popFront();var oldChild=oldEventSnap.getNode().getImmediateChild(completeCache);if(!changePath.isEmpty()){var childNode=writesCache.getCompleteChild(completeCache);changedSnap=null!=childNode?".priority"===changePath.getBack()&&childNode.getChild(changePath.parent()).isEmpty()?childNode:
childNode.updateChild(changePath,changedSnap):ChildrenNode.EMPTY_NODE}oldChild.equals(changedSnap)||(accumulator=this.filter_.updateChild(oldEventSnap.getNode(),completeCache,changedSnap,changePath,writesCache,accumulator),oldViewCache=oldViewCache.updateEventSnap(accumulator,oldEventSnap.isFullyInitialized(),this.filter_.filtersNodes()))}return oldViewCache};ViewProcessor.cacheHasChild_=function(viewCache,childKey){return viewCache.getEventCache().isCompleteForChild(childKey)};ViewProcessor.prototype.applyUserMerge_=
function(viewCache,path,changedChildren,writesCache,serverCache,accumulator){var _this=this,curViewCache=viewCache;changedChildren.foreach(function(relativePath,childNode){relativePath=path.child(relativePath);ViewProcessor.cacheHasChild_(viewCache,relativePath.getFront())&&(curViewCache=_this.applyUserOverwrite_(curViewCache,relativePath,childNode,writesCache,serverCache,accumulator))});changedChildren.foreach(function(relativePath,childNode){relativePath=path.child(relativePath);ViewProcessor.cacheHasChild_(viewCache,
relativePath.getFront())||(curViewCache=_this.applyUserOverwrite_(curViewCache,relativePath,childNode,writesCache,serverCache,accumulator))});return curViewCache};ViewProcessor.prototype.applyMerge_=function(node,merge){merge.foreach(function(relativePath,childNode){node=node.updateChild(relativePath,childNode)});return node};ViewProcessor.prototype.applyServerMerge_=function(viewCache,path,changedChildren,writesCache,serverCache,filterServerNode,accumulator){var _this=this;if(viewCache.getServerCache().getNode().isEmpty()&&
!viewCache.getServerCache().isFullyInitialized())return viewCache;var curViewCache=viewCache;path=path.isEmpty()?changedChildren:ImmutableTree.Empty.setTree(path,changedChildren);var serverNode=viewCache.getServerCache().getNode();path.children.inorderTraversal(function(childKey,childTree){if(serverNode.hasChild(childKey)){var serverChild=viewCache.getServerCache().getNode().getImmediateChild(childKey);childTree=_this.applyMerge_(serverChild,childTree);curViewCache=_this.applyServerOverwrite_(curViewCache,
new Path(childKey),childTree,writesCache,serverCache,filterServerNode,accumulator)}});path.children.inorderTraversal(function(childKey,childMergeTree){var isUnknownDeepMerge=!viewCache.getServerCache().isCompleteForChild(childKey)&&null==childMergeTree.value;serverNode.hasChild(childKey)||isUnknownDeepMerge||(isUnknownDeepMerge=viewCache.getServerCache().getNode().getImmediateChild(childKey),childMergeTree=_this.applyMerge_(isUnknownDeepMerge,childMergeTree),curViewCache=_this.applyServerOverwrite_(curViewCache,
new Path(childKey),childMergeTree,writesCache,serverCache,filterServerNode,accumulator))});return curViewCache};ViewProcessor.prototype.ackUserWrite_=function(viewCache,ackPath,affectedTree,writesCache,completeCache,accumulator){if(null!=writesCache.shadowingWrite(ackPath))return viewCache;var filterServerNode=viewCache.getServerCache().isFiltered(),serverCache=viewCache.getServerCache();if(null!=affectedTree.value){if(ackPath.isEmpty()&&serverCache.isFullyInitialized()||serverCache.isCompleteForPath(ackPath))return this.applyServerOverwrite_(viewCache,
ackPath,serverCache.getNode().getChild(ackPath),writesCache,completeCache,filterServerNode,accumulator);if(ackPath.isEmpty()){var changedChildren_1=ImmutableTree.Empty;serverCache.getNode().forEachChild(KEY_INDEX,function(name,node){changedChildren_1=changedChildren_1.set(new Path(name),node)});return this.applyServerMerge_(viewCache,ackPath,changedChildren_1,writesCache,completeCache,filterServerNode,accumulator)}return viewCache}var changedChildren_2=ImmutableTree.Empty;affectedTree.foreach(function(mergePath,
value){value=ackPath.child(mergePath);serverCache.isCompleteForPath(value)&&(changedChildren_2=changedChildren_2.set(mergePath,serverCache.getNode().getChild(value)))});return this.applyServerMerge_(viewCache,ackPath,changedChildren_2,writesCache,completeCache,filterServerNode,accumulator)};ViewProcessor.prototype.listenComplete_=function(viewCache,path,writesCache,accumulator){var oldServerNode=viewCache.getServerCache();viewCache=viewCache.updateServerSnap(oldServerNode.getNode(),oldServerNode.isFullyInitialized()||
path.isEmpty(),oldServerNode.isFiltered());return this.generateEventCacheAfterServerEvent_(viewCache,path,writesCache,NO_COMPLETE_CHILD_SOURCE,accumulator)};ViewProcessor.prototype.revertUserWrite_=function(viewCache,path,writesCache,completeServerCache,accumulator){if(null!=writesCache.shadowingWrite(path))return viewCache;var source=new WriteTreeCompleteChildSource(writesCache,viewCache,completeServerCache);completeServerCache=viewCache.getEventCache().getNode();if(path.isEmpty()||".priority"===
path.getFront())viewCache.getServerCache().isFullyInitialized()?path=writesCache.calcCompleteEventCache(viewCache.getCompleteServerSnap()):(path=viewCache.getServerCache().getNode(),util.assert(path instanceof ChildrenNode,"serverChildren would be complete if leaf node"),path=writesCache.calcCompleteEventChildren(path)),path=this.filter_.updateFullNode(completeServerCache,path,accumulator);else{var childKey=path.getFront(),newChild=writesCache.calcCompleteChild(childKey,viewCache.getServerCache());
null==newChild&&viewCache.getServerCache().isCompleteForChild(childKey)&&(newChild=completeServerCache.getImmediateChild(childKey));path=null!=newChild?this.filter_.updateChild(completeServerCache,childKey,newChild,path.popFront(),source,accumulator):viewCache.getEventCache().getNode().hasChild(childKey)?this.filter_.updateChild(completeServerCache,childKey,ChildrenNode.EMPTY_NODE,path.popFront(),source,accumulator):completeServerCache;path.isEmpty()&&viewCache.getServerCache().isFullyInitialized()&&
(completeServerCache=writesCache.calcCompleteEventCache(viewCache.getCompleteServerSnap()),completeServerCache.isLeafNode()&&(path=this.filter_.updateFullNode(path,completeServerCache,accumulator)))}completeServerCache=viewCache.getServerCache().isFullyInitialized()||null!=writesCache.shadowingWrite(Path.Empty);return viewCache.updateEventSnap(path,completeServerCache,this.filter_.filtersNodes())};return ViewProcessor}(),EventGenerator=function(){function EventGenerator(query_){this.query_=query_;
this.index_=this.query_.getQueryParams().getIndex()}EventGenerator.prototype.generateEventsForChanges=function(changes,eventCache,eventRegistrations){var _this=this,events=[],moves=[];changes.forEach(function(change){change.type===Change.CHILD_CHANGED&&_this.index_.indexedValueChanged(change.oldSnap,change.snapshotNode)&&moves.push(Change.childMovedChange(change.childName,change.snapshotNode))});this.generateEventsForType_(events,Change.CHILD_REMOVED,changes,eventRegistrations,eventCache);this.generateEventsForType_(events,
Change.CHILD_ADDED,changes,eventRegistrations,eventCache);this.generateEventsForType_(events,Change.CHILD_MOVED,moves,eventRegistrations,eventCache);this.generateEventsForType_(events,Change.CHILD_CHANGED,changes,eventRegistrations,eventCache);this.generateEventsForType_(events,Change.VALUE,changes,eventRegistrations,eventCache);return events};EventGenerator.prototype.generateEventsForType_=function(events,eventType,changes,registrations,eventCache){var _this=this;changes=changes.filter(function(change){return change.type===
eventType});changes.sort(this.compareChanges_.bind(this));changes.forEach(function(change){var materializedChange=_this.materializeSingleChange_(change,eventCache);registrations.forEach(function(registration){registration.respondsTo(change.type)&&events.push(registration.createEvent(materializedChange,_this.query_))})})};EventGenerator.prototype.materializeSingleChange_=function(change,eventCache){"value"!==change.type&&"child_removed"!==change.type&&(change.prevName=eventCache.getPredecessorChildName(change.childName,
change.snapshotNode,this.index_));return change};EventGenerator.prototype.compareChanges_=function(a,b){if(null==a.childName||null==b.childName)throw util.assertionError("Should only compare child_ events.");a=new NamedNode(a.childName,a.snapshotNode);b=new NamedNode(b.childName,b.snapshotNode);return this.index_.compare(a,b)};return EventGenerator}(),View=function(){function View(query_,initialViewCache){this.query_=query_;this.eventRegistrations_=[];var params=this.query_.getQueryParams();query_=
new IndexedFilter(params.getIndex());params=params.getNodeFilter();this.processor_=new ViewProcessor(params);var initialServerCache=initialViewCache.getServerCache();initialViewCache=initialViewCache.getEventCache();var serverSnap=query_.updateFullNode(ChildrenNode.EMPTY_NODE,initialServerCache.getNode(),null),eventSnap=params.updateFullNode(ChildrenNode.EMPTY_NODE,initialViewCache.getNode(),null);query_=new CacheNode(serverSnap,initialServerCache.isFullyInitialized(),query_.filtersNodes());params=
new CacheNode(eventSnap,initialViewCache.isFullyInitialized(),params.filtersNodes());this.viewCache_=new ViewCache(params,query_);this.eventGenerator_=new EventGenerator(this.query_)}View.prototype.getQuery=function(){return this.query_};View.prototype.getServerCache=function(){return this.viewCache_.getServerCache().getNode()};View.prototype.getCompleteServerCache=function(path){var cache=this.viewCache_.getCompleteServerSnap();return cache&&(this.query_.getQueryParams().loadsAllData()||!path.isEmpty()&&
!cache.getImmediateChild(path.getFront()).isEmpty())?cache.getChild(path):null};View.prototype.isEmpty=function(){return 0===this.eventRegistrations_.length};View.prototype.addEventRegistration=function(eventRegistration){this.eventRegistrations_.push(eventRegistration)};View.prototype.removeEventRegistration=function(eventRegistration,cancelError){var cancelEvents=[];if(cancelError){util.assert(null==eventRegistration,"A cancel should cancel all event registrations.");var path_1=this.query_.path;
this.eventRegistrations_.forEach(function(registration){(registration=registration.createCancelEvent(cancelError,path_1))&&cancelEvents.push(registration)})}if(eventRegistration){for(var remaining=[],i=0;i<this.eventRegistrations_.length;++i){var existing=this.eventRegistrations_[i];if(!existing.matches(eventRegistration))remaining.push(existing);else if(eventRegistration.hasAnyCallback()){remaining=remaining.concat(this.eventRegistrations_.slice(i+1));break}}this.eventRegistrations_=remaining}else this.eventRegistrations_=
[];return cancelEvents};View.prototype.applyOperation=function(operation,writesCache,completeServerCache){operation.type===OperationType.MERGE&&null!==operation.source.queryId&&(util.assert(this.viewCache_.getCompleteServerSnap(),"We should always have a full cache before handling merges"),util.assert(this.viewCache_.getCompleteEventSnap(),"Missing event cache, even though we have a server cache"));var oldViewCache=this.viewCache_;operation=this.processor_.applyOperation(oldViewCache,operation,writesCache,
completeServerCache);this.processor_.assertIndexed(operation.viewCache);util.assert(operation.viewCache.getServerCache().isFullyInitialized()||!oldViewCache.getServerCache().isFullyInitialized(),"Once a server snap is complete, it should never go back");this.viewCache_=operation.viewCache;return this.generateEventsForChanges_(operation.changes,operation.viewCache.getEventCache().getNode(),null)};View.prototype.getInitialEvents=function(registration){var eventSnap=this.viewCache_.getEventCache(),initialChanges=
[];eventSnap.getNode().isLeafNode()||eventSnap.getNode().forEachChild(PRIORITY_INDEX,function(key,childNode){initialChanges.push(Change.childAddedChange(key,childNode))});eventSnap.isFullyInitialized()&&initialChanges.push(Change.valueChange(eventSnap.getNode()));return this.generateEventsForChanges_(initialChanges,eventSnap.getNode(),registration)};View.prototype.generateEventsForChanges_=function(changes,eventCache,eventRegistration){return this.eventGenerator_.generateEventsForChanges(changes,
eventCache,eventRegistration?[eventRegistration]:this.eventRegistrations_)};return View}(),__referenceConstructor$1,SyncPoint=function(){function SyncPoint(){this.views=new Map}Object.defineProperty(SyncPoint,"__referenceConstructor",{get:function(){util.assert(__referenceConstructor$1,"Reference.ts has not been loaded");return __referenceConstructor$1},set:function(val){util.assert(!__referenceConstructor$1,"__referenceConstructor has already been defined");__referenceConstructor$1=val},enumerable:!1,
configurable:!0});SyncPoint.prototype.isEmpty=function(){return 0===this.views.size};SyncPoint.prototype.applyOperation=function(operation,writesCache,optCompleteServerCache){var _a,queryId=operation.source.queryId;if(null!==queryId){var view=this.views.get(queryId);util.assert(null!=view,"SyncTree gave us an op for an invalid query.");return view.applyOperation(operation,writesCache,optCompleteServerCache)}queryId=[];try{for(var _b=tslib.__values(this.views.values()),_c=_b.next();!_c.done;_c=_b.next())view=
_c.value,queryId=queryId.concat(view.applyOperation(operation,writesCache,optCompleteServerCache))}catch(e_1_1){var e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error;}}return queryId};SyncPoint.prototype.addEventRegistration=function(query,eventRegistration,writesCache,serverCache,serverCacheComplete){var queryId=query.queryIdentifier(),view=this.views.get(queryId);view||((view=writesCache.calcCompleteEventCache(serverCacheComplete?serverCache:
null))?writesCache=!0:(view=serverCache instanceof ChildrenNode?writesCache.calcCompleteEventChildren(serverCache):ChildrenNode.EMPTY_NODE,writesCache=!1),serverCache=new ViewCache(new CacheNode(view,writesCache,!1),new CacheNode(serverCache,serverCacheComplete,!1)),view=new View(query,serverCache),this.views.set(queryId,view));view.addEventRegistration(eventRegistration);return view.getInitialEvents(eventRegistration)};SyncPoint.prototype.removeEventRegistration=function(query,eventRegistration,
cancelError){var _a,queryId=query.queryIdentifier(),removed=[],cancelEvents=[],hadCompleteView=this.hasCompleteView();if("default"===queryId)try{for(var _b=tslib.__values(this.views.entries()),_c=_b.next();!_c.done;_c=_b.next()){var _d=tslib.__read(_c.value,2),viewQueryId=_d[0],view=_d[1];cancelEvents=cancelEvents.concat(view.removeEventRegistration(eventRegistration,cancelError));view.isEmpty()&&(this.views.delete(viewQueryId),view.getQuery().getQueryParams().loadsAllData()||removed.push(view.getQuery()))}}catch(e_2_1){var e_2=
{error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error;}}else if(view=this.views.get(queryId))cancelEvents=cancelEvents.concat(view.removeEventRegistration(eventRegistration,cancelError)),view.isEmpty()&&(this.views.delete(queryId),view.getQuery().getQueryParams().loadsAllData()||removed.push(view.getQuery()));hadCompleteView&&!this.hasCompleteView()&&removed.push(new SyncPoint.__referenceConstructor(query.repo,query.path));return{removed:removed,events:cancelEvents}};
SyncPoint.prototype.getQueryViews=function(){var _a,result=[];try{for(var _b=tslib.__values(this.views.values()),_c=_b.next();!_c.done;_c=_b.next()){var view=_c.value;view.getQuery().getQueryParams().loadsAllData()||result.push(view)}}catch(e_3_1){var e_3={error:e_3_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_3)throw e_3.error;}}return result};SyncPoint.prototype.getCompleteServerCache=function(path){var _a,serverCache=null;try{for(var _b=tslib.__values(this.views.values()),
_c=_b.next();!_c.done;_c=_b.next()){var view=_c.value;serverCache=serverCache||view.getCompleteServerCache(path)}}catch(e_4_1){var e_4={error:e_4_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_4)throw e_4.error;}}return serverCache};SyncPoint.prototype.viewForQuery=function(query){if(query.getQueryParams().loadsAllData())return this.getCompleteView();query=query.queryIdentifier();return this.views.get(query)};SyncPoint.prototype.viewExistsForQuery=function(query){return null!=
this.viewForQuery(query)};SyncPoint.prototype.hasCompleteView=function(){return null!=this.getCompleteView()};SyncPoint.prototype.getCompleteView=function(){var _a;try{for(var _b=tslib.__values(this.views.values()),_c=_b.next();!_c.done;_c=_b.next()){var view=_c.value;if(view.getQuery().getQueryParams().loadsAllData())return view}}catch(e_5_1){var e_5={error:e_5_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_5)throw e_5.error;}}return null};return SyncPoint}(),CompoundWrite=
function(){function CompoundWrite(writeTree_){this.writeTree_=writeTree_}CompoundWrite.prototype.addWrite=function(path,node){if(path.isEmpty())return new CompoundWrite(new ImmutableTree(node));var rootmost=this.writeTree_.findRootMostValueAndPath(path);if(null!=rootmost){var rootMostPath=rootmost.path;rootmost=rootmost.value;path=Path.relativePath(rootMostPath,path);rootmost=rootmost.updateChild(path,node);return new CompoundWrite(this.writeTree_.set(rootMostPath,rootmost))}node=new ImmutableTree(node);
path=this.writeTree_.setTree(path,node);return new CompoundWrite(path)};CompoundWrite.prototype.addWrites=function(path,updates){var newWrite=this;each(updates,function(childKey,node){newWrite=newWrite.addWrite(path.child(childKey),node)});return newWrite};CompoundWrite.prototype.removeWrite=function(path){if(path.isEmpty())return CompoundWrite.Empty;path=this.writeTree_.setTree(path,ImmutableTree.Empty);return new CompoundWrite(path)};CompoundWrite.prototype.hasCompleteWrite=function(path){return null!=
this.getCompleteNode(path)};CompoundWrite.prototype.getCompleteNode=function(path){var rootmost=this.writeTree_.findRootMostValueAndPath(path);return null!=rootmost?this.writeTree_.get(rootmost.path).getChild(Path.relativePath(rootmost.path,path)):null};CompoundWrite.prototype.getCompleteChildren=function(){var children=[],node=this.writeTree_.value;null!=node?node.isLeafNode()||node.forEachChild(PRIORITY_INDEX,function(childName,childNode){children.push(new NamedNode(childName,childNode))}):this.writeTree_.children.inorderTraversal(function(childName,
childTree){null!=childTree.value&&children.push(new NamedNode(childName,childTree.value))});return children};CompoundWrite.prototype.childCompoundWrite=function(path){if(path.isEmpty())return this;var shadowingNode=this.getCompleteNode(path);return null!=shadowingNode?new CompoundWrite(new ImmutableTree(shadowingNode)):new CompoundWrite(this.writeTree_.subtree(path))};CompoundWrite.prototype.isEmpty=function(){return this.writeTree_.isEmpty()};CompoundWrite.prototype.apply=function(node){return applySubtreeWrite(Path.Empty,
this.writeTree_,node)};CompoundWrite.Empty=new CompoundWrite(new ImmutableTree(null));return CompoundWrite}(),WriteTree=function(){function WriteTree(){this.visibleWrites_=CompoundWrite.Empty;this.allWrites_=[];this.lastWriteId_=-1}WriteTree.prototype.childWrites=function(path){return new WriteTreeRef(path,this)};WriteTree.prototype.addOverwrite=function(path,snap,writeId,visible){util.assert(writeId>this.lastWriteId_,"Stacking an older write on top of newer ones");void 0===visible&&(visible=!0);
this.allWrites_.push({path:path,snap:snap,writeId:writeId,visible:visible});visible&&(this.visibleWrites_=this.visibleWrites_.addWrite(path,snap));this.lastWriteId_=writeId};WriteTree.prototype.addMerge=function(path,changedChildren,writeId){util.assert(writeId>this.lastWriteId_,"Stacking an older merge on top of newer ones");this.allWrites_.push({path:path,children:changedChildren,writeId:writeId,visible:!0});this.visibleWrites_=this.visibleWrites_.addWrites(path,changedChildren);this.lastWriteId_=
writeId};WriteTree.prototype.getWrite=function(writeId){for(var i=0;i<this.allWrites_.length;i++){var record=this.allWrites_[i];if(record.writeId===writeId)return record}return null};WriteTree.prototype.removeWrite=function(writeId){var _this=this,idx=this.allWrites_.findIndex(function(s){return s.writeId===writeId});util.assert(0<=idx,"removeWrite called with nonexistent writeId.");var writeToRemove=this.allWrites_[idx];this.allWrites_.splice(idx,1);for(var removedWriteWasVisible=writeToRemove.visible,
removedWriteOverlapsWithOtherWrites=!1,i=this.allWrites_.length-1;removedWriteWasVisible&&0<=i;){var currentWrite=this.allWrites_[i];currentWrite.visible&&(i>=idx&&this.recordContainsPath_(currentWrite,writeToRemove.path)?removedWriteWasVisible=!1:writeToRemove.path.contains(currentWrite.path)&&(removedWriteOverlapsWithOtherWrites=!0));i--}return removedWriteWasVisible?(removedWriteOverlapsWithOtherWrites?this.resetTree_():writeToRemove.snap?this.visibleWrites_=this.visibleWrites_.removeWrite(writeToRemove.path):
each(writeToRemove.children,function(childName){_this.visibleWrites_=_this.visibleWrites_.removeWrite(writeToRemove.path.child(childName))}),!0):!1};WriteTree.prototype.getCompleteWriteData=function(path){return this.visibleWrites_.getCompleteNode(path)};WriteTree.prototype.calcCompleteEventCache=function(treePath,completeServerCache,writeIdsToExclude,includeHiddenWrites){if(writeIdsToExclude||includeHiddenWrites){var merge=this.visibleWrites_.childCompoundWrite(treePath);return!includeHiddenWrites&&
merge.isEmpty()?completeServerCache:includeHiddenWrites||null!=completeServerCache||merge.hasCompleteWrite(Path.Empty)?(merge=WriteTree.layerTree_(this.allWrites_,function(write){return(write.visible||includeHiddenWrites)&&(!writeIdsToExclude||!~writeIdsToExclude.indexOf(write.writeId))&&(write.path.contains(treePath)||treePath.contains(write.path))},treePath),completeServerCache=completeServerCache||ChildrenNode.EMPTY_NODE,merge.apply(completeServerCache)):null}merge=this.visibleWrites_.getCompleteNode(treePath);
if(null!=merge)return merge;merge=this.visibleWrites_.childCompoundWrite(treePath);return merge.isEmpty()?completeServerCache:null!=completeServerCache||merge.hasCompleteWrite(Path.Empty)?(completeServerCache=completeServerCache||ChildrenNode.EMPTY_NODE,merge.apply(completeServerCache)):null};WriteTree.prototype.calcCompleteEventChildren=function(treePath,completeServerChildren){var completeChildren=ChildrenNode.EMPTY_NODE,topLevelSet=this.visibleWrites_.getCompleteNode(treePath);if(topLevelSet)topLevelSet.isLeafNode()||
topLevelSet.forEachChild(PRIORITY_INDEX,function(childName,childSnap){completeChildren=completeChildren.updateImmediateChild(childName,childSnap)});else if(completeServerChildren){var merge_1=this.visibleWrites_.childCompoundWrite(treePath);completeServerChildren.forEachChild(PRIORITY_INDEX,function(childName,childNode){childNode=merge_1.childCompoundWrite(new Path(childName)).apply(childNode);completeChildren=completeChildren.updateImmediateChild(childName,childNode)});merge_1.getCompleteChildren().forEach(function(namedNode){completeChildren=
completeChildren.updateImmediateChild(namedNode.name,namedNode.node)})}else this.visibleWrites_.childCompoundWrite(treePath).getCompleteChildren().forEach(function(namedNode){completeChildren=completeChildren.updateImmediateChild(namedNode.name,namedNode.node)});return completeChildren};WriteTree.prototype.calcEventCacheAfterServerOverwrite=function(treePath,childPath,existingEventSnap,existingServerSnap){util.assert(existingEventSnap||existingServerSnap,"Either existingEventSnap or existingServerSnap must exist");
treePath=treePath.child(childPath);if(this.visibleWrites_.hasCompleteWrite(treePath))return null;treePath=this.visibleWrites_.childCompoundWrite(treePath);return treePath.isEmpty()?existingServerSnap.getChild(childPath):treePath.apply(existingServerSnap.getChild(childPath))};WriteTree.prototype.calcCompleteChild=function(treePath,childKey,existingServerSnap){treePath=treePath.child(childKey);var shadowingNode=this.visibleWrites_.getCompleteNode(treePath);return null!=shadowingNode?shadowingNode:existingServerSnap.isCompleteForChild(childKey)?
this.visibleWrites_.childCompoundWrite(treePath).apply(existingServerSnap.getNode().getImmediateChild(childKey)):null};WriteTree.prototype.shadowingWrite=function(path){return this.visibleWrites_.getCompleteNode(path)};WriteTree.prototype.calcIndexedSlice=function(treePath,completeServerData,startPost,count,reverse,index){treePath=this.visibleWrites_.childCompoundWrite(treePath);var toIterate=treePath.getCompleteNode(Path.Empty);if(null==toIterate)if(null!=completeServerData)toIterate=treePath.apply(completeServerData);
else return[];toIterate=toIterate.withIndex(index);if(toIterate.isEmpty()||toIterate.isLeafNode())return[];completeServerData=[];treePath=index.getCompare();reverse=reverse?toIterate.getReverseIteratorFrom(startPost,index):toIterate.getIteratorFrom(startPost,index);for(index=reverse.getNext();index&&completeServerData.length<count;)0!==treePath(index,startPost)&&completeServerData.push(index),index=reverse.getNext();return completeServerData};WriteTree.prototype.recordContainsPath_=function(writeRecord,
path){if(writeRecord.snap)return writeRecord.path.contains(path);for(var childName in writeRecord.children)if(writeRecord.children.hasOwnProperty(childName)&&writeRecord.path.child(childName).contains(path))return!0;return!1};WriteTree.prototype.resetTree_=function(){this.visibleWrites_=WriteTree.layerTree_(this.allWrites_,WriteTree.DefaultFilter_,Path.Empty);this.lastWriteId_=0<this.allWrites_.length?this.allWrites_[this.allWrites_.length-1].writeId:-1};WriteTree.DefaultFilter_=function(write){return write.visible};
WriteTree.layerTree_=function(writes,filter,treeRoot){for(var compoundWrite=CompoundWrite.Empty,i=0;i<writes.length;++i){var write=writes[i];if(filter(write)){var writePath=write.path;if(write.snap)treeRoot.contains(writePath)?(writePath=Path.relativePath(treeRoot,writePath),compoundWrite=compoundWrite.addWrite(writePath,write.snap)):writePath.contains(treeRoot)&&(writePath=Path.relativePath(writePath,treeRoot),compoundWrite=compoundWrite.addWrite(Path.Empty,write.snap.getChild(writePath)));else if(write.children)if(treeRoot.contains(writePath))writePath=
Path.relativePath(treeRoot,writePath),compoundWrite=compoundWrite.addWrites(writePath,write.children);else{if(writePath.contains(treeRoot))if(writePath=Path.relativePath(writePath,treeRoot),writePath.isEmpty())compoundWrite=compoundWrite.addWrites(Path.Empty,write.children);else if(write=util.safeGet(write.children,writePath.getFront()))write=write.getChild(writePath.popFront()),compoundWrite=compoundWrite.addWrite(Path.Empty,write)}else throw util.assertionError("WriteRecord should have .snap or .children");
}}return compoundWrite};return WriteTree}(),WriteTreeRef=function(){function WriteTreeRef(path,writeTree){this.treePath_=path;this.writeTree_=writeTree}WriteTreeRef.prototype.calcCompleteEventCache=function(completeServerCache,writeIdsToExclude,includeHiddenWrites){return this.writeTree_.calcCompleteEventCache(this.treePath_,completeServerCache,writeIdsToExclude,includeHiddenWrites)};WriteTreeRef.prototype.calcCompleteEventChildren=function(completeServerChildren){return this.writeTree_.calcCompleteEventChildren(this.treePath_,
completeServerChildren)};WriteTreeRef.prototype.calcEventCacheAfterServerOverwrite=function(path,existingEventSnap,existingServerSnap){return this.writeTree_.calcEventCacheAfterServerOverwrite(this.treePath_,path,existingEventSnap,existingServerSnap)};WriteTreeRef.prototype.shadowingWrite=function(path){return this.writeTree_.shadowingWrite(this.treePath_.child(path))};WriteTreeRef.prototype.calcIndexedSlice=function(completeServerData,startPost,count,reverse,index){return this.writeTree_.calcIndexedSlice(this.treePath_,
completeServerData,startPost,count,reverse,index)};WriteTreeRef.prototype.calcCompleteChild=function(childKey,existingServerCache){return this.writeTree_.calcCompleteChild(this.treePath_,childKey,existingServerCache)};WriteTreeRef.prototype.child=function(childName){return new WriteTreeRef(this.treePath_.child(childName),this.writeTree_)};return WriteTreeRef}(),SyncTree=function(){function SyncTree(listenProvider_){this.listenProvider_=listenProvider_;this.syncPointTree_=ImmutableTree.Empty;this.pendingWriteTree_=
new WriteTree;this.tagToQueryMap=new Map;this.queryToTagMap=new Map}SyncTree.prototype.applyUserOverwrite=function(path,newData,writeId,visible){this.pendingWriteTree_.addOverwrite(path,newData,writeId,visible);return visible?this.applyOperationToSyncPoints_(new Overwrite(OperationSource.User,path,newData)):[]};SyncTree.prototype.applyUserMerge=function(path,changedChildren,writeId){this.pendingWriteTree_.addMerge(path,changedChildren,writeId);changedChildren=ImmutableTree.fromObject(changedChildren);
return this.applyOperationToSyncPoints_(new Merge(OperationSource.User,path,changedChildren))};SyncTree.prototype.ackUserWrite=function(writeId,revert){void 0===revert&&(revert=!1);var write=this.pendingWriteTree_.getWrite(writeId);if(this.pendingWriteTree_.removeWrite(writeId)){var affectedTree_1=ImmutableTree.Empty;null!=write.snap?affectedTree_1=affectedTree_1.set(Path.Empty,!0):each(write.children,function(pathString,node){affectedTree_1=affectedTree_1.set(new Path(pathString),node)});return this.applyOperationToSyncPoints_(new AckUserWrite(write.path,
affectedTree_1,revert))}return[]};SyncTree.prototype.applyServerOverwrite=function(path,newData){return this.applyOperationToSyncPoints_(new Overwrite(OperationSource.Server,path,newData))};SyncTree.prototype.applyServerMerge=function(path,changedChildren){changedChildren=ImmutableTree.fromObject(changedChildren);return this.applyOperationToSyncPoints_(new Merge(OperationSource.Server,path,changedChildren))};SyncTree.prototype.applyListenComplete=function(path){return this.applyOperationToSyncPoints_(new ListenComplete(OperationSource.Server,
path))};SyncTree.prototype.applyTaggedQueryOverwrite=function(path,snap,tag){tag=this.queryKeyForTag_(tag);if(null!=tag){var r=SyncTree.parseQueryKey_(tag);tag=r.path;r=r.queryId;path=Path.relativePath(tag,path);snap=new Overwrite(OperationSource.forServerTaggedQuery(r),path,snap);return this.applyTaggedOperation_(tag,snap)}return[]};SyncTree.prototype.applyTaggedQueryMerge=function(path,changedChildren,tag){if(tag=this.queryKeyForTag_(tag)){var r=SyncTree.parseQueryKey_(tag);tag=r.path;r=r.queryId;
path=Path.relativePath(tag,path);changedChildren=ImmutableTree.fromObject(changedChildren);changedChildren=new Merge(OperationSource.forServerTaggedQuery(r),path,changedChildren);return this.applyTaggedOperation_(tag,changedChildren)}return[]};SyncTree.prototype.applyTaggedListenComplete=function(path,tag){if(tag=this.queryKeyForTag_(tag)){var r=SyncTree.parseQueryKey_(tag);tag=r.path;r=r.queryId;path=Path.relativePath(tag,path);path=new ListenComplete(OperationSource.forServerTaggedQuery(r),path);
return this.applyTaggedOperation_(tag,path)}return[]};SyncTree.prototype.addEventRegistration=function(query,eventRegistration){var path=query.path,serverCache=null,foundAncestorDefaultView=!1;this.syncPointTree_.foreachOnPath(path,function(pathToSyncPoint,sp){pathToSyncPoint=Path.relativePath(pathToSyncPoint,path);serverCache=serverCache||sp.getCompleteServerCache(pathToSyncPoint);foundAncestorDefaultView=foundAncestorDefaultView||sp.hasCompleteView()});var syncPoint=this.syncPointTree_.get(path);
syncPoint?(foundAncestorDefaultView=foundAncestorDefaultView||syncPoint.hasCompleteView(),serverCache=serverCache||syncPoint.getCompleteServerCache(Path.Empty)):(syncPoint=new SyncPoint,this.syncPointTree_=this.syncPointTree_.set(path,syncPoint));if(null!=serverCache)var serverCacheComplete=!0;else serverCacheComplete=!1,serverCache=ChildrenNode.EMPTY_NODE,this.syncPointTree_.subtree(path).foreachChild(function(childName,childSyncPoint){(childSyncPoint=childSyncPoint.getCompleteServerCache(Path.Empty))&&
(serverCache=serverCache.updateImmediateChild(childName,childSyncPoint))});var viewAlreadyExists=syncPoint.viewExistsForQuery(query);if(!viewAlreadyExists&&!query.getQueryParams().loadsAllData()){var queryKey=SyncTree.makeQueryKey_(query);util.assert(!this.queryToTagMap.has(queryKey),"View does not exist, but we have a tag");var tag=SyncTree.getNextQueryTag_();this.queryToTagMap.set(queryKey,tag);this.tagToQueryMap.set(tag,queryKey)}queryKey=this.pendingWriteTree_.childWrites(path);eventRegistration=
syncPoint.addEventRegistration(query,eventRegistration,queryKey,serverCache,serverCacheComplete);viewAlreadyExists||foundAncestorDefaultView||(syncPoint=syncPoint.viewForQuery(query),eventRegistration=eventRegistration.concat(this.setupListener_(query,syncPoint)));return eventRegistration};SyncTree.prototype.removeEventRegistration=function(query$jscomp$0,eventRegistration,cancelError){var _this=this,path=query$jscomp$0.path,maybeSyncPoint=this.syncPointTree_.get(path),cancelEvents=[];if(maybeSyncPoint&&
("default"===query$jscomp$0.queryIdentifier()||maybeSyncPoint.viewExistsForQuery(query$jscomp$0))){cancelEvents=maybeSyncPoint.removeEventRegistration(query$jscomp$0,eventRegistration,cancelError);maybeSyncPoint.isEmpty()&&(this.syncPointTree_=this.syncPointTree_.remove(path));maybeSyncPoint=cancelEvents.removed;cancelEvents=cancelEvents.events;eventRegistration=-1!==maybeSyncPoint.findIndex(function(query){return query.getQueryParams().loadsAllData()});var covered=this.syncPointTree_.findOnPath(path,
function(relativePath,parentSyncPoint){return parentSyncPoint.hasCompleteView()});if(eventRegistration&&!covered&&(path=this.syncPointTree_.subtree(path),!path.isEmpty())){path=this.collectDistinctViewsForSubTree_(path);for(var i=0;i<path.length;++i){var view=path[i],newQuery=view.getQuery();view=this.createListenerForView_(view);this.listenProvider_.startListening(SyncTree.queryForListening_(newQuery),this.tagForQuery_(newQuery),view.hashFn,view.onComplete)}}!covered&&0<maybeSyncPoint.length&&!cancelError&&
(eventRegistration?this.listenProvider_.stopListening(SyncTree.queryForListening_(query$jscomp$0),null):maybeSyncPoint.forEach(function(queryToRemove){var tagToRemove=_this.queryToTagMap.get(SyncTree.makeQueryKey_(queryToRemove));_this.listenProvider_.stopListening(SyncTree.queryForListening_(queryToRemove),tagToRemove)}));this.removeTags_(maybeSyncPoint)}return cancelEvents};SyncTree.prototype.calcCompleteEventCache=function(path,writeIdsToExclude){var writeTree=this.pendingWriteTree_,serverCache=
this.syncPointTree_.findOnPath(path,function(pathSoFar,syncPoint){pathSoFar=Path.relativePath(pathSoFar,path);if(syncPoint=syncPoint.getCompleteServerCache(pathSoFar))return syncPoint});return writeTree.calcCompleteEventCache(path,serverCache,writeIdsToExclude,!0)};SyncTree.prototype.collectDistinctViewsForSubTree_=function(subtree){return subtree.fold(function(relativePath,maybeChildSyncPoint,childMap){if(maybeChildSyncPoint&&maybeChildSyncPoint.hasCompleteView())return[maybeChildSyncPoint.getCompleteView()];
var views_1=[];maybeChildSyncPoint&&(views_1=maybeChildSyncPoint.getQueryViews());each(childMap,function(_key,childViews){views_1=views_1.concat(childViews)});return views_1})};SyncTree.prototype.removeTags_=function(queries){for(var j=0;j<queries.length;++j){var removedQuery=queries[j];if(!removedQuery.getQueryParams().loadsAllData()){removedQuery=SyncTree.makeQueryKey_(removedQuery);var removedQueryTag=this.queryToTagMap.get(removedQuery);this.queryToTagMap.delete(removedQuery);this.tagToQueryMap.delete(removedQueryTag)}}};
SyncTree.queryForListening_=function(query){return query.getQueryParams().loadsAllData()&&!query.getQueryParams().isDefault()?query.getRef():query};SyncTree.prototype.setupListener_=function(query,view$jscomp$0){var path=query.path,tag=this.tagForQuery_(query);view$jscomp$0=this.createListenerForView_(view$jscomp$0);query=this.listenProvider_.startListening(SyncTree.queryForListening_(query),tag,view$jscomp$0.hashFn,view$jscomp$0.onComplete);path=this.syncPointTree_.subtree(path);if(tag)util.assert(!path.value.hasCompleteView(),
"If we're adding a query, it shouldn't be shadowed");else for(tag=path.fold(function(relativePath,maybeChildSyncPoint,childMap){if(!relativePath.isEmpty()&&maybeChildSyncPoint&&maybeChildSyncPoint.hasCompleteView())return[maybeChildSyncPoint.getCompleteView().getQuery()];var queries_1=[];maybeChildSyncPoint&&(queries_1=queries_1.concat(maybeChildSyncPoint.getQueryViews().map(function(view){return view.getQuery()})));each(childMap,function(_key,childQueries){queries_1=queries_1.concat(childQueries)});
return queries_1}),path=0;path<tag.length;++path)view$jscomp$0=tag[path],this.listenProvider_.stopListening(SyncTree.queryForListening_(view$jscomp$0),this.tagForQuery_(view$jscomp$0));return query};SyncTree.prototype.createListenerForView_=function(view){var _this=this,query=view.getQuery(),tag=this.tagForQuery_(query);return{hashFn:function(){return(view.getServerCache()||ChildrenNode.EMPTY_NODE).hash()},onComplete:function(status){if("ok"===status)return tag?_this.applyTaggedListenComplete(query.path,
tag):_this.applyListenComplete(query.path);var reason="Unknown Error";"too_big"===status?reason="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===status?reason="Client doesn't have permission to access the desired data.":"unavailable"===status&&(reason="The service is unavailable");reason=Error(status+" at "+query.path.toString()+": "+reason);reason.code=status.toUpperCase();return _this.removeEventRegistration(query,null,reason)}}};SyncTree.makeQueryKey_=
function(query){return query.path.toString()+"$"+query.queryIdentifier()};SyncTree.parseQueryKey_=function(queryKey){var splitIndex=queryKey.indexOf("$");util.assert(-1!==splitIndex&&splitIndex<queryKey.length-1,"Bad queryKey.");return{queryId:queryKey.substr(splitIndex+1),path:new Path(queryKey.substr(0,splitIndex))}};SyncTree.prototype.queryKeyForTag_=function(tag){return this.tagToQueryMap.get(tag)};SyncTree.prototype.tagForQuery_=function(query){query=SyncTree.makeQueryKey_(query);return this.queryToTagMap.get(query)};
SyncTree.getNextQueryTag_=function(){return SyncTree.nextQueryTag_++};SyncTree.prototype.applyTaggedOperation_=function(queryPath,operation){var syncPoint=this.syncPointTree_.get(queryPath);util.assert(syncPoint,"Missing sync point for query tag that we're tracking");queryPath=this.pendingWriteTree_.childWrites(queryPath);return syncPoint.applyOperation(operation,queryPath,null)};SyncTree.prototype.applyOperationToSyncPoints_=function(operation){return this.applyOperationHelper_(operation,this.syncPointTree_,
null,this.pendingWriteTree_.childWrites(Path.Empty))};SyncTree.prototype.applyOperationHelper_=function(operation,syncPointTree,serverCache,writesCache){if(operation.path.isEmpty())return this.applyOperationDescendantsHelper_(operation,syncPointTree,serverCache,writesCache);var syncPoint=syncPointTree.get(Path.Empty);null==serverCache&&null!=syncPoint&&(serverCache=syncPoint.getCompleteServerCache(Path.Empty));var events=[],childName=operation.path.getFront(),childOperation=operation.operationForChild(childName);
if((syncPointTree=syncPointTree.children.get(childName))&&childOperation){var childServerCache=serverCache?serverCache.getImmediateChild(childName):null;childName=writesCache.child(childName);events=events.concat(this.applyOperationHelper_(childOperation,syncPointTree,childServerCache,childName))}syncPoint&&(events=events.concat(syncPoint.applyOperation(operation,writesCache,serverCache)));return events};SyncTree.prototype.applyOperationDescendantsHelper_=function(operation,syncPointTree,serverCache,
writesCache){var _this=this,syncPoint=syncPointTree.get(Path.Empty);null==serverCache&&null!=syncPoint&&(serverCache=syncPoint.getCompleteServerCache(Path.Empty));var events=[];syncPointTree.children.inorderTraversal(function(childName,childTree){var childServerCache=serverCache?serverCache.getImmediateChild(childName):null,childWritesCache=writesCache.child(childName);(childName=operation.operationForChild(childName))&&(events=events.concat(_this.applyOperationDescendantsHelper_(childName,childTree,
childServerCache,childWritesCache)))});syncPoint&&(events=events.concat(syncPoint.applyOperation(operation,writesCache,serverCache)));return events};SyncTree.nextQueryTag_=1;return SyncTree}(),SnapshotHolder=function(){function SnapshotHolder(){this.rootNode_=ChildrenNode.EMPTY_NODE}SnapshotHolder.prototype.getNode=function(path){return this.rootNode_.getChild(path)};SnapshotHolder.prototype.updateSnapshot=function(path,newSnapshotNode){this.rootNode_=this.rootNode_.updateChild(path,newSnapshotNode)};
return SnapshotHolder}(),StatsCollection=function(){function StatsCollection(){this.counters_={}}StatsCollection.prototype.incrementCounter=function(name,amount){void 0===amount&&(amount=1);util.contains(this.counters_,name)||(this.counters_[name]=0);this.counters_[name]+=amount};StatsCollection.prototype.get=function(){return util.deepCopy(this.counters_)};return StatsCollection}(),StatsManager=function(){function StatsManager(){}StatsManager.getCollection=function(repoInfo){repoInfo=repoInfo.toString();
this.collections_[repoInfo]||(this.collections_[repoInfo]=new StatsCollection);return this.collections_[repoInfo]};StatsManager.getOrCreateReporter=function(repoInfo,creatorFunction){repoInfo=repoInfo.toString();this.reporters_[repoInfo]||(this.reporters_[repoInfo]=creatorFunction());return this.reporters_[repoInfo]};StatsManager.collections_={};StatsManager.reporters_={};return StatsManager}(),StatsListener=function(){function StatsListener(collection_){this.collection_=collection_;this.last_=null}
StatsListener.prototype.get=function(){var newStats=this.collection_.get(),delta=tslib.__assign({},newStats);this.last_&&each(this.last_,function(stat,value){delta[stat]-=value});this.last_=newStats;return delta};return StatsListener}(),StatsReporter=function(){function StatsReporter(collection,server_){this.server_=server_;this.statsToReport_={};this.statsListener_=new StatsListener(collection);collection=1E4+2E4*Math.random();setTimeoutNonBlocking(this.reportStats_.bind(this),Math.floor(collection))}
StatsReporter.prototype.includeStat=function(stat){this.statsToReport_[stat]=!0};StatsReporter.prototype.reportStats_=function(){var _this=this,stats=this.statsListener_.get(),reportedStats={},haveStatsToReport=!1;each(stats,function(stat,value){0<value&&util.contains(_this.statsToReport_,stat)&&(reportedStats[stat]=value,haveStatsToReport=!0)});haveStatsToReport&&this.server_.reportStats(reportedStats);setTimeoutNonBlocking(this.reportStats_.bind(this),Math.floor(6E5*Math.random()))};return StatsReporter}(),
EventQueue=function(){function EventQueue(){this.eventLists_=[];this.recursionDepth_=0}EventQueue.prototype.queueEvents=function(eventDataList){for(var currList=null,i=0;i<eventDataList.length;i++){var eventData=eventDataList[i],eventPath=eventData.getPath();null===currList||eventPath.equals(currList.getPath())||(this.eventLists_.push(currList),currList=null);null===currList&&(currList=new EventList(eventPath));currList.add(eventData)}currList&&this.eventLists_.push(currList)};EventQueue.prototype.raiseEventsAtPath=
function(path,eventDataList){this.queueEvents(eventDataList);this.raiseQueuedEventsMatchingPredicate_(function(eventPath){return eventPath.equals(path)})};EventQueue.prototype.raiseEventsForChangedPath=function(changedPath,eventDataList){this.queueEvents(eventDataList);this.raiseQueuedEventsMatchingPredicate_(function(eventPath){return eventPath.contains(changedPath)||changedPath.contains(eventPath)})};EventQueue.prototype.raiseQueuedEventsMatchingPredicate_=function(predicate){this.recursionDepth_++;
for(var sentAll=!0,i=0;i<this.eventLists_.length;i++){var eventList=this.eventLists_[i];eventList&&(eventList=eventList.getPath(),predicate(eventList)?(this.eventLists_[i].raise(),this.eventLists_[i]=null):sentAll=!1)}sentAll&&(this.eventLists_=[]);this.recursionDepth_--};return EventQueue}(),EventList=function(){function EventList(path_){this.path_=path_;this.events_=[]}EventList.prototype.add=function(eventData){this.events_.push(eventData)};EventList.prototype.raise=function(){for(var i=0;i<this.events_.length;i++){var eventData=
this.events_[i];if(null!==eventData){this.events_[i]=null;var eventFn=eventData.getEventRunner();logger&&log("event: "+eventData.toString());exceptionGuard(eventFn)}}};EventList.prototype.getPath=function(){return this.path_};return EventList}(),EventEmitter=function(){function EventEmitter(allowedEvents_){this.allowedEvents_=allowedEvents_;this.listeners_={};util.assert(Array.isArray(allowedEvents_)&&0<allowedEvents_.length,"Requires a non-empty array")}EventEmitter.prototype.trigger=function(eventType){for(var varArgs=
[],_i=1;_i<arguments.length;_i++)varArgs[_i-1]=arguments[_i];if(Array.isArray(this.listeners_[eventType])){_i=tslib.__spread(this.listeners_[eventType]);for(var i=0;i<_i.length;i++)_i[i].callback.apply(_i[i].context,varArgs)}};EventEmitter.prototype.on=function(eventType,callback,context){this.validateEventType_(eventType);this.listeners_[eventType]=this.listeners_[eventType]||[];this.listeners_[eventType].push({callback:callback,context:context});(eventType=this.getInitialEvent(eventType))&&callback.apply(context,
eventType)};EventEmitter.prototype.off=function(eventType,callback,context){this.validateEventType_(eventType);eventType=this.listeners_[eventType]||[];for(var i=0;i<eventType.length;i++)if(eventType[i].callback===callback&&(!context||context===eventType[i].context)){eventType.splice(i,1);break}};EventEmitter.prototype.validateEventType_=function(eventType){util.assert(this.allowedEvents_.find(function(et){return et===eventType}),"Unknown event: "+eventType)};return EventEmitter}(),VisibilityMonitor=
function(_super){function VisibilityMonitor(){var _this=_super.call(this,["visible"])||this;if("undefined"!==typeof document&&"undefined"!==typeof document.addEventListener)if("undefined"!==typeof document.hidden){var visibilityChange="visibilitychange";var hidden="hidden"}else"undefined"!==typeof document.mozHidden?(visibilityChange="mozvisibilitychange",hidden="mozHidden"):"undefined"!==typeof document.msHidden?(visibilityChange="msvisibilitychange",hidden="msHidden"):"undefined"!==typeof document.webkitHidden&&
(visibilityChange="webkitvisibilitychange",hidden="webkitHidden");_this.visible_=!0;visibilityChange&&document.addEventListener(visibilityChange,function(){var visible=!document[hidden];visible!==_this.visible_&&(_this.visible_=visible,_this.trigger("visible",visible))},!1);return _this}tslib.__extends(VisibilityMonitor,_super);VisibilityMonitor.getInstance=function(){return new VisibilityMonitor};VisibilityMonitor.prototype.getInitialEvent=function(eventType){util.assert("visible"===eventType,"Unknown event type: "+
eventType);return[this.visible_]};return VisibilityMonitor}(EventEmitter),OnlineMonitor=function(_super){function OnlineMonitor(){var _this=_super.call(this,["online"])||this;_this.online_=!0;"undefined"===typeof window||"undefined"===typeof window.addEventListener||util.isMobileCordova()||(window.addEventListener("online",function(){_this.online_||(_this.online_=!0,_this.trigger("online",!0))},!1),window.addEventListener("offline",function(){_this.online_&&(_this.online_=!1,_this.trigger("online",
!1))},!1));return _this}tslib.__extends(OnlineMonitor,_super);OnlineMonitor.getInstance=function(){return new OnlineMonitor};OnlineMonitor.prototype.getInitialEvent=function(eventType){util.assert("online"===eventType,"Unknown event type: "+eventType);return[this.online_]};OnlineMonitor.prototype.currentlyOnline=function(){return this.online_};return OnlineMonitor}(EventEmitter),PacketReceiver=function(){function PacketReceiver(onMessage_){this.onMessage_=onMessage_;this.pendingResponses=[];this.currentResponseNum=
0;this.closeAfterResponse=-1;this.onClose=null}PacketReceiver.prototype.closeAfter=function(responseNum,callback){this.closeAfterResponse=responseNum;this.onClose=callback;this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)};PacketReceiver.prototype.handleResponse=function(requestNum,data){var _this=this;this.pendingResponses[requestNum]=data;requestNum=function(){var toProcess=this_1.pendingResponses[this_1.currentResponseNum];delete this_1.pendingResponses[this_1.currentResponseNum];
for(var _loop_2=function(i){toProcess[i]&&exceptionGuard(function(){_this.onMessage_(toProcess[i])})},i$jscomp$0=0;i$jscomp$0<toProcess.length;++i$jscomp$0)_loop_2(i$jscomp$0);if(this_1.currentResponseNum===this_1.closeAfterResponse)return this_1.onClose&&(this_1.onClose(),this_1.onClose=null),"break";this_1.currentResponseNum++};for(var this_1=this;this.pendingResponses[this.currentResponseNum]&&"break"!==requestNum(););};return PacketReceiver}(),BrowserPollConnection=function(){function BrowserPollConnection(connId,
repoInfo,applicationId,transportSessionId,lastSessionId){this.connId=connId;this.repoInfo=repoInfo;this.applicationId=applicationId;this.transportSessionId=transportSessionId;this.lastSessionId=lastSessionId;this.bytesReceived=this.bytesSent=0;this.everConnected_=!1;this.log_=logWrapper(connId);this.stats_=StatsManager.getCollection(repoInfo);this.urlFn=function(params){return repoInfo.connectionURL("long_polling",params)}}BrowserPollConnection.prototype.open=function(onMessage,onDisconnect){var _this=
this;this.curSegmentNum=0;this.onDisconnect_=onDisconnect;this.myPacketOrderer=new PacketReceiver(onMessage);this.isClosed_=!1;this.connectTimeoutTimer_=setTimeout(function(){_this.log_("Timed out trying to connect.");_this.onClosed_();_this.connectTimeoutTimer_=null},3E4);executeWhenDOMReady(function(){if(!_this.isClosed_){_this.scriptTagHolder=new FirebaseIFrameScriptHolder(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var _a=tslib.__read(args,5);_i=_a[0];var arg1=
_a[1];_a=_a[2];_this.incrementIncomingBytes_(args);if(_this.scriptTagHolder)if(_this.connectTimeoutTimer_&&(clearTimeout(_this.connectTimeoutTimer_),_this.connectTimeoutTimer_=null),_this.everConnected_=!0,"start"===_i)_this.id=arg1,_this.password=_a;else if("close"===_i)if(arg1)_this.scriptTagHolder.sendNewPolls=!1,_this.myPacketOrderer.closeAfter(arg1,function(){_this.onClosed_()});else _this.onClosed_();else throw Error("Unrecognized command received: "+_i);},function(){for(var args=[],_i=0;_i<
arguments.length;_i++)args[_i]=arguments[_i];var _a=tslib.__read(args,2);_i=_a[0];_a=_a[1];_this.incrementIncomingBytes_(args);_this.myPacketOrderer.handleResponse(_i,_a)},function(){_this.onClosed_()},_this.urlFn);var urlParams={start:"t"};urlParams.ser=Math.floor(1E8*Math.random());_this.scriptTagHolder.uniqueCallbackIdentifier&&(urlParams.cb=_this.scriptTagHolder.uniqueCallbackIdentifier);urlParams.v="5";_this.transportSessionId&&(urlParams.s=_this.transportSessionId);_this.lastSessionId&&(urlParams.ls=
_this.lastSessionId);_this.applicationId&&(urlParams.p=_this.applicationId);"undefined"!==typeof location&&location.href&&-1!==location.href.indexOf("firebaseio.com")&&(urlParams.r="f");urlParams=_this.urlFn(urlParams);_this.log_("Connecting via long-poll to "+urlParams);_this.scriptTagHolder.addTag(urlParams,function(){})}})};BrowserPollConnection.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password);this.addDisconnectPingFrame(this.id,this.password)};BrowserPollConnection.forceAllow=
function(){BrowserPollConnection.forceAllow_=!0};BrowserPollConnection.forceDisallow=function(){BrowserPollConnection.forceDisallow_=!0};BrowserPollConnection.isAvailable=function(){return util.isNodeSdk()?!1:BrowserPollConnection.forceAllow_?!0:!BrowserPollConnection.forceDisallow_&&"undefined"!==typeof document&&null!=document.createElement&&!("object"===typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))&&!("object"===typeof Windows&&"object"===typeof Windows.UI)};
BrowserPollConnection.prototype.markConnectionHealthy=function(){};BrowserPollConnection.prototype.shutdown_=function(){this.isClosed_=!0;this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null);this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null);this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)};BrowserPollConnection.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),
this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))};BrowserPollConnection.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())};BrowserPollConnection.prototype.send=function(data){data=util.stringify(data);this.bytesSent+=data.length;this.stats_.incrementCounter("bytes_sent",data.length);data=util.base64Encode(data);data=splitStringBySize(data,1840);for(var i=0;i<data.length;i++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,
data.length,data[i]),this.curSegmentNum++};BrowserPollConnection.prototype.addDisconnectPingFrame=function(id,pw){if(!util.isNodeSdk()){this.myDisconnFrame=document.createElement("iframe");var urlParams={dframe:"t"};urlParams.id=id;urlParams.pw=pw;this.myDisconnFrame.src=this.urlFn(urlParams);this.myDisconnFrame.style.display="none";document.body.appendChild(this.myDisconnFrame)}};BrowserPollConnection.prototype.incrementIncomingBytes_=function(args){args=util.stringify(args).length;this.bytesReceived+=
args;this.stats_.incrementCounter("bytes_received",args)};return BrowserPollConnection}(),FirebaseIFrameScriptHolder=function(){function FirebaseIFrameScriptHolder(commandCB,onMessageCB,onDisconnect,urlFn){this.onDisconnect=onDisconnect;this.urlFn=urlFn;this.outstandingRequests=new Set;this.pendingSegs=[];this.currentSerial=Math.floor(1E8*Math.random());this.sendNewPolls=!0;if(util.isNodeSdk())this.commandCB=commandCB,this.onMessageCB=onMessageCB;else{this.uniqueCallbackIdentifier=LUIDGenerator();
window["pLPCommand"+this.uniqueCallbackIdentifier]=commandCB;window["pRTLPCB"+this.uniqueCallbackIdentifier]=onMessageCB;this.myIFrame=FirebaseIFrameScriptHolder.createIFrame_();commandCB="";this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)&&(commandCB='\x3cscript\x3edocument.domain\x3d"'+document.domain+'";\x3c/script\x3e');commandCB="\x3chtml\x3e\x3cbody\x3e"+commandCB+"\x3c/body\x3e\x3c/html\x3e";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(commandCB),this.myIFrame.doc.close()}catch(e){log("frame writing exception"),
e.stack&&log(e.stack),log(e)}}}FirebaseIFrameScriptHolder.createIFrame_=function(){var iframe=document.createElement("iframe");iframe.style.display="none";if(document.body){document.body.appendChild(iframe);try{iframe.contentWindow.document||log("No IE domain setting required")}catch(e){iframe.src="javascript:void((function(){document.open();document.domain\x3d'"+document.domain+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";
iframe.contentDocument?iframe.doc=iframe.contentDocument:iframe.contentWindow?iframe.doc=iframe.contentWindow.document:iframe.document&&(iframe.doc=iframe.document);return iframe};FirebaseIFrameScriptHolder.prototype.close=function(){var _this=this;this.alive=!1;this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout(function(){null!==_this.myIFrame&&(document.body.removeChild(_this.myIFrame),_this.myIFrame=null)},0));var onDisconnect=this.onDisconnect;onDisconnect&&(this.onDisconnect=null,
onDisconnect())};FirebaseIFrameScriptHolder.prototype.startLongPoll=function(id,pw){this.myID=id;this.myPW=pw;for(this.alive=!0;this.newRequest_(););};FirebaseIFrameScriptHolder.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(0<this.pendingSegs.length?2:1)){this.currentSerial++;var urlParams={};urlParams.id=this.myID;urlParams.pw=this.myPW;urlParams.ser=this.currentSerial;urlParams=this.urlFn(urlParams);for(var curDataString="",i=0;0<this.pendingSegs.length;)if(1870>=
this.pendingSegs[0].d.length+30+curDataString.length){var theSeg=this.pendingSegs.shift();curDataString=curDataString+"\x26seg"+i+"\x3d"+theSeg.seg+"\x26ts"+i+"\x3d"+theSeg.ts+"\x26d"+i+"\x3d"+theSeg.d;i++}else break;this.addLongPollTag_(urlParams+curDataString,this.currentSerial);return!0}return!1};FirebaseIFrameScriptHolder.prototype.enqueueSegment=function(segnum,totalsegs,data){this.pendingSegs.push({seg:segnum,ts:totalsegs,d:data});this.alive&&this.newRequest_()};FirebaseIFrameScriptHolder.prototype.addLongPollTag_=
function(url,serial){var _this=this;this.outstandingRequests.add(serial);var doNewRequest=function(){_this.outstandingRequests.delete(serial);_this.newRequest_()},keepaliveTimeout=setTimeout(doNewRequest,25E3);this.addTag(url,function(){clearTimeout(keepaliveTimeout);doNewRequest()})};FirebaseIFrameScriptHolder.prototype.addTag=function(url,loadCB){var _this=this;util.isNodeSdk()?this.doNodeLongPoll(url,loadCB):setTimeout(function(){try{if(_this.sendNewPolls){var newScript_1=_this.myIFrame.doc.createElement("script");
newScript_1.type="text/javascript";newScript_1.async=!0;newScript_1.src=url;newScript_1.onload=newScript_1.onreadystatechange=function(){var rstate=newScript_1.readyState;rstate&&"loaded"!==rstate&&"complete"!==rstate||(newScript_1.onload=newScript_1.onreadystatechange=null,newScript_1.parentNode&&newScript_1.parentNode.removeChild(newScript_1),loadCB())};newScript_1.onerror=function(){log("Long-poll script failed to load: "+url);_this.sendNewPolls=!1;_this.close()};_this.myIFrame.doc.body.appendChild(newScript_1)}}catch(e){}},
1)};return FirebaseIFrameScriptHolder}(),SDK_VERSION="",WebSocketImpl=null;"undefined"!==typeof MozWebSocket?WebSocketImpl=MozWebSocket:"undefined"!==typeof WebSocket&&(WebSocketImpl=WebSocket);var WebSocketConnection=function(){function WebSocketConnection(connId,repoInfo,applicationId,transportSessionId,lastSessionId){this.connId=connId;this.applicationId=applicationId;this.frames=this.keepaliveTimer=null;this.bytesReceived=this.bytesSent=this.totalFrames=0;this.log_=logWrapper(this.connId);this.stats_=
StatsManager.getCollection(repoInfo);this.connURL=WebSocketConnection.connectionURL_(repoInfo,transportSessionId,lastSessionId)}WebSocketConnection.connectionURL_=function(repoInfo,transportSessionId,lastSessionId){var urlParams={v:"5"};!util.isNodeSdk()&&"undefined"!==typeof location&&location.href&&-1!==location.href.indexOf("firebaseio.com")&&(urlParams.r="f");transportSessionId&&(urlParams.s=transportSessionId);lastSessionId&&(urlParams.ls=lastSessionId);return repoInfo.connectionURL("websocket",
urlParams)};WebSocketConnection.prototype.open=function(onMessage,onDisconnect){var _this=this;this.onDisconnect=onDisconnect;this.onMessage=onMessage;this.log_("Websocket connecting to "+this.connURL);this.everConnected_=!1;PersistentStorage.set("previous_websocket_failure",!0);try{if(util.isNodeSdk()){var options={headers:{"User-Agent":"Firebase/5/"+SDK_VERSION+"/"+process.platform+"/"+(util.CONSTANTS.NODE_ADMIN?"AdminNode":"Node"),"X-Firebase-GMPID":this.applicationId||""}},env=process.env,proxy=
0===this.connURL.indexOf("wss://")?env.HTTPS_PROXY||env.https_proxy:env.HTTP_PROXY||env.http_proxy;proxy&&(options.proxy={origin:proxy})}else options={headers:{"X-Firebase-GMPID":this.applicationId||""}};this.mySock=new WebSocketImpl(this.connURL,[],options)}catch(e){this.log_("Error instantiating WebSocket.");(onMessage=e.message||e.data)&&this.log_(onMessage);this.onClosed_();return}this.mySock.onopen=function(){_this.log_("Websocket connected.");_this.everConnected_=!0};this.mySock.onclose=function(){_this.log_("Websocket connection was disconnected.");
_this.mySock=null;_this.onClosed_()};this.mySock.onmessage=function(m){_this.handleIncomingFrame(m)};this.mySock.onerror=function(e){_this.log_("WebSocket error.  Closing connection.");(e=e.message||e.data)&&_this.log_(e);_this.onClosed_()}};WebSocketConnection.prototype.start=function(){};WebSocketConnection.forceDisallow=function(){WebSocketConnection.forceDisallow_=!0};WebSocketConnection.isAvailable=function(){var isOldAndroid=!1;if("undefined"!==typeof navigator&&navigator.userAgent){var oldAndroidMatch=
navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);oldAndroidMatch&&1<oldAndroidMatch.length&&4.4>parseFloat(oldAndroidMatch[1])&&(isOldAndroid=!0)}return!isOldAndroid&&null!==WebSocketImpl&&!WebSocketConnection.forceDisallow_};WebSocketConnection.previouslyFailed=function(){return PersistentStorage.isInMemoryStorage||!0===PersistentStorage.get("previous_websocket_failure")};WebSocketConnection.prototype.markConnectionHealthy=function(){PersistentStorage.remove("previous_websocket_failure")};
WebSocketConnection.prototype.appendFrame_=function(data){this.frames.push(data);this.frames.length===this.totalFrames&&(data=this.frames.join(""),this.frames=null,data=util.jsonEval(data),this.onMessage(data))};WebSocketConnection.prototype.handleNewFrameCount_=function(frameCount){this.totalFrames=frameCount;this.frames=[]};WebSocketConnection.prototype.extractFrameCount_=function(data){util.assert(null===this.frames,"We already have a frame buffer");if(6>=data.length){var frameCount=Number(data);
if(!isNaN(frameCount))return this.handleNewFrameCount_(frameCount),null}this.handleNewFrameCount_(1);return data};WebSocketConnection.prototype.handleIncomingFrame=function(mess){null!==this.mySock&&(mess=mess.data,this.bytesReceived+=mess.length,this.stats_.incrementCounter("bytes_received",mess.length),this.resetKeepAlive(),null!==this.frames?this.appendFrame_(mess):(mess=this.extractFrameCount_(mess),null!==mess&&this.appendFrame_(mess)))};WebSocketConnection.prototype.send=function(data){this.resetKeepAlive();
data=util.stringify(data);this.bytesSent+=data.length;this.stats_.incrementCounter("bytes_sent",data.length);data=splitStringBySize(data,16384);1<data.length&&this.sendString_(String(data.length));for(var i=0;i<data.length;i++)this.sendString_(data[i])};WebSocketConnection.prototype.shutdown_=function(){this.isClosed_=!0;this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null);this.mySock&&(this.mySock.close(),this.mySock=null)};WebSocketConnection.prototype.onClosed_=function(){this.isClosed_||
(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))};WebSocketConnection.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())};WebSocketConnection.prototype.resetKeepAlive=function(){var _this=this;clearInterval(this.keepaliveTimer);this.keepaliveTimer=setInterval(function(){_this.mySock&&_this.sendString_("0");_this.resetKeepAlive()},45E3)};WebSocketConnection.prototype.sendString_=
function(str){try{this.mySock.send(str)}catch(e){this.log_("Exception thrown from WebSocket.send():",e.message||e.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}};WebSocketConnection.responsesRequiredToBeHealthy=2;WebSocketConnection.healthyTimeout=3E4;return WebSocketConnection}(),TransportManager=function(){function TransportManager(repoInfo){this.initTransports_(repoInfo)}Object.defineProperty(TransportManager,"ALL_TRANSPORTS",{get:function(){return[BrowserPollConnection,WebSocketConnection]},
enumerable:!1,configurable:!0});TransportManager.prototype.initTransports_=function(repoInfo){var _a,isWebSocketsAvailable=WebSocketConnection&&WebSocketConnection.isAvailable(),isSkipPollConnection=isWebSocketsAvailable&&!WebSocketConnection.previouslyFailed();repoInfo.webSocketOnly&&(isWebSocketsAvailable||warn("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),isSkipPollConnection=!0);if(isSkipPollConnection)this.transports_=[WebSocketConnection];else{repoInfo=this.transports_=
[];try{for(var _b=tslib.__values(TransportManager.ALL_TRANSPORTS),_c=_b.next();!_c.done;_c=_b.next()){var transport=_c.value;transport&&transport.isAvailable()&&repoInfo.push(transport)}}catch(e_1_1){var e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error;}}}};TransportManager.prototype.initialTransport=function(){if(0<this.transports_.length)return this.transports_[0];throw Error("No transports available");};TransportManager.prototype.upgradeTransport=
function(){return 1<this.transports_.length?this.transports_[1]:null};return TransportManager}(),Connection=function(){function Connection(id,repoInfo_,applicationId_,onMessage_,onReady_,onDisconnect_,onKill_,lastSessionId){this.id=id;this.repoInfo_=repoInfo_;this.applicationId_=applicationId_;this.onMessage_=onMessage_;this.onReady_=onReady_;this.onDisconnect_=onDisconnect_;this.onKill_=onKill_;this.lastSessionId=lastSessionId;this.connectionCount=0;this.pendingDataMessages=[];this.state_=0;this.log_=
logWrapper("c:"+this.id+":");this.transportManager_=new TransportManager(repoInfo_);this.log_("Connection created");this.start_()}Connection.prototype.start_=function(){var _this=this,conn=this.transportManager_.initialTransport();this.conn_=new conn(this.nextTransportId_(),this.repoInfo_,this.applicationId_,void 0,this.lastSessionId);this.primaryResponsesRequired_=conn.responsesRequiredToBeHealthy||0;var onMessageReceived=this.connReceiver_(this.conn_),onConnectionLost=this.disconnReceiver_(this.conn_);
this.rx_=this.tx_=this.conn_;this.secondaryConn_=null;this.isHealthy_=!1;setTimeout(function(){_this.conn_&&_this.conn_.open(onMessageReceived,onConnectionLost)},0);conn=conn.healthyTimeout||0;0<conn&&(this.healthyTimeout_=setTimeoutNonBlocking(function(){_this.healthyTimeout_=null;_this.isHealthy_||(_this.conn_&&102400<_this.conn_.bytesReceived?(_this.log_("Connection exceeded healthy timeout but has received "+_this.conn_.bytesReceived+" bytes.  Marking connection healthy."),_this.isHealthy_=!0,
_this.conn_.markConnectionHealthy()):_this.conn_&&10240<_this.conn_.bytesSent?_this.log_("Connection exceeded healthy timeout but has sent "+_this.conn_.bytesSent+" bytes.  Leaving connection alive."):(_this.log_("Closing unhealthy connection after timeout."),_this.close()))},Math.floor(conn)))};Connection.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++};Connection.prototype.disconnReceiver_=function(conn){var _this=this;return function(everConnected){if(conn===
_this.conn_)_this.onConnectionLost_(everConnected);else conn===_this.secondaryConn_?(_this.log_("Secondary connection lost."),_this.onSecondaryConnectionLost_()):_this.log_("closing an old connection")}};Connection.prototype.connReceiver_=function(conn){var _this=this;return function(message){if(2!==_this.state_)if(conn===_this.rx_)_this.onPrimaryMessageReceived_(message);else if(conn===_this.secondaryConn_)_this.onSecondaryMessageReceived_(message);else _this.log_("message on old connection")}};
Connection.prototype.sendRequest=function(dataMsg){this.sendData_({t:"d",d:dataMsg})};Connection.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)};Connection.prototype.onSecondaryControl_=function(controlData){"t"in controlData&&(controlData=controlData.t,"a"===controlData?this.upgradeIfSecondaryHealthy_():
"r"===controlData?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===controlData&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_()))};Connection.prototype.onSecondaryMessageReceived_=function(parsedData){var layer=requireKey("t",parsedData);parsedData=requireKey("d",parsedData);if("c"===layer)this.onSecondaryControl_(parsedData);else if("d"===
layer)this.pendingDataMessages.push(parsedData);else throw Error("Unknown protocol layer: "+layer);};Connection.prototype.upgradeIfSecondaryHealthy_=function(){0>=this.secondaryResponsesRequired_?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))};Connection.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start();
this.log_("sending client ack on secondary");this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}});this.log_("Ending transmission on primary");this.conn_.send({t:"c",d:{t:"n",d:{}}});this.tx_=this.secondaryConn_;this.tryCleanupConnection()};Connection.prototype.onPrimaryMessageReceived_=function(parsedData){var layer=requireKey("t",parsedData);parsedData=requireKey("d",parsedData);if("c"===layer)this.onControl_(parsedData);else if("d"===layer)this.onDataMessage_(parsedData)};Connection.prototype.onDataMessage_=
function(message){this.onPrimaryResponse_();this.onMessage_(message)};Connection.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,0>=this.primaryResponsesRequired_&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))};Connection.prototype.onControl_=function(controlData){var cmd=requireKey("t",controlData);if("d"in controlData)if(controlData=controlData.d,"h"===cmd)this.onHandshake_(controlData);else if("n"===
cmd){this.log_("recvd end transmission on primary");this.rx_=this.secondaryConn_;for(cmd=0;cmd<this.pendingDataMessages.length;++cmd)this.onDataMessage_(this.pendingDataMessages[cmd]);this.pendingDataMessages=[];this.tryCleanupConnection()}else if("s"===cmd)this.onConnectionShutdown_(controlData);else if("r"===cmd)this.onReset_(controlData);else"e"===cmd?error$jscomp$0("Server Error: "+controlData):"o"===cmd?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):
error$jscomp$0("Unknown control packet command: "+cmd)};Connection.prototype.onHandshake_=function(handshake){var timestamp=handshake.ts,version=handshake.v,host=handshake.h;this.sessionId=handshake.s;this.repoInfo_.updateHost(host);0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,timestamp),"5"!==version&&warn("Protocol version mismatch detected"),this.tryStartUpgrade_())};Connection.prototype.tryStartUpgrade_=function(){var conn=this.transportManager_.upgradeTransport();
conn&&this.startUpgrade_(conn)};Connection.prototype.startUpgrade_=function(conn){var _this=this;this.secondaryConn_=new conn(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.sessionId);this.secondaryResponsesRequired_=conn.responsesRequiredToBeHealthy||0;conn=this.connReceiver_(this.secondaryConn_);var onDisconnect=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(conn,onDisconnect);setTimeoutNonBlocking(function(){_this.secondaryConn_&&(_this.log_("Timed out trying to upgrade."),
_this.secondaryConn_.close())},6E4)};Connection.prototype.onReset_=function(host){this.log_("Reset packet received.  New host: "+host);this.repoInfo_.updateHost(host);1===this.state_?this.close():(this.closeConnections_(),this.start_())};Connection.prototype.onConnectionEstablished_=function(conn,timestamp){var _this=this;this.log_("Realtime connection established.");this.conn_=conn;this.state_=1;this.onReady_&&(this.onReady_(timestamp,this.sessionId),this.onReady_=null);0===this.primaryResponsesRequired_?
(this.log_("Primary connection is healthy."),this.isHealthy_=!0):setTimeoutNonBlocking(function(){_this.sendPingOnPrimaryIfNecessary_()},5E3)};Connection.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))};Connection.prototype.onSecondaryConnectionLost_=function(){var conn=this.secondaryConn_;this.secondaryConn_=null;this.tx_!==conn&&this.rx_!==conn||this.close()};Connection.prototype.onConnectionLost_=
function(everConnected){this.conn_=null;everConnected||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(PersistentStorage.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host));this.close()};Connection.prototype.onConnectionShutdown_=function(reason){this.log_("Connection shutdown command received. Shutting down...");this.onKill_&&(this.onKill_(reason),this.onKill_=null);
this.onDisconnect_=null;this.close()};Connection.prototype.sendData_=function(data){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(data)};Connection.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))};Connection.prototype.closeConnections_=function(){this.log_("Shutting down all connections");this.conn_&&(this.conn_.close(),this.conn_=
null);this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null);this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)};return Connection}(),ServerActions=function(){function ServerActions(){}ServerActions.prototype.put=function(pathString,data,onComplete,hash){};ServerActions.prototype.merge=function(pathString,data,onComplete,hash){};ServerActions.prototype.refreshAuthToken=function(token){};ServerActions.prototype.onDisconnectPut=function(pathString,
data,onComplete){};ServerActions.prototype.onDisconnectMerge=function(pathString,data,onComplete){};ServerActions.prototype.onDisconnectCancel=function(pathString,onComplete){};ServerActions.prototype.reportStats=function(stats){};return ServerActions}(),PersistentConnection=function(_super){function PersistentConnection(repoInfo_,applicationId_,onDataUpdate_,onConnectStatus_,onServerInfoUpdate_,authTokenProvider_,authOverride_){var _this=_super.call(this)||this;_this.repoInfo_=repoInfo_;_this.applicationId_=
applicationId_;_this.onDataUpdate_=onDataUpdate_;_this.onConnectStatus_=onConnectStatus_;_this.onServerInfoUpdate_=onServerInfoUpdate_;_this.authTokenProvider_=authTokenProvider_;_this.authOverride_=authOverride_;_this.id=PersistentConnection.nextPersistentConnectionId_++;_this.log_=logWrapper("p:"+_this.id+":");_this.interruptReasons_={};_this.listens=new Map;_this.outstandingPuts_=[];_this.outstandingPutCount_=0;_this.onDisconnectRequestQueue_=[];_this.connected_=!1;_this.reconnectDelay_=1E3;_this.maxReconnectDelay_=
3E5;_this.securityDebugCallback_=null;_this.lastSessionId=null;_this.establishConnectionTimer_=null;_this.visible_=!1;_this.requestCBHash_={};_this.requestNumber_=0;_this.realtime_=null;_this.authToken_=null;_this.forceTokenRefresh_=!1;_this.invalidAuthTokenCount_=0;_this.firstConnection_=!0;_this.lastConnectionAttemptTime_=null;_this.lastConnectionEstablishedTime_=null;if(authOverride_&&!util.isNodeSdk())throw Error("Auth override specified in options, but not supported on non Node.js platforms");
_this.scheduleConnect_(0);VisibilityMonitor.getInstance().on("visible",_this.onVisible_,_this);if(-1===repoInfo_.host.indexOf("fblocal"))OnlineMonitor.getInstance().on("online",_this.onOnline_,_this);return _this}tslib.__extends(PersistentConnection,_super);PersistentConnection.prototype.sendRequest=function(action,body,onResponse){var curReqNum=++this.requestNumber_;action={r:curReqNum,a:action,b:body};this.log_(util.stringify(action));util.assert(this.connected_,"sendRequest call when we're not connected not allowed.");
this.realtime_.sendRequest(action);onResponse&&(this.requestCBHash_[curReqNum]=onResponse)};PersistentConnection.prototype.listen=function(query,currentHashFn,tag,onComplete){var queryId=query.queryIdentifier(),pathString=query.path.toString();this.log_("Listen called for "+pathString+" "+queryId);this.listens.has(pathString)||this.listens.set(pathString,new Map);util.assert(query.getQueryParams().isDefault()||!query.getQueryParams().loadsAllData(),"listen() called for non-default but complete query");
util.assert(!this.listens.get(pathString).has(queryId),"listen() called twice for same path/queryId.");query={onComplete:onComplete,hashFn:currentHashFn,query:query,tag:tag};this.listens.get(pathString).set(queryId,query);this.connected_&&this.sendListen_(query)};PersistentConnection.prototype.sendListen_=function(listenSpec){var _this=this,query=listenSpec.query,pathString=query.path.toString(),queryId=query.queryIdentifier();this.log_("Listen on "+pathString+" for "+queryId);var req={p:pathString};
listenSpec.tag&&(req.q=query.queryObject(),req.t=listenSpec.tag);req.h=listenSpec.hashFn();this.sendRequest("q",req,function(message){var payload=message.d,status=message.s;PersistentConnection.warnOnListenWarnings_(payload,query);if((_this.listens.get(pathString)&&_this.listens.get(pathString).get(queryId))===listenSpec&&(_this.log_("listen response",message),"ok"!==status&&_this.removeListen_(pathString,queryId),listenSpec.onComplete))listenSpec.onComplete(status,payload)})};PersistentConnection.warnOnListenWarnings_=
function(payload,query){payload&&"object"===typeof payload&&util.contains(payload,"w")&&(payload=util.safeGet(payload,"w"),Array.isArray(payload)&&~payload.indexOf("no_index")&&(payload='".indexOn": "'+query.getQueryParams().getIndex().toString()+'"',warn("Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding "+(payload+" at ")+(query.path.toString()+" to your security rules for better performance."))))};PersistentConnection.prototype.refreshAuthToken=
function(token){this.authToken_=token;this.log_("Auth token refreshed");this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},function(){});this.reduceReconnectDelayIfAdminCredential_(token)};PersistentConnection.prototype.reduceReconnectDelayIfAdminCredential_=function(credential){if(credential&&40===credential.length||util.isAdmin(credential))this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3E4};PersistentConnection.prototype.tryAuth=
function(){var _this=this;if(this.connected_&&this.authToken_){var token_1=this.authToken_,authMethod=util.isValidFormat(token_1)?"auth":"gauth",requestData={cred:token_1};null===this.authOverride_?requestData.noauth=!0:"object"===typeof this.authOverride_&&(requestData.authvar=this.authOverride_);this.sendRequest(authMethod,requestData,function(res){var status=res.s;res=res.d||"error";if(_this.authToken_===token_1)if("ok"===status)_this.invalidAuthTokenCount_=0;else _this.onAuthRevoked_(status,res)})}};
PersistentConnection.prototype.unlisten=function(query,tag){var pathString=query.path.toString(),queryId=query.queryIdentifier();this.log_("Unlisten called for "+pathString+" "+queryId);util.assert(query.getQueryParams().isDefault()||!query.getQueryParams().loadsAllData(),"unlisten() called for non-default but complete query");this.removeListen_(pathString,queryId)&&this.connected_&&this.sendUnlisten_(pathString,queryId,query.queryObject(),tag)};PersistentConnection.prototype.sendUnlisten_=function(pathString,
queryId,queryObj,tag){this.log_("Unlisten on "+pathString+" for "+queryId);pathString={p:pathString};tag&&(pathString.q=queryObj,pathString.t=tag);this.sendRequest("n",pathString)};PersistentConnection.prototype.onDisconnectPut=function(pathString,data,onComplete){this.connected_?this.sendOnDisconnect_("o",pathString,data,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"o",data:data,onComplete:onComplete})};PersistentConnection.prototype.onDisconnectMerge=function(pathString,
data,onComplete){this.connected_?this.sendOnDisconnect_("om",pathString,data,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"om",data:data,onComplete:onComplete})};PersistentConnection.prototype.onDisconnectCancel=function(pathString,onComplete){this.connected_?this.sendOnDisconnect_("oc",pathString,null,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"oc",data:null,onComplete:onComplete})};PersistentConnection.prototype.sendOnDisconnect_=
function(action,pathString,data,onComplete){pathString={p:pathString,d:data};this.log_("onDisconnect "+action,pathString);this.sendRequest(action,pathString,function(response){onComplete&&setTimeout(function(){onComplete(response.s,response.d)},0)})};PersistentConnection.prototype.put=function(pathString,data,onComplete,hash){this.putInternal("p",pathString,data,onComplete,hash)};PersistentConnection.prototype.merge=function(pathString,data,onComplete,hash){this.putInternal("m",pathString,data,onComplete,
hash)};PersistentConnection.prototype.putInternal=function(action,pathString,data,onComplete,hash){data={p:pathString,d:data};void 0!==hash&&(data.h=hash);this.outstandingPuts_.push({action:action,request:data,onComplete:onComplete});this.outstandingPutCount_++;action=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(action):this.log_("Buffering put: "+pathString)};PersistentConnection.prototype.sendPut_=function(index){var _this=this,action=this.outstandingPuts_[index].action,request=
this.outstandingPuts_[index].request,onComplete=this.outstandingPuts_[index].onComplete;this.outstandingPuts_[index].queued=this.connected_;this.sendRequest(action,request,function(message){_this.log_(action+" response",message);delete _this.outstandingPuts_[index];_this.outstandingPutCount_--;0===_this.outstandingPutCount_&&(_this.outstandingPuts_=[]);onComplete&&onComplete(message.s,message.d)})};PersistentConnection.prototype.reportStats=function(stats){var _this=this;this.connected_&&(stats={c:stats},
this.log_("reportStats",stats),this.sendRequest("s",stats,function(result){"ok"!==result.s&&_this.log_("reportStats","Error sending stats: "+result.d)}))};PersistentConnection.prototype.onDataMessage_=function(message){if("r"in message){this.log_("from server: "+util.stringify(message));var reqNum=message.r,onResponse=this.requestCBHash_[reqNum];onResponse&&(delete this.requestCBHash_[reqNum],onResponse(message.b))}else{if("error"in message)throw"A server-side error has occurred: "+message.error;
if("a"in message)this.onDataPush_(message.a,message.b)}};PersistentConnection.prototype.onDataPush_=function(action,body){this.log_("handleServerMessage",action,body);if("d"===action)this.onDataUpdate_(body.p,body.d,!1,body.t);else if("m"===action)this.onDataUpdate_(body.p,body.d,!0,body.t);else if("c"===action)this.onListenRevoked_(body.p,body.q);else if("ac"===action)this.onAuthRevoked_(body.s,body.d);else if("sd"===action)this.onSecurityDebugPacket_(body);else error$jscomp$0("Unrecognized action received from server: "+
util.stringify(action)+"\nAre you using the latest client?")};PersistentConnection.prototype.onReady_=function(timestamp,sessionId){this.log_("connection ready");this.connected_=!0;this.lastConnectionEstablishedTime_=(new Date).getTime();this.handleTimestamp_(timestamp);this.lastSessionId=sessionId;this.firstConnection_&&this.sendConnectStats_();this.restoreState_();this.firstConnection_=!1;this.onConnectStatus_(!0)};PersistentConnection.prototype.scheduleConnect_=function(timeout){var _this=this;
util.assert(!this.realtime_,"Scheduling a connect when we're already connected/ing?");this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_);this.establishConnectionTimer_=setTimeout(function(){_this.establishConnectionTimer_=null;_this.establishConnection_()},Math.floor(timeout))};PersistentConnection.prototype.onVisible_=function(visible){visible&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=
1E3,this.realtime_||this.scheduleConnect_(0));this.visible_=visible};PersistentConnection.prototype.onOnline_=function(online){online?(this.log_("Browser went online."),this.reconnectDelay_=1E3,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())};PersistentConnection.prototype.onRealtimeDisconnect_=function(){this.log_("data client disconnected");this.connected_=!1;this.realtime_=null;this.cancelSentTransactions_();
this.requestCBHash_={};if(this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(3E4<(new Date).getTime()-this.lastConnectionEstablishedTime_&&(this.reconnectDelay_=1E3),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime());var timeSinceLastConnectAttempt=(new Date).getTime()-this.lastConnectionAttemptTime_;timeSinceLastConnectAttempt=
Math.max(0,this.reconnectDelay_-timeSinceLastConnectAttempt);timeSinceLastConnectAttempt*=Math.random();this.log_("Trying to reconnect in "+timeSinceLastConnectAttempt+"ms");this.scheduleConnect_(timeSinceLastConnectAttempt);this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)};PersistentConnection.prototype.establishConnection_=function(){if(this.shouldReconnect_()){this.log_("Making a connection attempt");this.lastConnectionAttemptTime_=(new Date).getTime();
this.lastConnectionEstablishedTime_=null;var onDataMessage_1=this.onDataMessage_.bind(this),onReady_1=this.onReady_.bind(this),onDisconnect_1=this.onRealtimeDisconnect_.bind(this),connId_1=this.id+":"+PersistentConnection.nextConnectionId_++,self_1=this,lastSessionId_1=this.lastSessionId,canceled_1=!1,connection_1=null,closeFn_1=function(){connection_1?connection_1.close():(canceled_1=!0,onDisconnect_1())};this.realtime_={close:closeFn_1,sendRequest:function(msg){util.assert(connection_1,"sendRequest call when we're not connected not allowed.");
connection_1.sendRequest(msg)}};var forceRefresh=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;this.authTokenProvider_.getToken(forceRefresh).then(function(result){canceled_1?log("getToken() completed but was canceled"):(log("getToken() completed. Creating connection."),self_1.authToken_=result&&result.accessToken,connection_1=new Connection(connId_1,self_1.repoInfo_,self_1.applicationId_,onDataMessage_1,onReady_1,onDisconnect_1,function(reason){warn(reason+" ("+self_1.repoInfo_.toString()+")");
self_1.interrupt("server_kill")},lastSessionId_1))}).then(null,function(error){self_1.log_("Failed to get token: "+error);canceled_1||(util.CONSTANTS.NODE_ADMIN&&warn(error),closeFn_1())})}};PersistentConnection.prototype.interrupt=function(reason){log("Interrupting connection for reason: "+reason);this.interruptReasons_[reason]=!0;if(this.realtime_)this.realtime_.close();else if(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_)this.onRealtimeDisconnect_()};
PersistentConnection.prototype.resume=function(reason){log("Resuming connection for reason: "+reason);delete this.interruptReasons_[reason];util.isEmpty(this.interruptReasons_)&&(this.reconnectDelay_=1E3,this.realtime_||this.scheduleConnect_(0))};PersistentConnection.prototype.handleTimestamp_=function(timestamp){timestamp-=(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:timestamp})};PersistentConnection.prototype.cancelSentTransactions_=function(){for(var i=0;i<this.outstandingPuts_.length;i++){var put=
this.outstandingPuts_[i];if(put&&"h"in put.request&&put.queued){if(put.onComplete)put.onComplete("disconnect");delete this.outstandingPuts_[i];this.outstandingPutCount_--}}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])};PersistentConnection.prototype.onListenRevoked_=function(pathString,query){query=query?query.map(function(q){return ObjectToUniqueKey(q)}).join("$"):"default";if((pathString=this.removeListen_(pathString,query))&&pathString.onComplete)pathString.onComplete("permission_denied")};
PersistentConnection.prototype.removeListen_=function(pathString,queryId){pathString=(new Path(pathString)).toString();if(this.listens.has(pathString)){var map=this.listens.get(pathString);var listen=map.get(queryId);map.delete(queryId);0===map.size&&this.listens.delete(pathString)}else listen=void 0;return listen};PersistentConnection.prototype.onAuthRevoked_=function(statusCode,explanation){log("Auth token revoked: "+statusCode+"/"+explanation);this.authToken_=null;this.forceTokenRefresh_=!0;this.realtime_.close();
if("invalid_token"===statusCode||"permission_denied"===statusCode)this.invalidAuthTokenCount_++,3<=this.invalidAuthTokenCount_&&(this.reconnectDelay_=3E4,this.authTokenProvider_.notifyForInvalidToken())};PersistentConnection.prototype.onSecurityDebugPacket_=function(body){this.securityDebugCallback_?this.securityDebugCallback_(body):"msg"in body&&console.log("FIREBASE: "+body.msg.replace("\n","\nFIREBASE: "))};PersistentConnection.prototype.restoreState_=function(){var _a,e_2,_b;this.tryAuth();try{for(var _c=
tslib.__values(this.listens.values()),_d=_c.next();!_d.done;_d=_c.next()){var queries=_d.value;try{for(var _e=(e_2=void 0,tslib.__values(queries.values())),_f=_e.next();!_f.done;_f=_e.next())this.sendListen_(_f.value)}catch(e_2_1){e_2={error:e_2_1}}finally{try{_f&&!_f.done&&(_b=_e.return)&&_b.call(_e)}finally{if(e_2)throw e_2.error;}}}}catch(e_1_1){var e_1={error:e_1_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_1)throw e_1.error;}}for(e_1=0;e_1<this.outstandingPuts_.length;e_1++)this.outstandingPuts_[e_1]&&
this.sendPut_(e_1);for(;this.onDisconnectRequestQueue_.length;)e_1=this.onDisconnectRequestQueue_.shift(),this.sendOnDisconnect_(e_1.action,e_1.pathString,e_1.data,e_1.onComplete)};PersistentConnection.prototype.sendConnectStats_=function(){var stats={},clientName="js";util.CONSTANTS.NODE_ADMIN?clientName="admin_node":util.CONSTANTS.NODE_CLIENT&&(clientName="node");stats["sdk."+clientName+"."+SDK_VERSION.replace(/\./g,"-")]=1;util.isMobileCordova()?stats["framework.cordova"]=1:util.isReactNative()&&
(stats["framework.reactnative"]=1);this.reportStats(stats)};PersistentConnection.prototype.shouldReconnect_=function(){var online=OnlineMonitor.getInstance().currentlyOnline();return util.isEmpty(this.interruptReasons_)&&online};PersistentConnection.nextPersistentConnectionId_=0;PersistentConnection.nextConnectionId_=0;return PersistentConnection}(ServerActions),ReadonlyRestClient=function(_super){function ReadonlyRestClient(repoInfo_,onDataUpdate_,authTokenProvider_){var _this=_super.call(this)||
this;_this.repoInfo_=repoInfo_;_this.onDataUpdate_=onDataUpdate_;_this.authTokenProvider_=authTokenProvider_;_this.log_=logWrapper("p:rest:");_this.listens_={};return _this}tslib.__extends(ReadonlyRestClient,_super);ReadonlyRestClient.prototype.reportStats=function(stats){throw Error("Method not implemented.");};ReadonlyRestClient.getListenId_=function(query,tag){if(void 0!==tag)return"tag$"+tag;util.assert(query.getQueryParams().isDefault(),"should have a tag if it's not a default query.");return query.path.toString()};
ReadonlyRestClient.prototype.listen=function(query,currentHashFn,tag,onComplete){var _this=this,pathString=query.path.toString();this.log_("Listen called for "+pathString+" "+query.queryIdentifier());var listenId=ReadonlyRestClient.getListenId_(query,tag),thisListen={};this.listens_[listenId]=thisListen;query=query.getQueryParams().toRestQueryStringParameters();this.restRequest_(pathString+".json",query,function(error,result){404===error&&(error=result=null);if(null===error)_this.onDataUpdate_(pathString,
result,!1,tag);util.safeGet(_this.listens_,listenId)===thisListen&&onComplete(error?401===error?"permission_denied":"rest_error:"+error:"ok",null)})};ReadonlyRestClient.prototype.unlisten=function(query,tag){query=ReadonlyRestClient.getListenId_(query,tag);delete this.listens_[query]};ReadonlyRestClient.prototype.refreshAuthToken=function(token){};ReadonlyRestClient.prototype.restRequest_=function(pathString,queryStringParameters,callback){var _this=this;void 0===queryStringParameters&&(queryStringParameters=
{});queryStringParameters.format="export";this.authTokenProvider_.getToken(!1).then(function(authTokenData){(authTokenData=authTokenData&&authTokenData.accessToken)&&(queryStringParameters.auth=authTokenData);var url=(_this.repoInfo_.secure?"https://":"http://")+_this.repoInfo_.host+pathString+"?ns\x3d"+_this.repoInfo_.namespace+util.querystring(queryStringParameters);_this.log_("Sending REST request for "+url);var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(callback&&4===xhr.readyState){_this.log_("REST Response for "+
url+" received. status:",xhr.status,"response:",xhr.responseText);var res=null;if(200<=xhr.status&&300>xhr.status){try{res=util.jsonEval(xhr.responseText)}catch(e){warn("Failed to parse JSON response for "+url+": "+xhr.responseText)}callback(null,res)}else 401!==xhr.status&&404!==xhr.status&&warn("Got unsuccessful REST response for "+url+" Status: "+xhr.status),callback(xhr.status);callback=null}};xhr.open("GET",url,!0);xhr.send()})};return ReadonlyRestClient}(ServerActions),Repo=function(){function Repo(repoInfo_,
forceRestClient,app,authTokenProvider){var _this=this;this.repoInfo_=repoInfo_;this.app=app;this.dataUpdateCount=0;this.statsListener_=null;this.eventQueue_=new EventQueue;this.nextWriteId_=1;this.interceptServerDataCallback_=null;this.onDisconnect_=new SparseSnapshotTree;this.persistentConnection_=null;this.stats_=StatsManager.getCollection(repoInfo_);if(forceRestClient||0<=("object"===typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i))this.server_=
new ReadonlyRestClient(this.repoInfo_,this.onDataUpdate_.bind(this),authTokenProvider),setTimeout(this.onConnectStatus_.bind(this,!0),0);else{forceRestClient=app.options.databaseAuthVariableOverride;if("undefined"!==typeof forceRestClient&&null!==forceRestClient){if("object"!==typeof forceRestClient)throw Error("Only objects are supported for option databaseAuthVariableOverride");try{util.stringify(forceRestClient)}catch(e){throw Error("Invalid authOverride provided: "+e);}}this.server_=this.persistentConnection_=
new PersistentConnection(this.repoInfo_,app.options.appId,this.onDataUpdate_.bind(this),this.onConnectStatus_.bind(this),this.onServerInfoUpdate_.bind(this),authTokenProvider,forceRestClient)}authTokenProvider.addTokenChangeListener(function(token){_this.server_.refreshAuthToken(token)});this.statsReporter_=StatsManager.getOrCreateReporter(repoInfo_,function(){return new StatsReporter(_this.stats_,_this.server_)});this.transactionsInit_();this.infoData_=new SnapshotHolder;this.infoSyncTree_=new SyncTree({startListening:function(query,
tag,currentHashFn,onComplete){tag=[];currentHashFn=_this.infoData_.getNode(query.path);currentHashFn.isEmpty()||(tag=_this.infoSyncTree_.applyServerOverwrite(query.path,currentHashFn),setTimeout(function(){onComplete("ok")},0));return tag},stopListening:function(){}});this.updateInfo_("connected",!1);this.serverSyncTree_=new SyncTree({startListening:function(query,tag,currentHashFn,onComplete){_this.server_.listen(query,currentHashFn,tag,function(status,data){status=onComplete(status,data);_this.eventQueue_.raiseEventsForChangedPath(query.path,
status)});return[]},stopListening:function(query,tag){_this.server_.unlisten(query,tag)}})}Repo.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host};Repo.prototype.name=function(){return this.repoInfo_.namespace};Repo.prototype.serverTime=function(){var offset=this.infoData_.getNode(new Path(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+offset};Repo.prototype.generateServerValues=function(){var values={timestamp:this.serverTime()};
values=values||{};values.timestamp=values.timestamp||(new Date).getTime();return values};Repo.prototype.onDataUpdate_=function(pathString,data,isMerge,tag){this.dataUpdateCount++;var path=new Path(pathString);data=this.interceptServerDataCallback_?this.interceptServerDataCallback_(pathString,data):data;pathString=[];tag?isMerge?(data=util.map(data,function(raw){return nodeFromJSON$1(raw)}),pathString=this.serverSyncTree_.applyTaggedQueryMerge(path,data,tag)):(data=nodeFromJSON$1(data),pathString=
this.serverSyncTree_.applyTaggedQueryOverwrite(path,data,tag)):isMerge?(tag=util.map(data,function(raw){return nodeFromJSON$1(raw)}),pathString=this.serverSyncTree_.applyServerMerge(path,tag)):(tag=nodeFromJSON$1(data),pathString=this.serverSyncTree_.applyServerOverwrite(path,tag));tag=path;0<pathString.length&&(tag=this.rerunTransactions_(path));this.eventQueue_.raiseEventsForChangedPath(tag,pathString)};Repo.prototype.interceptServerData_=function(callback){this.interceptServerDataCallback_=callback};
Repo.prototype.onConnectStatus_=function(connectStatus){this.updateInfo_("connected",connectStatus);!1===connectStatus&&this.runOnDisconnectEvents_()};Repo.prototype.onServerInfoUpdate_=function(updates){var _this=this;each(updates,function(key,value){_this.updateInfo_(key,value)})};Repo.prototype.updateInfo_=function(pathString,value){pathString=new Path("/.info/"+pathString);value=nodeFromJSON$1(value);this.infoData_.updateSnapshot(pathString,value);value=this.infoSyncTree_.applyServerOverwrite(pathString,
value);this.eventQueue_.raiseEventsForChangedPath(pathString,value)};Repo.prototype.getNextWriteId_=function(){return this.nextWriteId_++};Repo.prototype.setWithPriority=function(path,newVal,newPriority,onComplete){var _this=this;this.log_("set",{path:path.toString(),value:newVal,priority:newPriority});var serverValues=this.generateServerValues();newVal=nodeFromJSON$1(newVal,newPriority);newPriority=this.serverSyncTree_.calcCompleteEventCache(path);serverValues=resolveDeferredValueSnapshot(newVal,
newPriority,serverValues);var writeId=this.getNextWriteId_();serverValues=this.serverSyncTree_.applyUserOverwrite(path,serverValues,writeId,!0);this.eventQueue_.queueEvents(serverValues);this.server_.put(path.toString(),newVal.val(!0),function(status,errorReason){var success="ok"===status;success||warn("set at "+path+" failed: "+status);success=_this.serverSyncTree_.ackUserWrite(writeId,!success);_this.eventQueue_.raiseEventsForChangedPath(path,success);_this.callOnCompleteCallback(onComplete,status,
errorReason)});serverValues=this.abortTransactions_(path);this.rerunTransactions_(serverValues);this.eventQueue_.raiseEventsForChangedPath(serverValues,[])};Repo.prototype.update=function(path,childrenToMerge,onComplete){var _this=this;this.log_("update",{path:path.toString(),value:childrenToMerge});var empty=!0,serverValues=this.generateServerValues(),changedChildren={};each(childrenToMerge,function(changedKey,changedValue){empty=!1;var JSCompiler_inline_result=path.child(changedKey);changedValue=
nodeFromJSON$1(changedValue);JSCompiler_inline_result=resolveDeferredValue(changedValue,new DeferredValueProvider(_this.serverSyncTree_,JSCompiler_inline_result),serverValues);changedChildren[changedKey]=JSCompiler_inline_result});if(empty)log("update() called with empty data.  Don't do anything."),this.callOnCompleteCallback(onComplete,"ok");else{var writeId_1=this.getNextWriteId_(),events=this.serverSyncTree_.applyUserMerge(path,changedChildren,writeId_1);this.eventQueue_.queueEvents(events);this.server_.merge(path.toString(),
childrenToMerge,function(status,errorReason){var success="ok"===status;success||warn("update at "+path+" failed: "+status);success=_this.serverSyncTree_.ackUserWrite(writeId_1,!success);var affectedPath=0<success.length?_this.rerunTransactions_(path):path;_this.eventQueue_.raiseEventsForChangedPath(affectedPath,success);_this.callOnCompleteCallback(onComplete,status,errorReason)});each(childrenToMerge,function(changedPath){changedPath=_this.abortTransactions_(path.child(changedPath));_this.rerunTransactions_(changedPath)});
this.eventQueue_.raiseEventsForChangedPath(path,[])}};Repo.prototype.runOnDisconnectEvents_=function(){var _this=this;this.log_("onDisconnectEvents");var serverValues=this.generateServerValues(),resolvedOnDisconnectTree=new SparseSnapshotTree;this.onDisconnect_.forEachTree(Path.Empty,function(path,node){node=resolveDeferredValue(node,new DeferredValueProvider(_this.serverSyncTree_,path),serverValues);resolvedOnDisconnectTree.remember(path,node)});var events=[];resolvedOnDisconnectTree.forEachTree(Path.Empty,
function(path,snap){events=events.concat(_this.serverSyncTree_.applyServerOverwrite(path,snap));path=_this.abortTransactions_(path);_this.rerunTransactions_(path)});this.onDisconnect_=new SparseSnapshotTree;this.eventQueue_.raiseEventsForChangedPath(Path.Empty,events)};Repo.prototype.onDisconnectCancel=function(path,onComplete){var _this=this;this.server_.onDisconnectCancel(path.toString(),function(status,errorReason){"ok"===status&&_this.onDisconnect_.forget(path);_this.callOnCompleteCallback(onComplete,
status,errorReason)})};Repo.prototype.onDisconnectSet=function(path,value,onComplete){var _this=this,newNode=nodeFromJSON$1(value);this.server_.onDisconnectPut(path.toString(),newNode.val(!0),function(status,errorReason){"ok"===status&&_this.onDisconnect_.remember(path,newNode);_this.callOnCompleteCallback(onComplete,status,errorReason)})};Repo.prototype.onDisconnectSetWithPriority=function(path,value,priority,onComplete){var _this=this,newNode=nodeFromJSON$1(value,priority);this.server_.onDisconnectPut(path.toString(),
newNode.val(!0),function(status,errorReason){"ok"===status&&_this.onDisconnect_.remember(path,newNode);_this.callOnCompleteCallback(onComplete,status,errorReason)})};Repo.prototype.onDisconnectUpdate=function(path,childrenToMerge,onComplete){var _this=this;if(util.isEmpty(childrenToMerge))log("onDisconnect().update() called with empty data.  Don't do anything."),this.callOnCompleteCallback(onComplete,"ok");else this.server_.onDisconnectMerge(path.toString(),childrenToMerge,function(status,errorReason){"ok"===
status&&each(childrenToMerge,function(childName,childNode){childNode=nodeFromJSON$1(childNode);_this.onDisconnect_.remember(path.child(childName),childNode)});_this.callOnCompleteCallback(onComplete,status,errorReason)})};Repo.prototype.addEventCallbackForQuery=function(query,eventRegistration){eventRegistration=".info"===query.path.getFront()?this.infoSyncTree_.addEventRegistration(query,eventRegistration):this.serverSyncTree_.addEventRegistration(query,eventRegistration);this.eventQueue_.raiseEventsAtPath(query.path,
eventRegistration)};Repo.prototype.removeEventCallbackForQuery=function(query,eventRegistration){eventRegistration=".info"===query.path.getFront()?this.infoSyncTree_.removeEventRegistration(query,eventRegistration):this.serverSyncTree_.removeEventRegistration(query,eventRegistration);this.eventQueue_.raiseEventsAtPath(query.path,eventRegistration)};Repo.prototype.interrupt=function(){this.persistentConnection_&&this.persistentConnection_.interrupt("repo_interrupt")};Repo.prototype.resume=function(){this.persistentConnection_&&
this.persistentConnection_.resume("repo_interrupt")};Repo.prototype.stats=function(showDelta){void 0===showDelta&&(showDelta=!1);if("undefined"!==typeof console){showDelta?(this.statsListener_||(this.statsListener_=new StatsListener(this.stats_)),showDelta=this.statsListener_.get()):showDelta=this.stats_.get();var longestName=Object.keys(showDelta).reduce(function(previousValue,currentValue){return Math.max(currentValue.length,previousValue)},0);each(showDelta,function(stat,value){var paddedStat=
stat;for(stat=stat.length;stat<longestName+2;stat++)paddedStat+=" ";console.log(paddedStat+value)})}};Repo.prototype.statsIncrementCounter=function(metric){this.stats_.incrementCounter(metric);this.statsReporter_.includeStat(metric)};Repo.prototype.log_=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];_i="";this.persistentConnection_&&(_i=this.persistentConnection_.id+":");log.apply(void 0,tslib.__spread([_i],varArgs))};Repo.prototype.callOnCompleteCallback=function(callback,
status,errorReason){callback&&exceptionGuard(function(){if("ok"===status)callback(null);else{var code=(status||"error").toUpperCase(),message=code;errorReason&&(message+=": "+errorReason);message=Error(message);message.code=code;callback(message)}})};Object.defineProperty(Repo.prototype,"database",{get:function(){return this.__database||(this.__database=new Database$jscomp$0(this))},enumerable:!1,configurable:!0});return Repo}(),RangedFilter=function(){function RangedFilter(params){this.indexedFilter_=
new IndexedFilter(params.getIndex());this.index_=params.getIndex();this.startPost_=RangedFilter.getStartPost_(params);this.endPost_=RangedFilter.getEndPost_(params)}RangedFilter.prototype.getStartPost=function(){return this.startPost_};RangedFilter.prototype.getEndPost=function(){return this.endPost_};RangedFilter.prototype.matches=function(node){return 0>=this.index_.compare(this.getStartPost(),node)&&0>=this.index_.compare(node,this.getEndPost())};RangedFilter.prototype.updateChild=function(snap,
key,newChild,affectedPath,source,optChangeAccumulator){this.matches(new NamedNode(key,newChild))||(newChild=ChildrenNode.EMPTY_NODE);return this.indexedFilter_.updateChild(snap,key,newChild,affectedPath,source,optChangeAccumulator)};RangedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){newSnap.isLeafNode()&&(newSnap=ChildrenNode.EMPTY_NODE);var filtered=newSnap.withIndex(this.index_);filtered=filtered.updatePriority(ChildrenNode.EMPTY_NODE);var self=this;newSnap.forEachChild(PRIORITY_INDEX,
function(key,childNode){self.matches(new NamedNode(key,childNode))||(filtered=filtered.updateImmediateChild(key,ChildrenNode.EMPTY_NODE))});return this.indexedFilter_.updateFullNode(oldSnap,filtered,optChangeAccumulator)};RangedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap};RangedFilter.prototype.filtersNodes=function(){return!0};RangedFilter.prototype.getIndexedFilter=function(){return this.indexedFilter_};RangedFilter.prototype.getIndex=function(){return this.index_};
RangedFilter.getStartPost_=function(params){if(params.hasStart()){var startName=params.getIndexStartName();return params.getIndex().makePost(params.getIndexStartValue(),startName)}return params.getIndex().minPost()};RangedFilter.getEndPost_=function(params){if(params.hasEnd()){var endName=params.getIndexEndName();return params.getIndex().makePost(params.getIndexEndValue(),endName)}return params.getIndex().maxPost()};return RangedFilter}(),LimitedFilter=function(){function LimitedFilter(params){this.rangedFilter_=
new RangedFilter(params);this.index_=params.getIndex();this.limit_=params.getLimit();this.reverse_=!params.isViewFromLeft()}LimitedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){this.rangedFilter_.matches(new NamedNode(key,newChild))||(newChild=ChildrenNode.EMPTY_NODE);return snap.getImmediateChild(key).equals(newChild)?snap:snap.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(snap,key,newChild,affectedPath,source,optChangeAccumulator):
this.fullLimitUpdateChild_(snap,key,newChild,source,optChangeAccumulator)};LimitedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){if(newSnap.isLeafNode()||newSnap.isEmpty())var filtered=ChildrenNode.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<newSnap.numChildren()&&newSnap.isIndexed(this.index_)){filtered=ChildrenNode.EMPTY_NODE.withIndex(this.index_);var iterator=void 0;iterator=this.reverse_?newSnap.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),
this.index_):newSnap.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(newSnap=0;iterator.hasNext()&&newSnap<this.limit_;){var next=iterator.getNext(),inRange=void 0;if(inRange=this.reverse_?0>=this.index_.compare(this.rangedFilter_.getStartPost(),next):0>=this.index_.compare(next,this.rangedFilter_.getEndPost()))filtered=filtered.updateImmediateChild(next.name,next.node),newSnap++;else break}}else{filtered=newSnap.withIndex(this.index_);filtered=filtered.updatePriority(ChildrenNode.EMPTY_NODE);
var startPost=void 0,endPost=void 0,cmp=void 0;iterator=void 0;if(this.reverse_){iterator=filtered.getReverseIterator(this.index_);startPost=this.rangedFilter_.getEndPost();endPost=this.rangedFilter_.getStartPost();var indexCompare_1=this.index_.getCompare();cmp=function(a,b){return indexCompare_1(b,a)}}else iterator=filtered.getIterator(this.index_),startPost=this.rangedFilter_.getStartPost(),endPost=this.rangedFilter_.getEndPost(),cmp=this.index_.getCompare();newSnap=0;for(var foundStartPost=!1;iterator.hasNext();)next=
iterator.getNext(),!foundStartPost&&0>=cmp(startPost,next)&&(foundStartPost=!0),(inRange=foundStartPost&&newSnap<this.limit_&&0>=cmp(next,endPost))?newSnap++:filtered=filtered.updateImmediateChild(next.name,ChildrenNode.EMPTY_NODE)}return this.rangedFilter_.getIndexedFilter().updateFullNode(oldSnap,filtered,optChangeAccumulator)};LimitedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap};LimitedFilter.prototype.filtersNodes=function(){return!0};LimitedFilter.prototype.getIndexedFilter=
function(){return this.rangedFilter_.getIndexedFilter()};LimitedFilter.prototype.getIndex=function(){return this.index_};LimitedFilter.prototype.fullLimitUpdateChild_=function(snap,childKey,childSnap,source,changeAccumulator){if(this.reverse_){var indexCmp_1=this.index_.getCompare();var cmp=function(a,b){return indexCmp_1(b,a)}}else cmp=this.index_.getCompare();util.assert(snap.numChildren()===this.limit_,"");var newChildNamedNode=new NamedNode(childKey,childSnap),windowBoundary=this.reverse_?snap.getFirstChild(this.index_):
snap.getLastChild(this.index_),inRange=this.rangedFilter_.matches(newChildNamedNode);if(snap.hasChild(childKey)){var oldChildSnap=snap.getImmediateChild(childKey);for(windowBoundary=source.getChildAfterChild(this.index_,windowBoundary,this.reverse_);null!=windowBoundary&&(windowBoundary.name===childKey||snap.hasChild(windowBoundary.name));)windowBoundary=source.getChildAfterChild(this.index_,windowBoundary,this.reverse_);source=null==windowBoundary?1:cmp(windowBoundary,newChildNamedNode);if(inRange&&
!childSnap.isEmpty()&&0<=source)return null!=changeAccumulator&&changeAccumulator.trackChildChange(Change.childChangedChange(childKey,childSnap,oldChildSnap)),snap.updateImmediateChild(childKey,childSnap);null!=changeAccumulator&&changeAccumulator.trackChildChange(Change.childRemovedChange(childKey,oldChildSnap));snap=snap.updateImmediateChild(childKey,ChildrenNode.EMPTY_NODE);return null!=windowBoundary&&this.rangedFilter_.matches(windowBoundary)?(null!=changeAccumulator&&changeAccumulator.trackChildChange(Change.childAddedChange(windowBoundary.name,
windowBoundary.node)),snap.updateImmediateChild(windowBoundary.name,windowBoundary.node)):snap}return childSnap.isEmpty()?snap:inRange&&0<=cmp(windowBoundary,newChildNamedNode)?(null!=changeAccumulator&&(changeAccumulator.trackChildChange(Change.childRemovedChange(windowBoundary.name,windowBoundary.node)),changeAccumulator.trackChildChange(Change.childAddedChange(childKey,childSnap))),snap.updateImmediateChild(childKey,childSnap).updateImmediateChild(windowBoundary.name,ChildrenNode.EMPTY_NODE)):
snap};return LimitedFilter}(),QueryParams=function(){function QueryParams(){this.endNameSet_=this.endSet_=this.startNameSet_=this.startSet_=this.limitSet_=!1;this.limit_=0;this.viewFrom_="";this.indexStartValue_=null;this.indexStartName_="";this.indexEndValue_=null;this.indexEndName_="";this.index_=PRIORITY_INDEX}QueryParams.prototype.hasStart=function(){return this.startSet_};QueryParams.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:this.viewFrom_===QueryParams.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT};
QueryParams.prototype.getIndexStartValue=function(){util.assert(this.startSet_,"Only valid if start has been set");return this.indexStartValue_};QueryParams.prototype.getIndexStartName=function(){util.assert(this.startSet_,"Only valid if start has been set");return this.startNameSet_?this.indexStartName_:"[MIN_NAME]"};QueryParams.prototype.hasEnd=function(){return this.endSet_};QueryParams.prototype.getIndexEndValue=function(){util.assert(this.endSet_,"Only valid if end has been set");return this.indexEndValue_};
QueryParams.prototype.getIndexEndName=function(){util.assert(this.endSet_,"Only valid if end has been set");return this.endNameSet_?this.indexEndName_:"[MAX_NAME]"};QueryParams.prototype.hasLimit=function(){return this.limitSet_};QueryParams.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_};QueryParams.prototype.getLimit=function(){util.assert(this.limitSet_,"Only valid if limit has been set");return this.limit_};QueryParams.prototype.getIndex=function(){return this.index_};
QueryParams.prototype.copy_=function(){var copy=new QueryParams;copy.limitSet_=this.limitSet_;copy.limit_=this.limit_;copy.startSet_=this.startSet_;copy.indexStartValue_=this.indexStartValue_;copy.startNameSet_=this.startNameSet_;copy.indexStartName_=this.indexStartName_;copy.endSet_=this.endSet_;copy.indexEndValue_=this.indexEndValue_;copy.endNameSet_=this.endNameSet_;copy.indexEndName_=this.indexEndName_;copy.index_=this.index_;copy.viewFrom_=this.viewFrom_;return copy};QueryParams.prototype.limit=
function(newLimit){var newParams=this.copy_();newParams.limitSet_=!0;newParams.limit_=newLimit;newParams.viewFrom_="";return newParams};QueryParams.prototype.limitToFirst=function(newLimit){var newParams=this.copy_();newParams.limitSet_=!0;newParams.limit_=newLimit;newParams.viewFrom_=QueryParams.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT;return newParams};QueryParams.prototype.limitToLast=function(newLimit){var newParams=this.copy_();newParams.limitSet_=!0;newParams.limit_=newLimit;newParams.viewFrom_=
QueryParams.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_RIGHT;return newParams};QueryParams.prototype.startAt=function(indexValue,key){var newParams=this.copy_();newParams.startSet_=!0;void 0===indexValue&&(indexValue=null);newParams.indexStartValue_=indexValue;null!=key?(newParams.startNameSet_=!0,newParams.indexStartName_=key):(newParams.startNameSet_=!1,newParams.indexStartName_="");return newParams};QueryParams.prototype.endAt=function(indexValue,key){var newParams=this.copy_();newParams.endSet_=!0;void 0===
indexValue&&(indexValue=null);newParams.indexEndValue_=indexValue;void 0!==key?(newParams.endNameSet_=!0,newParams.indexEndName_=key):(newParams.endNameSet_=!1,newParams.indexEndName_="");return newParams};QueryParams.prototype.orderBy=function(index){var newParams=this.copy_();newParams.index_=index;return newParams};QueryParams.prototype.getQueryObject=function(){var WIRE_PROTOCOL_CONSTANTS=QueryParams.WIRE_PROTOCOL_CONSTANTS_,obj={};this.startSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_START_VALUE]=
this.indexStartValue_,this.startNameSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_START_NAME]=this.indexStartName_));this.endSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_END_VALUE]=this.indexEndValue_,this.endNameSet_&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX_END_NAME]=this.indexEndName_));if(this.limitSet_){obj[WIRE_PROTOCOL_CONSTANTS.LIMIT]=this.limit_;var viewFrom=this.viewFrom_;""===viewFrom&&(viewFrom=this.isViewFromLeft()?WIRE_PROTOCOL_CONSTANTS.VIEW_FROM_LEFT:WIRE_PROTOCOL_CONSTANTS.VIEW_FROM_RIGHT);obj[WIRE_PROTOCOL_CONSTANTS.VIEW_FROM]=
viewFrom}this.index_!==PRIORITY_INDEX&&(obj[WIRE_PROTOCOL_CONSTANTS.INDEX]=this.index_.toString());return obj};QueryParams.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)};QueryParams.prototype.isDefault=function(){return this.loadsAllData()&&this.index_===PRIORITY_INDEX};QueryParams.prototype.getNodeFilter=function(){return this.loadsAllData()?new IndexedFilter(this.getIndex()):this.hasLimit()?new LimitedFilter(this):new RangedFilter(this)};QueryParams.prototype.toRestQueryStringParameters=
function(){var REST_CONSTANTS=QueryParams.REST_QUERY_CONSTANTS_,qs={};if(this.isDefault())return qs;if(this.index_===PRIORITY_INDEX)var orderBy=REST_CONSTANTS.PRIORITY_INDEX;else this.index_===VALUE_INDEX?orderBy=REST_CONSTANTS.VALUE_INDEX:this.index_===KEY_INDEX?orderBy=REST_CONSTANTS.KEY_INDEX:(util.assert(this.index_ instanceof PathIndex,"Unrecognized index type!"),orderBy=this.index_.toString());qs[REST_CONSTANTS.ORDER_BY]=util.stringify(orderBy);this.startSet_&&(qs[REST_CONSTANTS.START_AT]=util.stringify(this.indexStartValue_),
this.startNameSet_&&(qs[REST_CONSTANTS.START_AT]+=","+util.stringify(this.indexStartName_)));this.endSet_&&(qs[REST_CONSTANTS.END_AT]=util.stringify(this.indexEndValue_),this.endNameSet_&&(qs[REST_CONSTANTS.END_AT]+=","+util.stringify(this.indexEndName_)));this.limitSet_&&(this.isViewFromLeft()?qs[REST_CONSTANTS.LIMIT_TO_FIRST]=this.limit_:qs[REST_CONSTANTS.LIMIT_TO_LAST]=this.limit_);return qs};QueryParams.WIRE_PROTOCOL_CONSTANTS_={INDEX_START_VALUE:"sp",INDEX_START_NAME:"sn",INDEX_END_VALUE:"ep",
INDEX_END_NAME:"en",LIMIT:"l",VIEW_FROM:"vf",VIEW_FROM_LEFT:"l",VIEW_FROM_RIGHT:"r",INDEX:"i"};QueryParams.REST_QUERY_CONSTANTS_={ORDER_BY:"orderBy",PRIORITY_INDEX:"$priority",VALUE_INDEX:"$value",KEY_INDEX:"$key",START_AT:"startAt",END_AT:"endAt",LIMIT_TO_FIRST:"limitToFirst",LIMIT_TO_LAST:"limitToLast"};QueryParams.DEFAULT=new QueryParams;return QueryParams}(),Reference=function(_super){function Reference(repo,path){if(!(repo instanceof Repo))throw Error("new Reference() no longer supported - use app.database().");
return _super.call(this,repo,path,QueryParams.DEFAULT,!1)||this}tslib.__extends(Reference,_super);Reference.prototype.getKey=function(){util.validateArgCount("Reference.key",0,0,arguments.length);return this.path.isEmpty()?null:this.path.getBack()};Reference.prototype.child=function(pathString$jscomp$0){util.validateArgCount("Reference.child",1,1,arguments.length);if("number"===typeof pathString$jscomp$0)pathString$jscomp$0=String(pathString$jscomp$0);else if(!(pathString$jscomp$0 instanceof Path))if(null===
this.path.getFront()){var pathString=pathString$jscomp$0;pathString&&(pathString=pathString.replace(/^\/*\.info(\/|$)/,"/"));validatePathString("Reference.child",1,pathString,!1)}else validatePathString("Reference.child",1,pathString$jscomp$0,!1);return new Reference(this.repo,this.path.child(pathString$jscomp$0))};Reference.prototype.getParent=function(){util.validateArgCount("Reference.parent",0,0,arguments.length);var parentPath=this.path.parent();return null===parentPath?null:new Reference(this.repo,
parentPath)};Reference.prototype.getRoot=function(){util.validateArgCount("Reference.root",0,0,arguments.length);for(var ref=this;null!==ref.getParent();)ref=ref.getParent();return ref};Reference.prototype.databaseProp=function(){return this.repo.database};Reference.prototype.set=function(newVal,onComplete){util.validateArgCount("Reference.set",1,2,arguments.length);validateWritablePath("Reference.set",this.path);validateFirebaseDataArg("Reference.set",1,newVal,this.path,!1);util.validateCallback("Reference.set",
2,onComplete,!0);var deferred=new util.Deferred;this.repo.setWithPriority(this.path,newVal,null,deferred.wrapCallback(onComplete));return deferred.promise};Reference.prototype.update=function(objectToMerge,onComplete){util.validateArgCount("Reference.update",1,2,arguments.length);validateWritablePath("Reference.update",this.path);if(Array.isArray(objectToMerge)){for(var newObjectToMerge={},i=0;i<objectToMerge.length;++i)newObjectToMerge[""+i]=objectToMerge[i];objectToMerge=newObjectToMerge;warn("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}validateFirebaseMergeDataArg("Reference.update",
1,objectToMerge,this.path,!1);util.validateCallback("Reference.update",2,onComplete,!0);newObjectToMerge=new util.Deferred;this.repo.update(this.path,objectToMerge,newObjectToMerge.wrapCallback(onComplete));return newObjectToMerge.promise};Reference.prototype.setWithPriority=function(newVal,newPriority,onComplete){util.validateArgCount("Reference.setWithPriority",2,3,arguments.length);validateWritablePath("Reference.setWithPriority",this.path);validateFirebaseDataArg("Reference.setWithPriority",1,
newVal,this.path,!1);validatePriority("Reference.setWithPriority",2,newPriority,!1);util.validateCallback("Reference.setWithPriority",3,onComplete,!0);if(".length"===this.getKey()||".keys"===this.getKey())throw"Reference.setWithPriority failed: "+this.getKey()+" is a read-only object.";var deferred=new util.Deferred;this.repo.setWithPriority(this.path,newVal,newPriority,deferred.wrapCallback(onComplete));return deferred.promise};Reference.prototype.remove=function(onComplete){util.validateArgCount("Reference.remove",
0,1,arguments.length);validateWritablePath("Reference.remove",this.path);util.validateCallback("Reference.remove",1,onComplete,!0);return this.set(null,onComplete)};Reference.prototype.transaction=function(transactionUpdate,onComplete,applyLocally){util.validateArgCount("Reference.transaction",1,3,arguments.length);validateWritablePath("Reference.transaction",this.path);util.validateCallback("Reference.transaction",1,transactionUpdate,!1);util.validateCallback("Reference.transaction",2,onComplete,
!0);if(void 0!==applyLocally&&"boolean"!==typeof applyLocally)throw Error(util.errorPrefix("Reference.transaction",3,!0)+"must be a boolean.");if(".length"===this.getKey()||".keys"===this.getKey())throw"Reference.transaction failed: "+this.getKey()+" is a read-only object.";void 0===applyLocally&&(applyLocally=!0);var deferred=new util.Deferred;"function"===typeof onComplete&&deferred.promise.catch(function(){});this.repo.startTransaction(this.path,transactionUpdate,function(error,committed,snapshot){error?
deferred.reject(error):deferred.resolve(new TransactionResult(committed,snapshot));"function"===typeof onComplete&&onComplete(error,committed,snapshot)},applyLocally);return deferred.promise};Reference.prototype.setPriority=function(priority,onComplete){util.validateArgCount("Reference.setPriority",1,2,arguments.length);validateWritablePath("Reference.setPriority",this.path);validatePriority("Reference.setPriority",1,priority,!1);util.validateCallback("Reference.setPriority",2,onComplete,!0);var deferred=
new util.Deferred;this.repo.setWithPriority(this.path.child(".priority"),priority,null,deferred.wrapCallback(onComplete));return deferred.promise};Reference.prototype.push=function(value,onComplete){util.validateArgCount("Reference.push",0,2,arguments.length);validateWritablePath("Reference.push",this.path);validateFirebaseDataArg("Reference.push",1,value,this.path,!0);util.validateCallback("Reference.push",2,onComplete,!0);var now=this.repo.serverTime(),name=nextPushId(now);now=this.child(name);
var pushRef=this.child(name);name=null!=value?now.set(value,onComplete).then(function(){return pushRef}):Promise.resolve(pushRef);now.then=name.then.bind(name);now.catch=name.then.bind(name,void 0);"function"===typeof onComplete&&name.catch(function(){});return now};Reference.prototype.onDisconnect=function(){validateWritablePath("Reference.onDisconnect",this.path);return new OnDisconnect(this.repo,this.path)};Object.defineProperty(Reference.prototype,"database",{get:function(){return this.databaseProp()},
enumerable:!1,configurable:!0});Object.defineProperty(Reference.prototype,"key",{get:function(){return this.getKey()},enumerable:!1,configurable:!0});Object.defineProperty(Reference.prototype,"parent",{get:function(){return this.getParent()},enumerable:!1,configurable:!0});Object.defineProperty(Reference.prototype,"root",{get:function(){return this.getRoot()},enumerable:!1,configurable:!0});return Reference}(Query);Query.__referenceConstructor=Reference;SyncPoint.__referenceConstructor=Reference;
var TreeNode=function(){return function(){this.children={};this.childCount=0;this.value=null}}(),Tree=function(){function Tree(name_,parent_,node_){void 0===name_&&(name_="");void 0===parent_&&(parent_=null);void 0===node_&&(node_=new TreeNode);this.name_=name_;this.parent_=parent_;this.node_=node_}Tree.prototype.subTree=function(pathObj){pathObj=pathObj instanceof Path?pathObj:new Path(pathObj);for(var child=this,next=pathObj.getFront();null!==next;){var childNode=util.safeGet(child.node_.children,
next)||new TreeNode;child=new Tree(next,child,childNode);pathObj=pathObj.popFront();next=pathObj.getFront()}return child};Tree.prototype.getValue=function(){return this.node_.value};Tree.prototype.setValue=function(value){util.assert("undefined"!==typeof value,"Cannot set value to undefined");this.node_.value=value;this.updateParents_()};Tree.prototype.clear=function(){this.node_.value=null;this.node_.children={};this.node_.childCount=0;this.updateParents_()};Tree.prototype.hasChildren=function(){return 0<
this.node_.childCount};Tree.prototype.isEmpty=function(){return null===this.getValue()&&!this.hasChildren()};Tree.prototype.forEachChild=function(action){var _this=this;each(this.node_.children,function(child,childTree){action(new Tree(child,_this,childTree))})};Tree.prototype.forEachDescendant=function(action,includeSelf,childrenFirst){includeSelf&&!childrenFirst&&action(this);this.forEachChild(function(child){child.forEachDescendant(action,!0,childrenFirst)});includeSelf&&childrenFirst&&action(this)};
Tree.prototype.forEachAncestor=function(action,includeSelf){for(includeSelf=includeSelf?this:this.parent();null!==includeSelf;){if(action(includeSelf))return!0;includeSelf=includeSelf.parent()}return!1};Tree.prototype.forEachImmediateDescendantWithValue=function(action){this.forEachChild(function(child){null!==child.getValue()?action(child):child.forEachImmediateDescendantWithValue(action)})};Tree.prototype.path=function(){return new Path(null===this.parent_?this.name_:this.parent_.path()+"/"+this.name_)};
Tree.prototype.name=function(){return this.name_};Tree.prototype.parent=function(){return this.parent_};Tree.prototype.updateParents_=function(){null!==this.parent_&&this.parent_.updateChild_(this.name_,this)};Tree.prototype.updateChild_=function(childName,child){var childEmpty=child.isEmpty(),childExists=util.contains(this.node_.children,childName);childEmpty&&childExists?(delete this.node_.children[childName],this.node_.childCount--,this.updateParents_()):childEmpty||childExists||(this.node_.children[childName]=
child.node_,this.node_.childCount++,this.updateParents_())};return Tree}(),TransactionStatus;(function(TransactionStatus){TransactionStatus[TransactionStatus.RUN=0]="RUN";TransactionStatus[TransactionStatus.SENT=1]="SENT";TransactionStatus[TransactionStatus.COMPLETED=2]="COMPLETED";TransactionStatus[TransactionStatus.SENT_NEEDS_ABORT=3]="SENT_NEEDS_ABORT";TransactionStatus[TransactionStatus.NEEDS_ABORT=4]="NEEDS_ABORT"})(TransactionStatus||(TransactionStatus={}));Repo.MAX_TRANSACTION_RETRIES_=25;
Repo.prototype.transactionsInit_=function(){this.transactionQueueTree_=new Tree};Repo.prototype.startTransaction=function(path,transactionUpdate,onComplete,applyLocally){this.log_("transaction on "+path);var valueCallback=function(){},watchRef=new Reference(this,path);watchRef.on("value",valueCallback);transactionUpdate={path:path,update:transactionUpdate,onComplete:onComplete,status:null,order:LUIDGenerator(),applyLocally:applyLocally,retryCount:0,unwatcher:function(){watchRef.off("value",valueCallback)},
abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null};onComplete=this.getLatestState_(path);transactionUpdate.currentInputSnapshot=onComplete;applyLocally=transactionUpdate.update(onComplete.val());if(void 0===applyLocally)transactionUpdate.unwatcher(),transactionUpdate.currentOutputSnapshotRaw=null,transactionUpdate.currentOutputSnapshotResolved=null,transactionUpdate.onComplete&&(path=new DataSnapshot(transactionUpdate.currentInputSnapshot,
new Reference(this,transactionUpdate.path),PRIORITY_INDEX),transactionUpdate.onComplete(null,!1,path));else{validateFirebaseData("transaction failed: Data returned ",applyLocally,transactionUpdate.path);transactionUpdate.status=TransactionStatus.RUN;var queueNode=this.transactionQueueTree_.subTree(path),nodeQueue=queueNode.getValue()||[];nodeQueue.push(transactionUpdate);queueNode.setValue(nodeQueue);nodeQueue=void 0;"object"===typeof applyLocally&&null!==applyLocally&&util.contains(applyLocally,
".priority")?(nodeQueue=util.safeGet(applyLocally,".priority"),util.assert(isValidPriority(nodeQueue),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):nodeQueue=(this.serverSyncTree_.calcCompleteEventCache(path)||ChildrenNode.EMPTY_NODE).getPriority().val();queueNode=this.generateServerValues();applyLocally=nodeFromJSON$1(applyLocally,nodeQueue);onComplete=resolveDeferredValueSnapshot(applyLocally,onComplete,queueNode);transactionUpdate.currentOutputSnapshotRaw=
applyLocally;transactionUpdate.currentOutputSnapshotResolved=onComplete;transactionUpdate.currentWriteId=this.getNextWriteId_();transactionUpdate=this.serverSyncTree_.applyUserOverwrite(path,onComplete,transactionUpdate.currentWriteId,transactionUpdate.applyLocally);this.eventQueue_.raiseEventsForChangedPath(path,transactionUpdate);this.sendReadyTransactions_()}};Repo.prototype.getLatestState_=function(path,excludeSets){return this.serverSyncTree_.calcCompleteEventCache(path,excludeSets)||ChildrenNode.EMPTY_NODE};
Repo.prototype.sendReadyTransactions_=function(node){var _this=this;void 0===node&&(node=this.transactionQueueTree_);node||this.pruneCompletedTransactionsBelowNode_(node);if(null!==node.getValue()){var queue=this.buildTransactionQueue_(node);util.assert(0<queue.length,"Sending zero length transaction queue");queue.every(function(transaction){return transaction.status===TransactionStatus.RUN})&&this.sendTransactionQueue_(node.path(),queue)}else node.hasChildren()&&node.forEachChild(function(childNode){_this.sendReadyTransactions_(childNode)})};
Repo.prototype.sendTransactionQueue_=function(path,queue){var _this=this,setsToIgnore=queue.map(function(txn){return txn.currentWriteId}),latestState=this.getLatestState_(path,setsToIgnore);setsToIgnore=latestState;latestState=latestState.hash();for(var i$jscomp$0=0;i$jscomp$0<queue.length;i$jscomp$0++){var txn=queue[i$jscomp$0];util.assert(txn.status===TransactionStatus.RUN,"tryToSendTransactionQueue_: items in queue should all be run.");txn.status=TransactionStatus.SENT;txn.retryCount++;var relativePath=
Path.relativePath(path,txn.path);setsToIgnore=setsToIgnore.updateChild(relativePath,txn.currentOutputSnapshotRaw)}setsToIgnore=setsToIgnore.val(!0);this.server_.put(path.toString(),setsToIgnore,function(status){_this.log_("transaction put response",{path:path.toString(),status:status});var events=[];if("ok"===status){status=[];for(var i=0;i<queue.length;i++){queue[i].status=TransactionStatus.COMPLETED;events=events.concat(_this.serverSyncTree_.ackUserWrite(queue[i].currentWriteId));if(queue[i].onComplete){var node=
queue[i].currentOutputSnapshotResolved,ref=new Reference(_this,queue[i].path);node=new DataSnapshot(node,ref,PRIORITY_INDEX);status.push(queue[i].onComplete.bind(null,null,!0,node))}queue[i].unwatcher()}_this.pruneCompletedTransactionsBelowNode_(_this.transactionQueueTree_.subTree(path));_this.sendReadyTransactions_();_this.eventQueue_.raiseEventsForChangedPath(path,events);for(i=0;i<status.length;i++)exceptionGuard(status[i])}else{if("datastale"===status)for(i=0;i<queue.length;i++)queue[i].status=
queue[i].status===TransactionStatus.SENT_NEEDS_ABORT?TransactionStatus.NEEDS_ABORT:TransactionStatus.RUN;else for(warn("transaction at "+path.toString()+" failed: "+status),i=0;i<queue.length;i++)queue[i].status=TransactionStatus.NEEDS_ABORT,queue[i].abortReason=status;_this.rerunTransactions_(path)}},latestState)};Repo.prototype.rerunTransactions_=function(changedPath){var rootMostTransactionNode=this.getAncestorTransactionNode_(changedPath);changedPath=rootMostTransactionNode.path();rootMostTransactionNode=
this.buildTransactionQueue_(rootMostTransactionNode);this.rerunTransactionQueue_(rootMostTransactionNode,changedPath);return changedPath};Repo.prototype.rerunTransactionQueue_=function(queue,path){if(0!==queue.length){for(var callbacks=[],events=[],setsToIgnore=queue.filter(function(q){return q.status===TransactionStatus.RUN}).map(function(q){return q.currentWriteId}),i=0;i<queue.length;i++){var transaction=queue[i],relativePath=Path.relativePath(path,transaction.path),abortTransaction=!1,abortReason=
void 0;util.assert(null!==relativePath,"rerunTransactionsUnderNode_: relativePath should not be null.");if(transaction.status===TransactionStatus.NEEDS_ABORT)abortTransaction=!0,abortReason=transaction.abortReason,events=events.concat(this.serverSyncTree_.ackUserWrite(transaction.currentWriteId,!0));else if(transaction.status===TransactionStatus.RUN)if(transaction.retryCount>=Repo.MAX_TRANSACTION_RETRIES_)abortTransaction=!0,abortReason="maxretry",events=events.concat(this.serverSyncTree_.ackUserWrite(transaction.currentWriteId,
!0));else{var currentNode=this.getLatestState_(transaction.path,setsToIgnore);transaction.currentInputSnapshot=currentNode;var newData=queue[i].update(currentNode.val());if(void 0!==newData){validateFirebaseData("transaction failed: Data returned ",newData,transaction.path);relativePath=nodeFromJSON$1(newData);"object"===typeof newData&&null!=newData&&util.contains(newData,".priority")||(relativePath=relativePath.updatePriority(currentNode.getPriority()));newData=transaction.currentWriteId;var serverValues=
this.generateServerValues();currentNode=resolveDeferredValueSnapshot(relativePath,currentNode,serverValues);transaction.currentOutputSnapshotRaw=relativePath;transaction.currentOutputSnapshotResolved=currentNode;transaction.currentWriteId=this.getNextWriteId_();setsToIgnore.splice(setsToIgnore.indexOf(newData),1);events=events.concat(this.serverSyncTree_.applyUserOverwrite(transaction.path,currentNode,transaction.currentWriteId,transaction.applyLocally));events=events.concat(this.serverSyncTree_.ackUserWrite(newData,
!0))}else abortTransaction=!0,abortReason="nodata",events=events.concat(this.serverSyncTree_.ackUserWrite(transaction.currentWriteId,!0))}this.eventQueue_.raiseEventsForChangedPath(path,events);events=[];abortTransaction&&(queue[i].status=TransactionStatus.COMPLETED,setTimeout(queue[i].unwatcher,0),queue[i].onComplete&&("nodata"===abortReason?(transaction=new Reference(this,queue[i].path),transaction=new DataSnapshot(queue[i].currentInputSnapshot,transaction,PRIORITY_INDEX),callbacks.push(queue[i].onComplete.bind(null,
null,!1,transaction))):callbacks.push(queue[i].onComplete.bind(null,Error(abortReason),!1,null))))}this.pruneCompletedTransactionsBelowNode_(this.transactionQueueTree_);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i]);this.sendReadyTransactions_()}};Repo.prototype.getAncestorTransactionNode_=function(path){var front,transactionNode=this.transactionQueueTree_;for(front=path.getFront();null!==front&&null===transactionNode.getValue();)transactionNode=transactionNode.subTree(front),path=path.popFront(),
front=path.getFront();return transactionNode};Repo.prototype.buildTransactionQueue_=function(transactionNode){var transactionQueue=[];this.aggregateTransactionQueuesForNode_(transactionNode,transactionQueue);transactionQueue.sort(function(a,b){return a.order-b.order});return transactionQueue};Repo.prototype.aggregateTransactionQueuesForNode_=function(node,queue){var _this=this,nodeQueue=node.getValue();if(null!==nodeQueue)for(var i=0;i<nodeQueue.length;i++)queue.push(nodeQueue[i]);node.forEachChild(function(child){_this.aggregateTransactionQueuesForNode_(child,
queue)})};Repo.prototype.pruneCompletedTransactionsBelowNode_=function(node){var _this=this,queue=node.getValue();if(queue){for(var to=0,from=0;from<queue.length;from++)queue[from].status!==TransactionStatus.COMPLETED&&(queue[to]=queue[from],to++);queue.length=to;node.setValue(0<queue.length?queue:null)}node.forEachChild(function(childNode){_this.pruneCompletedTransactionsBelowNode_(childNode)})};Repo.prototype.abortTransactions_=function(path){var _this=this,affectedPath=this.getAncestorTransactionNode_(path).path();
path=this.transactionQueueTree_.subTree(path);path.forEachAncestor(function(node){_this.abortTransactionsOnNode_(node)});this.abortTransactionsOnNode_(path);path.forEachDescendant(function(node){_this.abortTransactionsOnNode_(node)});return affectedPath};Repo.prototype.abortTransactionsOnNode_=function(node){var queue=node.getValue();if(null!==queue){for(var callbacks=[],events=[],lastSent=-1,i=0;i<queue.length;i++)queue[i].status!==TransactionStatus.SENT_NEEDS_ABORT&&(queue[i].status===TransactionStatus.SENT?
(util.assert(lastSent===i-1,"All SENT items should be at beginning of queue."),lastSent=i,queue[i].status=TransactionStatus.SENT_NEEDS_ABORT,queue[i].abortReason="set"):(util.assert(queue[i].status===TransactionStatus.RUN,"Unexpected transaction status in abort"),queue[i].unwatcher(),events=events.concat(this.serverSyncTree_.ackUserWrite(queue[i].currentWriteId,!0)),queue[i].onComplete&&callbacks.push(queue[i].onComplete.bind(null,Error("set"),!1,null))));-1===lastSent?node.setValue(null):queue.length=
lastSent+1;this.eventQueue_.raiseEventsForChangedPath(node.path(),events);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i])}};var FirebaseAuthTokenProvider=function(){function FirebaseAuthTokenProvider(app_,authProvider_){var _this=this;this.app_=app_;this.authProvider_=authProvider_;this.auth_=null;(this.auth_=authProvider_.getImmediate({optional:!0}))||authProvider_.get().then(function(auth){return _this.auth_=auth})}FirebaseAuthTokenProvider.prototype.getToken=function(forceRefresh){return this.auth_?
this.auth_.getToken(forceRefresh).catch(function(error){return error&&"auth/token-not-initialized"===error.code?(log("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(error)}):Promise.resolve(null)};FirebaseAuthTokenProvider.prototype.addTokenChangeListener=function(listener){this.auth_?this.auth_.addAuthTokenListener(listener):(setTimeout(function(){return listener(null)},0),this.authProvider_.get().then(function(auth){return auth.addAuthTokenListener(listener)}))};
FirebaseAuthTokenProvider.prototype.removeTokenChangeListener=function(listener){this.authProvider_.get().then(function(auth){return auth.removeAuthTokenListener(listener)})};FirebaseAuthTokenProvider.prototype.notifyForInvalidToken=function(){var errorMessage='Provided authentication credentials for the app named "'+this.app_.name+'" are invalid. This usually indicates your app was not initialized correctly. ';errorMessage="credential"in this.app_.options?errorMessage+'Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':
"serviceAccount"in this.app_.options?errorMessage+'Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':errorMessage+'Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.';warn(errorMessage)};return FirebaseAuthTokenProvider}(),EmulatorAdminTokenProvider=function(){function EmulatorAdminTokenProvider(){}
EmulatorAdminTokenProvider.prototype.getToken=function(forceRefresh){return Promise.resolve({accessToken:EmulatorAdminTokenProvider.EMULATOR_AUTH_TOKEN})};EmulatorAdminTokenProvider.prototype.addTokenChangeListener=function(listener){listener(EmulatorAdminTokenProvider.EMULATOR_AUTH_TOKEN)};EmulatorAdminTokenProvider.prototype.removeTokenChangeListener=function(listener){};EmulatorAdminTokenProvider.prototype.notifyForInvalidToken=function(){};EmulatorAdminTokenProvider.EMULATOR_AUTH_TOKEN="owner";
return EmulatorAdminTokenProvider}(),_staticInstance,RepoManager=function(){function RepoManager(){this.repos_={};this.useRestClient_=!1}RepoManager.getInstance=function(){_staticInstance||(_staticInstance=new RepoManager);return _staticInstance};RepoManager.prototype.interrupt=function(){var _a,e_2,_b;try{for(var _c=tslib.__values(Object.keys(this.repos_)),_d=_c.next();!_d.done;_d=_c.next()){var appName=_d.value;try{for(var _e=(e_2=void 0,tslib.__values(Object.keys(this.repos_[appName]))),_f=_e.next();!_f.done;_f=
_e.next())this.repos_[appName][_f.value].interrupt()}catch(e_2_1){e_2={error:e_2_1}}finally{try{_f&&!_f.done&&(_b=_e.return)&&_b.call(_e)}finally{if(e_2)throw e_2.error;}}}}catch(e_1_1){var e_1={error:e_1_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_1)throw e_1.error;}}};RepoManager.prototype.resume=function(){var _a,e_4,_b;try{for(var _c=tslib.__values(Object.keys(this.repos_)),_d=_c.next();!_d.done;_d=_c.next()){var appName=_d.value;try{for(var _e=(e_4=void 0,tslib.__values(Object.keys(this.repos_[appName]))),
_f=_e.next();!_f.done;_f=_e.next())this.repos_[appName][_f.value].resume()}catch(e_4_1){e_4={error:e_4_1}}finally{try{_f&&!_f.done&&(_b=_e.return)&&_b.call(_e)}finally{if(e_4)throw e_4.error;}}}}catch(e_3_1){var e_3={error:e_3_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_3)throw e_3.error;}}};RepoManager.prototype.databaseFromApp=function(app,authProvider,url){url=url||app.options.databaseURL;void 0===url&&fatal("Can't determine Firebase Database URL.  Be sure to include databaseURL option when calling firebase.initializeApp().");
url=parseRepoInfo(url);var repoInfo=url.repoInfo,dbEmulatorHost=void 0;"undefined"!==typeof process&&(dbEmulatorHost=process.env.FIREBASE_DATABASE_EMULATOR_HOST);if(dbEmulatorHost){var isEmulator=!0;url="http://"+dbEmulatorHost+"?ns\x3d"+repoInfo.namespace;url=parseRepoInfo(url);repoInfo=url.repoInfo}else isEmulator=!url.repoInfo.secure;authProvider=util.CONSTANTS.NODE_ADMIN&&isEmulator?new EmulatorAdminTokenProvider:new FirebaseAuthTokenProvider(app,authProvider);validateUrl("Invalid Firebase Database URL",
1,url);url.path.isEmpty()||fatal("Database URL must point to the root of a Firebase Database (not including a child path).");return this.createRepo(repoInfo,app,authProvider).database};RepoManager.prototype.deleteRepo=function(repo){var appRepos=util.safeGet(this.repos_,repo.app.name);appRepos&&util.safeGet(appRepos,repo.repoInfo_.toURLString())===repo||fatal("Database "+repo.app.name+"("+repo.repoInfo_+") has already been deleted.");repo.interrupt();delete appRepos[repo.repoInfo_.toURLString()]};
RepoManager.prototype.createRepo=function(repoInfo,app,authTokenProvider){var appRepos=util.safeGet(this.repos_,app.name);appRepos||(appRepos={},this.repos_[app.name]=appRepos);var repo=util.safeGet(appRepos,repoInfo.toURLString());repo&&fatal("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call.");repo=new Repo(repoInfo,this.useRestClient_,app,authTokenProvider);return appRepos[repoInfo.toURLString()]=repo};RepoManager.prototype.forceRestClient=
function(forceRestClient){this.useRestClient_=forceRestClient};return RepoManager}(),Database$jscomp$0=function(){function Database(repo_){this.repo_=repo_;repo_ instanceof Repo||fatal("Don't call new Database() directly - please use firebase.database().");this.root_=new Reference(repo_,Path.Empty);this.INTERNAL=new DatabaseInternals(this)}Object.defineProperty(Database.prototype,"app",{get:function(){return this.repo_.app},enumerable:!1,configurable:!0});Database.prototype.ref=function(path){this.checkDeleted_("ref");
util.validateArgCount("database.ref",0,1,arguments.length);return path instanceof Reference?this.refFromURL(path.toString()):void 0!==path?this.root_.child(path):this.root_};Database.prototype.refFromURL=function(url){this.checkDeleted_("database.refFromURL");util.validateArgCount("database.refFromURL",1,1,arguments.length);var parsedURL=parseRepoInfo(url);validateUrl("database.refFromURL",1,parsedURL);var repoInfo=parsedURL.repoInfo;repoInfo.host!==this.repo_.repoInfo_.host&&fatal("database.refFromURL: Host name does not match the current database: (found "+
repoInfo.host+" but expected "+this.repo_.repoInfo_.host+")");return this.ref(parsedURL.path.toString())};Database.prototype.checkDeleted_=function(apiName){null===this.repo_&&fatal("Cannot call "+apiName+" on a deleted database.")};Database.prototype.goOffline=function(){util.validateArgCount("database.goOffline",0,0,arguments.length);this.checkDeleted_("goOffline");this.repo_.interrupt()};Database.prototype.goOnline=function(){util.validateArgCount("database.goOnline",0,0,arguments.length);this.checkDeleted_("goOnline");
this.repo_.resume()};Database.ServerValue={TIMESTAMP:{".sv":"timestamp"},increment:function(delta){return{".sv":{increment:delta}}}};return Database}(),DatabaseInternals=function(){function DatabaseInternals(database){this.database=database}DatabaseInternals.prototype.delete=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_a){this.database.checkDeleted_("delete");RepoManager.getInstance().deleteRepo(this.database.repo_);this.database.repo_=null;
this.database.root_=null;this.database=this.database.INTERNAL=null;return[2]})})};return DatabaseInternals}(),INTERNAL=Object.freeze({__proto__:null,forceLongPolling:function(){WebSocketConnection.forceDisallow();BrowserPollConnection.forceAllow()},forceWebSockets:function(){BrowserPollConnection.forceDisallow()},isWebSocketsAvailable:function(){return WebSocketConnection.isAvailable()},setSecurityDebugCallback:function(ref,callback){ref.repo.persistentConnection_.securityDebugCallback_=callback},
stats:function(ref,showDelta){ref.repo.stats(showDelta)},statsIncrementCounter:function(ref,metric){ref.repo.statsIncrementCounter(metric)},dataUpdateCount:function(ref){return ref.repo.dataUpdateCount},interceptServerData:function(ref,callback){return ref.repo.interceptServerData_(callback)}});PersistentConnection.prototype.simpleListen=function(pathString,onComplete){this.sendRequest("q",{p:pathString},onComplete)};PersistentConnection.prototype.echo=function(data,onEcho){this.sendRequest("echo",
{d:data},onEcho)};var TEST_ACCESS=Object.freeze({__proto__:null,DataConnection:PersistentConnection,RealTimeConnection:Connection,hijackHash:function(newHash){var oldPut=PersistentConnection.prototype.put;PersistentConnection.prototype.put=function(pathString,data,onComplete,hash){void 0!==hash&&(hash=newHash());oldPut.call(this,pathString,data,onComplete,hash)};return function(){PersistentConnection.prototype.put=oldPut}},ConnectionTarget:RepoInfo,queryIdentifier:function(query){return query.queryIdentifier()},
forceRestClient:function(forceRestClient){RepoManager.getInstance().forceRestClient(forceRestClient)}}),ServerValue=Database$jscomp$0.ServerValue;registerDatabase(firebase);exports.DataSnapshot=DataSnapshot;exports.Database=Database$jscomp$0;exports.OnDisconnect=OnDisconnect;exports.Query=Query;exports.Reference=Reference;exports.ServerValue=ServerValue;exports.enableLogging=enableLogging;exports.registerDatabase=registerDatabase}
//# sourceMappingURL=module$node_modules$$firebase$database$dist$index_cjs.js.map
