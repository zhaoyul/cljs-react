shadow$provide.module$node_modules$$firebase$installations$dist$index_cjs=function(global,require,module,exports){function isServerError(error){return error instanceof util.FirebaseError&&error.code.includes("request-failed")}function getInstallationsEndpoint(_a){return"https://firebaseinstallations.googleapis.com/v1/projects/"+_a.projectId+"/installations"}function extractAuthTokenInfoFromResponse(response){return{token:response.token,requestStatus:2,expiresIn:Number(response.expiresIn.replace("s",
"000")),creationTime:Date.now()}}function getErrorFromResponse(requestName,response){return tslib.__awaiter(this,void 0,void 0,function(){var responseJson,errorData;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,response.json()];case 1:return responseJson=_a.sent(),errorData=responseJson.error,[2,ERROR_FACTORY.create("request-failed",{requestName:requestName,serverCode:errorData.code,serverMessage:errorData.message,serverStatus:errorData.status})]}})})}function getHeaders(_a){return new Headers({"Content-Type":"application/json",
Accept:"application/json","x-goog-api-key":_a.apiKey})}function getHeadersWithAuth(appConfig,_a){_a=_a.refreshToken;appConfig=getHeaders(appConfig);appConfig.append("Authorization","FIS_v2 "+_a);return appConfig}function retryIfServerError(fn){return tslib.__awaiter(this,void 0,void 0,function(){var result;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,fn()];case 1:return result=_a.sent(),500<=result.status&&600>result.status?[2,fn()]:[2,result]}})})}function createInstallationRequest(appConfig,
_a){var fid=_a.fid;return tslib.__awaiter(this,void 0,void 0,function(){var endpoint,headers,body,request,response,responseValue,registeredInstallationEntry;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return endpoint=getInstallationsEndpoint(appConfig),headers=getHeaders(appConfig),body={fid:fid,authVersion:"FIS_v2",appId:appConfig.appId,sdkVersion:"w:0.4.16"},request={method:"POST",headers:headers,body:JSON.stringify(body)},[4,retryIfServerError(function(){return fetch(endpoint,
request)})];case 1:return response=_b.sent(),response.ok?[4,response.json()]:[3,3];case 2:return responseValue=_b.sent(),registeredInstallationEntry={fid:responseValue.fid||fid,registrationStatus:2,refreshToken:responseValue.refreshToken,authToken:extractAuthTokenInfoFromResponse(responseValue.authToken)},[2,registeredInstallationEntry];case 3:return[4,getErrorFromResponse("Create Installation",response)];case 4:throw _b.sent();}})})}function sleep(ms){return new Promise(function(resolve){setTimeout(resolve,
ms)})}function getKey(appConfig){return appConfig.appName+"!"+appConfig.appId}function addCallback(appConfig,callback){getBroadcastChannel();appConfig=getKey(appConfig);var callbackSet=fidChangeCallbacks.get(appConfig);callbackSet||(callbackSet=new Set,fidChangeCallbacks.set(appConfig,callbackSet));callbackSet.add(callback)}function callFidChangeCallbacks(key,fid){var _a;if(key=fidChangeCallbacks.get(key))try{for(var callbacks_1=tslib.__values(key),callbacks_1_1=callbacks_1.next();!callbacks_1_1.done;callbacks_1_1=
callbacks_1.next()){var callback=callbacks_1_1.value;callback(fid)}}catch(e_1_1){var e_1={error:e_1_1}}finally{try{callbacks_1_1&&!callbacks_1_1.done&&(_a=callbacks_1.return)&&_a.call(callbacks_1)}finally{if(e_1)throw e_1.error;}}}function broadcastFidChange(key,fid){var channel=getBroadcastChannel();channel&&channel.postMessage({key:key,fid:fid});closeBroadcastChannel()}function getBroadcastChannel(){!broadcastChannel&&"BroadcastChannel"in self&&(broadcastChannel=new BroadcastChannel("[Firebase] FID Change"),
broadcastChannel.onmessage=function(e){callFidChangeCallbacks(e.data.key,e.data.fid)});return broadcastChannel}function closeBroadcastChannel(){0===fidChangeCallbacks.size&&broadcastChannel&&(broadcastChannel.close(),broadcastChannel=null)}function getDbPromise(){dbPromise||(dbPromise=idb.openDb("firebase-installations-database",1,function(upgradeDB){switch(upgradeDB.oldVersion){case 0:upgradeDB.createObjectStore("firebase-installations-store")}}));return dbPromise}function set(appConfig,value){return tslib.__awaiter(this,
void 0,void 0,function(){var key$jscomp$0,db,tx,objectStore,oldValue;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return key$jscomp$0=getKey(appConfig),[4,getDbPromise()];case 1:return db=_a.sent(),tx=db.transaction("firebase-installations-store","readwrite"),objectStore=tx.objectStore("firebase-installations-store"),[4,objectStore.get(key$jscomp$0)];case 2:return oldValue=_a.sent(),[4,objectStore.put(value,key$jscomp$0)];case 3:return _a.sent(),[4,tx.complete];case 4:_a.sent();
if(!oldValue||oldValue.fid!==value.fid){_a=value.fid;var key=getKey(appConfig);callFidChangeCallbacks(key,_a);broadcastFidChange(key,_a)}return[2,value]}})})}function remove(appConfig){return tslib.__awaiter(this,void 0,void 0,function(){var key,db,tx;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return key=getKey(appConfig),[4,getDbPromise()];case 1:return db=_a.sent(),tx=db.transaction("firebase-installations-store","readwrite"),[4,tx.objectStore("firebase-installations-store").delete(key)];
case 2:return _a.sent(),[4,tx.complete];case 3:return _a.sent(),[2]}})})}function update(appConfig,updateFn){return tslib.__awaiter(this,void 0,void 0,function(){var key$jscomp$0,db,tx,store,oldValue,newValue;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return key$jscomp$0=getKey(appConfig),[4,getDbPromise()];case 1:return db=_a.sent(),tx=db.transaction("firebase-installations-store","readwrite"),store=tx.objectStore("firebase-installations-store"),[4,store.get(key$jscomp$0)];
case 2:return oldValue=_a.sent(),newValue=updateFn(oldValue),void 0!==newValue?[3,4]:[4,store.delete(key$jscomp$0)];case 3:return _a.sent(),[3,6];case 4:return[4,store.put(newValue,key$jscomp$0)];case 5:_a.sent(),_a.label=6;case 6:return[4,tx.complete];case 7:_a.sent();if(newValue&&(!oldValue||oldValue.fid!==newValue.fid)){_a=newValue.fid;var key=getKey(appConfig);callFidChangeCallbacks(key,_a);broadcastFidChange(key,_a)}return[2,newValue]}})})}function getInstallationEntry(appConfig){return tslib.__awaiter(this,
void 0,void 0,function(){var registrationPromise,installationEntry,_a;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return[4,update(appConfig,function(oldEntry){if(!oldEntry){try{var fidByteArray=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(fidByteArray);fidByteArray[0]=112+fidByteArray[0]%16;var fid=btoa(String.fromCharCode.apply(String,tslib.__spread(fidByteArray))).replace(/\+/g,"-").replace(/\//g,"_").substr(0,22);var installationEntry=VALID_FID_PATTERN.test(fid)?
fid:""}catch(_a$35){installationEntry=""}oldEntry={fid:installationEntry,registrationStatus:0}}installationEntry=clearTimedOutRequest(oldEntry);0===installationEntry.registrationStatus?navigator.onLine?(installationEntry={fid:installationEntry.fid,registrationStatus:1,registrationTime:Date.now()},fidByteArray=registerInstallation(appConfig,installationEntry),installationEntry={installationEntry:installationEntry,registrationPromise:fidByteArray}):(fidByteArray=Promise.reject(ERROR_FACTORY.create("app-offline")),
installationEntry={installationEntry:installationEntry,registrationPromise:fidByteArray}):installationEntry=1===installationEntry.registrationStatus?{installationEntry:installationEntry,registrationPromise:waitUntilFidRegistration(appConfig)}:{installationEntry:installationEntry};registrationPromise=installationEntry.registrationPromise;return installationEntry.installationEntry})];case 1:installationEntry=_b.sent();if(""!==installationEntry.fid)return[3,3];_a={};return[4,registrationPromise];case 2:return[2,
(_a.installationEntry=_b.sent(),_a)];case 3:return[2,{installationEntry:installationEntry,registrationPromise:registrationPromise}]}})})}function registerInstallation(appConfig,installationEntry){return tslib.__awaiter(this,void 0,void 0,function(){var registeredInstallationEntry,e_1;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,7]),[4,createInstallationRequest(appConfig,installationEntry)];case 1:return registeredInstallationEntry=_a.sent(),[2,set(appConfig,
registeredInstallationEntry)];case 2:return e_1=_a.sent(),isServerError(e_1)&&409===e_1.serverCode?[4,remove(appConfig)]:[3,4];case 3:return _a.sent(),[3,6];case 4:return[4,set(appConfig,{fid:installationEntry.fid,registrationStatus:0})];case 5:_a.sent(),_a.label=6;case 6:throw e_1;case 7:return[2]}})})}function waitUntilFidRegistration(appConfig){return tslib.__awaiter(this,void 0,void 0,function(){var entry,_a,installationEntry,registrationPromise;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return[4,
updateInstallationRequest(appConfig)];case 1:entry=_b.sent(),_b.label=2;case 2:return 1!==entry.registrationStatus?[3,5]:[4,sleep(100)];case 3:return _b.sent(),[4,updateInstallationRequest(appConfig)];case 4:return entry=_b.sent(),[3,2];case 5:return 0!==entry.registrationStatus?[3,7]:[4,getInstallationEntry(appConfig)];case 6:return _a=_b.sent(),installationEntry=_a.installationEntry,(registrationPromise=_a.registrationPromise)?[2,registrationPromise]:[2,installationEntry];case 7:return[2,entry]}})})}
function updateInstallationRequest(appConfig){return update(appConfig,function(oldEntry){if(!oldEntry)throw ERROR_FACTORY.create("installation-not-found");return clearTimedOutRequest(oldEntry)})}function clearTimedOutRequest(entry){return 1===entry.registrationStatus&&entry.registrationTime+1E4<Date.now()?{fid:entry.fid,registrationStatus:0}:entry}function generateAuthTokenRequest(_a,installationEntry){var appConfig=_a.appConfig,platformLoggerProvider=_a.platformLoggerProvider;return tslib.__awaiter(this,
void 0,void 0,function(){var endpoint,headers,platformLogger,body,request,response,responseValue,completedAuthToken;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return endpoint=getGenerateAuthTokenEndpoint(appConfig,installationEntry),headers=getHeadersWithAuth(appConfig,installationEntry),(platformLogger=platformLoggerProvider.getImmediate({optional:!0}))&&headers.append("x-firebase-client",platformLogger.getPlatformInfoString()),body={installation:{sdkVersion:"w:0.4.16"}},
request={method:"POST",headers:headers,body:JSON.stringify(body)},[4,retryIfServerError(function(){return fetch(endpoint,request)})];case 1:return response=_b.sent(),response.ok?[4,response.json()]:[3,3];case 2:return responseValue=_b.sent(),completedAuthToken=extractAuthTokenInfoFromResponse(responseValue),[2,completedAuthToken];case 3:return[4,getErrorFromResponse("Generate Auth Token",response)];case 4:throw _b.sent();}})})}function getGenerateAuthTokenEndpoint(appConfig,_a){_a=_a.fid;return getInstallationsEndpoint(appConfig)+
"/"+_a+"/authTokens:generate"}function refreshAuthToken(dependencies,forceRefresh){void 0===forceRefresh&&(forceRefresh=!1);return tslib.__awaiter(this,void 0,void 0,function(){var tokenPromise,entry,authToken,_a;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return[4,update(dependencies.appConfig,function(oldEntry){if(void 0===oldEntry||2!==oldEntry.registrationStatus)throw ERROR_FACTORY.create("not-registered");var oldAuthToken=oldEntry.authToken,JSCompiler_temp;(JSCompiler_temp=
forceRefresh)||(JSCompiler_temp=2!==oldAuthToken.requestStatus)||(JSCompiler_temp=Date.now(),JSCompiler_temp=JSCompiler_temp<oldAuthToken.creationTime||oldAuthToken.creationTime+oldAuthToken.expiresIn<JSCompiler_temp+36E5);if(JSCompiler_temp){if(1===oldAuthToken.requestStatus)return tokenPromise=waitUntilAuthTokenRequest(dependencies,forceRefresh),oldEntry;if(!navigator.onLine)throw ERROR_FACTORY.create("app-offline");oldAuthToken={requestStatus:1,requestTime:Date.now()};oldEntry=tslib.__assign(tslib.__assign({},
oldEntry),{authToken:oldAuthToken});tokenPromise=fetchAuthTokenFromServer(dependencies,oldEntry);return oldEntry}return oldEntry})];case 1:return entry=_b.sent(),tokenPromise?[4,tokenPromise]:[3,3];case 2:return _a=_b.sent(),[3,4];case 3:_a=entry.authToken,_b.label=4;case 4:return authToken=_a,[2,authToken]}})})}function waitUntilAuthTokenRequest(dependencies,forceRefresh){return tslib.__awaiter(this,void 0,void 0,function(){var entry,authToken;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,
updateAuthTokenRequest(dependencies.appConfig)];case 1:entry=_a.sent(),_a.label=2;case 2:return 1!==entry.authToken.requestStatus?[3,5]:[4,sleep(100)];case 3:return _a.sent(),[4,updateAuthTokenRequest(dependencies.appConfig)];case 4:return entry=_a.sent(),[3,2];case 5:return authToken=entry.authToken,0===authToken.requestStatus?[2,refreshAuthToken(dependencies,forceRefresh)]:[2,authToken]}})})}function updateAuthTokenRequest(appConfig){return update(appConfig,function(oldEntry){if(void 0===oldEntry||
2!==oldEntry.registrationStatus)throw ERROR_FACTORY.create("not-registered");var oldAuthToken=oldEntry.authToken;return 1===oldAuthToken.requestStatus&&oldAuthToken.requestTime+1E4<Date.now()?tslib.__assign(tslib.__assign({},oldEntry),{authToken:{requestStatus:0}}):oldEntry})}function fetchAuthTokenFromServer(dependencies,installationEntry){return tslib.__awaiter(this,void 0,void 0,function(){var authToken,updatedInstallationEntry,e_1;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,
3,,8]),[4,generateAuthTokenRequest(dependencies,installationEntry)];case 1:return authToken=_a.sent(),updatedInstallationEntry=tslib.__assign(tslib.__assign({},installationEntry),{authToken:authToken}),[4,set(dependencies.appConfig,updatedInstallationEntry)];case 2:return _a.sent(),[2,authToken];case 3:return e_1=_a.sent(),!isServerError(e_1)||401!==e_1.serverCode&&404!==e_1.serverCode?[3,5]:[4,remove(dependencies.appConfig)];case 4:return _a.sent(),[3,7];case 5:return updatedInstallationEntry=tslib.__assign(tslib.__assign({},
installationEntry),{authToken:{requestStatus:0}}),[4,set(dependencies.appConfig,updatedInstallationEntry)];case 6:_a.sent(),_a.label=7;case 7:throw e_1;case 8:return[2]}})})}function getId(dependencies){return tslib.__awaiter(this,void 0,void 0,function(){var _a,installationEntry,registrationPromise;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return[4,getInstallationEntry(dependencies.appConfig)];case 1:return _a=_b.sent(),installationEntry=_a.installationEntry,(registrationPromise=
_a.registrationPromise)?registrationPromise.catch(console.error):refreshAuthToken(dependencies).catch(console.error),[2,installationEntry.fid]}})})}function getToken(dependencies,forceRefresh){void 0===forceRefresh&&(forceRefresh=!1);return tslib.__awaiter(this,void 0,void 0,function(){var authToken;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,completeInstallationRegistration(dependencies.appConfig)];case 1:return _a.sent(),[4,refreshAuthToken(dependencies,forceRefresh)];
case 2:return authToken=_a.sent(),[2,authToken.token]}})})}function completeInstallationRegistration(appConfig){return tslib.__awaiter(this,void 0,void 0,function(){var registrationPromise;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,getInstallationEntry(appConfig)];case 1:return(registrationPromise=_a.sent().registrationPromise)?[4,registrationPromise]:[3,3];case 2:_a.sent(),_a.label=3;case 3:return[2]}})})}function deleteInstallationRequest(appConfig,installationEntry){return tslib.__awaiter(this,
void 0,void 0,function(){var endpoint,headers,request,response;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return endpoint=getDeleteEndpoint(appConfig,installationEntry),headers=getHeadersWithAuth(appConfig,installationEntry),request={method:"DELETE",headers:headers},[4,retryIfServerError(function(){return fetch(endpoint,request)})];case 1:return response=_a.sent(),response.ok?[3,3]:[4,getErrorFromResponse("Delete Installation",response)];case 2:throw _a.sent();case 3:return[2]}})})}
function getDeleteEndpoint(appConfig,_a){_a=_a.fid;return getInstallationsEndpoint(appConfig)+"/"+_a}function deleteInstallation(dependencies){return tslib.__awaiter(this,void 0,void 0,function(){var appConfig,entry;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return appConfig=dependencies.appConfig,[4,update(appConfig,function(oldEntry){if(!oldEntry||0!==oldEntry.registrationStatus)return oldEntry})];case 1:entry=_a.sent();if(!entry)return[3,6];if(1!==entry.registrationStatus)return[3,
2];throw ERROR_FACTORY.create("delete-pending-registration");case 2:if(2!==entry.registrationStatus)return[3,6];if(navigator.onLine)return[3,3];throw ERROR_FACTORY.create("app-offline");case 3:return[4,deleteInstallationRequest(appConfig,entry)];case 4:return _a.sent(),[4,remove(appConfig)];case 5:_a.sent(),_a.label=6;case 6:return[2]}})})}function onIdChange(_a,callback){var appConfig=_a.appConfig;addCallback(appConfig,callback);return function(){var key=getKey(appConfig),callbackSet=fidChangeCallbacks.get(key);
callbackSet&&(callbackSet.delete(callback),0===callbackSet.size&&fidChangeCallbacks.delete(key),closeBroadcastChannel())}}function extractAppConfig(app){var _a;if(!app||!app.options)throw getMissingValueError("App Configuration");if(!app.name)throw getMissingValueError("App Name");var configKeys=["projectId","apiKey","appId"];try{for(var configKeys_1=tslib.__values(configKeys),configKeys_1_1=configKeys_1.next();!configKeys_1_1.done;configKeys_1_1=configKeys_1.next()){var keyName=configKeys_1_1.value;
if(!app.options[keyName])throw getMissingValueError(keyName);}}catch(e_1_1){var e_1={error:e_1_1}}finally{try{configKeys_1_1&&!configKeys_1_1.done&&(_a=configKeys_1.return)&&_a.call(configKeys_1)}finally{if(e_1)throw e_1.error;}}return{appName:app.name,projectId:app.options.projectId,apiKey:app.options.apiKey,appId:app.options.appId}}function getMissingValueError(valueName){return ERROR_FACTORY.create("missing-app-config-values",{valueName:valueName})}function registerInstallations(instance){instance.INTERNAL.registerComponent(new component.Component("installations",
function(container){var app=container.getProvider("app").getImmediate(),appConfig=extractAppConfig(app);container=container.getProvider("platform-logger");var dependencies={appConfig:appConfig,platformLoggerProvider:container};return{app:app,getId:function(){return getId(dependencies)},getToken:function(forceRefresh){return getToken(dependencies,forceRefresh)},delete:function(){return deleteInstallation(dependencies)},onIdChange:function(callback){return onIdChange(dependencies,callback)}}},"PUBLIC"));
instance.registerVersion("@firebase/installations","0.4.16")}Object.defineProperty(exports,"__esModule",{value:!0});global=function(ex){return ex&&"object"===typeof ex&&"default"in ex?ex["default"]:ex}(require("module$node_modules$$firebase$app$dist$index_cjs"));var component=require("module$node_modules$$firebase$component$dist$index_cjs"),tslib=require("module$node_modules$tslib$tslib"),util=require("module$node_modules$$firebase$util$dist$index_cjs"),idb=require("module$node_modules$idb$build$idb"),
_a$jscomp$0;require=(_a$jscomp$0={},_a$jscomp$0["missing-app-config-values"]='Missing App configuration value: "{$valueName}"',_a$jscomp$0["not-registered"]="Firebase Installation is not registered.",_a$jscomp$0["installation-not-found"]="Firebase Installation not found.",_a$jscomp$0["request-failed"]='{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',_a$jscomp$0["app-offline"]="Could not process request. Application offline.",_a$jscomp$0["delete-pending-registration"]=
"Can't delete installation while there is a pending registration request.",_a$jscomp$0);var ERROR_FACTORY=new util.ErrorFactory("installations","Installations",require),VALID_FID_PATTERN=/^[cdef][\w-]{21}$/,fidChangeCallbacks=new Map,broadcastChannel=null,dbPromise=null;registerInstallations(global);exports.registerInstallations=registerInstallations}
//# sourceMappingURL=module$node_modules$$firebase$installations$dist$index_cjs.js.map
